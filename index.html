<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>È≠îÂ°îÂÇ≥Ë™™ - ÊãØÊïëÂÖ¨‰∏ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            display: flex;
            justify-content: center;
        }

        .game-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }

        /* ==================== MAIN MENU ==================== */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
        }

        .main-menu h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: #e94560;
            text-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
            margin-bottom: 10px;
        }

        .main-menu .subtitle {
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            color: #ffd700;
            margin-bottom: 30px;
        }

        .menu-story {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            max-width: 400px;
            border: 1px solid rgba(233, 69, 96, 0.3);
        }

        .menu-story p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #ccc;
            margin-bottom: 10px;
        }

        .menu-story p:last-child {
            margin-bottom: 0;
            color: #e94560;
            font-weight: bold;
        }

        .soul-display {
            background: rgba(147, 51, 234, 0.2);
            border: 1px solid #9333ea;
            padding: 10px 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .soul-display .soul-icon {
            font-size: 1.3rem;
        }

        .soul-display .soul-count {
            font-size: 1.2rem;
            color: #c084fc;
            font-weight: bold;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 250px;
        }

        .menu-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-btn:active {
            transform: scale(0.98);
        }

        .menu-btn.start {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            color: white;
        }

        .menu-btn.soul-shop {
            background: linear-gradient(135deg, #9333ea, #c084fc);
            color: white;
        }

        /* ==================== SOUL SHOP ==================== */
        .soul-shop-container {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 10px;
        }

        .soul-shop-header {
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid #9333ea;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .soul-shop-header h2 {
            font-size: 1.5rem;
            color: #c084fc;
            margin-bottom: 8px;
        }

        .soul-shop-items {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        .soul-upgrade {
            background: rgba(147, 51, 234, 0.15);
            border: 1px solid rgba(147, 51, 234, 0.4);
            padding: 12px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .soul-upgrade.maxed {
            opacity: 0.6;
            border-color: #4ecdc4;
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-weight: bold;
            color: #c084fc;
            margin-bottom: 4px;
        }

        .upgrade-desc {
            font-size: 0.8rem;
            color: #aaa;
        }

        .upgrade-level {
            font-size: 0.75rem;
            color: #ffd700;
            margin-top: 4px;
        }

        .upgrade-cost {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-cost:active:not(.disabled) {
            background: rgba(147, 51, 234, 0.4);
        }

        .upgrade-cost.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upgrade-cost.maxed {
            background: rgba(78, 205, 196, 0.3);
            cursor: default;
        }

        /* ==================== GAME SCREEN ==================== */
        .game-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* 1. Title/Header */
        .game-header {
            text-align: center;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #e94560;
            flex-shrink: 0;
        }

        .game-header h1 {
            font-size: 1rem;
            color: #e94560;
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
            margin-bottom: 2px;
        }

        .floor-display {
            font-size: 0.8rem;
            color: #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .floor-display .area-icon {
            font-size: 1rem;
        }

        .floor-display .area-name {
            color: #c084fc;
            font-weight: bold;
        }

        /* 2. Event Panel */
        .event-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 0;
        }

        .event-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .event-icon {
            font-size: 1.5rem;
        }

        .event-title {
            font-size: 1rem;
            color: #e94560;
            font-weight: bold;
        }

        .event-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
            min-height: 0;
        }

        .event-description {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #ccc;
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        /* 3. HP Bar */
        .hp-section {
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .hp-bar-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 3px;
        }

        .hp-bar {
            height: 22px;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            border-radius: 6px;
            transition: width 0.3s ease;
            position: relative;
        }

        .hp-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 22px;
            font-weight: bold;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 4. Stats Panel - Original 2x2 Layout */
        .stats-panel {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .stats-left {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            flex: 1;
        }

        .stat-box {
            text-align: center;
            padding: 6px 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .stat-box .stat-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .stat-icon {
            font-size: 0.85rem;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: clamp(0.8rem, 2.2vw, 1rem);
            font-weight: bold;
            color: #fff;
        }

        .stat-box.attack .stat-value { color: #ff6b35; }
        .stat-box.defense .stat-value { color: #4ecdc4; }
        .stat-box.dodge .stat-value { color: #a8e6cf; }
        .stat-box.crit .stat-value { color: #f39c12; }

        .stats-right {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 110px;
        }

        .gold-box {
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .gold-box .gold-icon {
            font-size: 1rem;
        }

        .gold-box .gold-value {
            font-size: 0.95rem;
            font-weight: bold;
            color: #ffd700;
        }

        .buffs-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 8px;
            border-radius: 6px;
            flex: 1;
            overflow-y: auto;
            max-height: 50px;
        }

        .buffs-box .buff {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.55rem;
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin: 1px;
        }

        .buffs-box .buff.positive {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
            color: #4ecdc4;
        }

        .buffs-box .buff.negative {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid #e94560;
            color: #e94560;
        }

        .buffs-box .buff.soul {
            background: rgba(147, 51, 234, 0.2);
            border: 1px solid #9333ea;
            color: #c084fc;
        }

        .no-buffs {
            font-size: 0.6rem;
            color: #555;
            text-align: center;
        }

        /* 5. Potions Panel */
        .potions-panel {
            display: flex;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .potions-label {
            font-size: 0.7rem;
            color: #888;
            margin-right: 4px;
        }

        .potion-slot {
            background: rgba(78, 205, 196, 0.15);
            border: 1px solid rgba(78, 205, 196, 0.4);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .potion-slot:active {
            background: rgba(78, 205, 196, 0.4);
            transform: scale(0.98);
        }

        .potion-slot .potion-name {
            color: #4ecdc4;
            font-size: 0.7rem;
        }

        .potion-slot .potion-count {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        .potion-slot .potion-heal {
            font-size: 0.6rem;
            color: #aaa;
        }

        .no-potions {
            font-size: 0.7rem;
            color: #555;
        }

        /* 6. Bottom Tabs */
        .bottom-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 5px;
            text-align: center;
            font-size: 0.7rem;
            color: #888;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .tab-btn:active {
            background: rgba(233, 69, 96, 0.1);
        }

        .tab-btn.active {
            color: #e94560;
            background: rgba(233, 69, 96, 0.15);
            border-top: 2px solid #e94560;
        }

        .tab-btn .tab-icon {
            font-size: 1.2rem;
        }

        .tab-btn .tab-label {
            font-size: 0.65rem;
        }

        /* Tab Panels */
        .tab-panel {
            display: none;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.4);
            max-height: 40vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .tab-panel.active {
            display: flex;
        }

        /* Equipment Tab Panel - Combined */
        .equipment-tab-content {
            padding: 10px 12px;
        }

        .equipment-tab-content h4 {
            font-size: 0.75rem;
            color: #e94560;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .equipment-wearing-section {
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .equipment-slots-horizontal {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .equipment-slot-h {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 6px;
            border-radius: 6px;
            border-left: 3px solid #444;
            text-align: center;
        }

        .equipment-slot-h.common { border-left-color: #888; }
        .equipment-slot-h.uncommon { border-left-color: #4ecdc4; }
        .equipment-slot-h.rare { border-left-color: #667eea; }
        .equipment-slot-h.epic { border-left-color: #a855f7; }
        .equipment-slot-h.legendary { border-left-color: #ffd700; }

        .equipment-slot-h .slot-type {
            font-size: 0.6rem;
            color: #666;
            margin-bottom: 2px;
        }

        .equipment-slot-h .slot-name {
            font-weight: bold;
            font-size: 0.75rem;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .equipment-slot-h .slot-name.common { color: #888; }
        .equipment-slot-h .slot-name.uncommon { color: #4ecdc4; }
        .equipment-slot-h .slot-name.rare { color: #667eea; }
        .equipment-slot-h .slot-name.epic { color: #a855f7; }
        .equipment-slot-h .slot-name.legendary { color: #ffd700; }

        .equipment-slot-h .slot-stats {
            font-size: 0.55rem;
            color: #aaa;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px;
        }

        /* Bag Grid - 3 columns */
        .bag-section h4 {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 8px;
        }

        .bag-grid-3col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .bag-slot {
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 6px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .bag-slot:active {
            background: rgba(233, 69, 96, 0.2);
            border-color: #e94560;
        }

        .bag-slot.empty {
            border-style: dashed;
            opacity: 0.5;
        }

        .bag-slot.common { border-left: 3px solid #888; }
        .bag-slot.uncommon { border-left: 3px solid #4ecdc4; }
        .bag-slot.rare { border-left: 3px solid #667eea; }
        .bag-slot.epic { border-left: 3px solid #a855f7; }
        .bag-slot.legendary { border-left: 3px solid #ffd700; animation: legendaryGlow 2s ease-in-out infinite; }

        .bag-slot .item-type {
            font-size: 0.55rem;
            color: #666;
            margin-bottom: 2px;
        }

        .bag-slot .item-name {
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .bag-slot .item-name.common { color: #888; }
        .bag-slot .item-name.uncommon { color: #4ecdc4; }
        .bag-slot .item-name.rare { color: #667eea; }
        .bag-slot .item-name.epic { color: #a855f7; }
        .bag-slot .item-name.legendary { color: #ffd700; }

        .bag-slot .item-stats {
            font-size: 0.5rem;
            color: #888;
            margin-top: 2px;
        }

        .bag-slot.empty .empty-text {
            font-size: 0.6rem;
            color: #444;
        }

        /* Materials Tab */
        .materials-tab-content {
            padding: 10px 12px;
        }

        .materials-tab-content h4 {
            font-size: 0.75rem;
            color: #e94560;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .materials-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .material-item {
            background: rgba(139, 69, 19, 0.2);
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border-left: 2px solid #8b4513;
        }

        .material-item.common { border-left-color: #888; }
        .material-item.uncommon { border-left-color: #4ecdc4; }
        .material-item.rare { border-left-color: #667eea; }
        .material-item.epic { border-left-color: #a855f7; }
        .material-item.legendary { border-left-color: #ffd700; animation: legendaryGlow 2s ease-in-out infinite; }

        .material-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        .empty-materials {
            color: #555;
            font-size: 0.75rem;
            text-align: center;
            padding: 20px;
        }

        @keyframes legendaryGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
        }

        /* ==================== BATTLE ARENA ==================== */
        .battle-arena {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .combatant {
            text-align: center;
        }

        .combatant-sprite {
            font-size: 3.5rem;
            animation: combatantIdle 1.5s ease-in-out infinite;
        }

        @keyframes combatantIdle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .combatant-name {
            font-weight: bold;
            font-size: 1rem;
            margin: 4px 0;
        }

        .combatant-name.normal { color: #888; }
        .combatant-name.elite { color: #667eea; }
        .combatant-name.boss { color: #ffd700; }

        .combatant-hp-bar {
            width: 160px;
            height: 14px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 7px;
            overflow: hidden;
            margin: 4px auto;
        }

        .combatant-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            transition: width 0.3s ease;
        }

        .combatant-hp-text {
            font-size: 0.75rem;
            color: #aaa;
        }

        .combatant-stats {
            font-size: 0.7rem;
            color: #888;
            margin-top: 2px;
        }

        /* Battle Log */
        .battle-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
        }

        .battle-log-entry {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 3px 0;
            font-size: 0.8rem;
        }

        .battle-log-entry.player-attack { color: #4ecdc4; }
        .battle-log-entry.player-crit { color: #f39c12; }
        .battle-log-entry.monster-attack { color: #e94560; }
        .battle-log-entry.dodge { color: #a8e6cf; }
        .battle-log-entry.heal { color: #4ecdc4; }

        .damage-number {
            font-weight: bold;
            font-size: 0.95rem;
        }

        /* ==================== DIALOG BOX ==================== */
        .dialog-box {
            background: rgba(0, 0, 0, 0.5);
            border-left: 3px solid #ffd700;
            padding: 10px 12px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
        }

        .dialog-speaker {
            color: #ffd700;
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .dialog-text {
            color: #ddd;
            font-size: 0.85rem;
            line-height: 1.4;
            font-style: italic;
        }

        /* ==================== TREASURE ==================== */
        .treasure-display {
            text-align: center;
            padding: 15px;
        }

        .treasure-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: treasureGlow 1.5s ease-in-out infinite;
        }

        @keyframes treasureGlow {
            0%, 100% { filter: drop-shadow(0 0 8px #ffd700); }
            50% { filter: drop-shadow(0 0 20px #ffd700); }
        }

        .chest-choice {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 12px;
        }

        .chest-option {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            flex: 1;
            max-width: 140px;
            transition: all 0.2s;
        }

        .chest-option:active {
            transform: scale(0.98);
        }

        .chest-option.safe { border-color: #4ecdc4; }
        .chest-option.risky { border-color: #e94560; }

        .chest-option .option-icon {
            font-size: 2.2rem;
            margin-bottom: 6px;
        }

        .chest-option .option-title {
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .chest-option.safe .option-title { color: #4ecdc4; }
        .chest-option.risky .option-title { color: #e94560; }

        .chest-option .option-desc {
            font-size: 0.65rem;
            color: #aaa;
        }

        /* Loot Display */
        .loot-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
        }

        .loot-title {
            font-size: 0.8rem;
            color: #ffd700;
            margin-bottom: 6px;
            text-align: center;
        }

        .loot-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .loot-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ==================== SHOP ==================== */
        .shop-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #444;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-item:active:not(.disabled) {
            background: rgba(233, 69, 96, 0.2);
        }

        .shop-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-item.potion-item { border-left-color: #4ecdc4; }
        .shop-item.common { border-left-color: #888; }
        .shop-item.uncommon { border-left-color: #4ecdc4; }
        .shop-item.rare { border-left-color: #667eea; }
        .shop-item.epic { border-left-color: #a855f7; }
        .shop-item.legendary { border-left-color: #ffd700; }

        .shop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            flex-wrap: wrap;
            gap: 4px;
        }

        .shop-item-name {
            font-weight: bold;
            font-size: 0.85rem;
        }

        .shop-item-name.potion { color: #4ecdc4; }

        .shop-item-price {
            color: #ffd700;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .shop-item-description {
            font-size: 0.7rem;
            color: #aaa;
        }

        .shop-item-rarity {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .shop-item-rarity.common { background: rgba(136, 136, 136, 0.3); color: #888; }
        .shop-item-rarity.uncommon { background: rgba(78, 205, 196, 0.3); color: #4ecdc4; }
        .shop-item-rarity.rare { background: rgba(102, 126, 234, 0.3); color: #667eea; }
        .shop-item-rarity.epic { background: rgba(168, 85, 247, 0.3); color: #a855f7; }
        .shop-item-rarity.legendary { background: rgba(255, 215, 0, 0.3); color: #ffd700; }

        .sell-all-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .sell-all-btn:active {
            transform: scale(0.98);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 12px 24px;
            font-size: 0.85rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:active:not(:disabled) {
            transform: scale(0.96);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffd700, #ff9500);
            color: #1a1a2e;
        }

        .btn-danger {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.75rem;
        }

        .flee-info {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.7);
            display: block;
            margin-top: 2px;
        }

        /* ==================== MODALS ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            max-width: 350px;
            width: 100%;
            border: 2px solid #e94560;
        }

        .modal-content h2 {
            font-size: 1.3rem;
            margin-bottom: 12px;
            color: #e94560;
        }

        .modal-content p {
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .final-stats {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }

        .final-stats div {
            padding: 3px 0;
        }

        .soul-reward {
            background: rgba(147, 51, 234, 0.3);
            border: 1px solid #9333ea;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .soul-reward-text {
            color: #c084fc;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* Equipment Compare Modal */
        .equip-compare-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
        }

        .equip-compare-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 12px;
            padding: 20px;
            max-width: 380px;
            width: 100%;
            border: 2px solid #e94560;
        }

        .equip-compare-title {
            text-align: center;
            font-size: 1.1rem;
            color: #e94560;
            margin-bottom: 15px;
        }

        .equip-compare-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .equip-card {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .equip-card.current {
            border: 2px solid #888;
        }

        .equip-card.new {
            border: 2px solid;
        }

        .equip-card.new.common { border-color: #888; }
        .equip-card.new.uncommon { border-color: #4ecdc4; }
        .equip-card.new.rare { border-color: #667eea; }
        .equip-card.new.epic { border-color: #a855f7; }
        .equip-card.new.legendary { border-color: #ffd700; }

        .equip-card-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 5px;
        }

        .equip-card-name {
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .equip-card-stats {
            font-size: 0.75rem;
            color: #aaa;
        }

        .equip-card-stats .stat-line {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .compare-arrow {
            font-size: 1.5rem;
            color: #ffd700;
        }

        .stat-change {
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .stat-change.positive { color: #4ecdc4; }
        .stat-change.negative { color: #e94560; }

        .equip-compare-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* ==================== OVERLAYS ==================== */
        .area-transition, .story-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .area-transition h2 {
            font-size: 1.8rem;
            color: #e94560;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
        }

        .area-transition .area-name {
            font-size: 1.3rem;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .area-transition .area-desc {
            font-size: 0.9rem;
            color: #aaa;
            text-align: center;
            max-width: 300px;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .area-transition .area-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .story-transition .story-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        .story-transition h2 {
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .story-transition .princess-display {
            text-align: center;
            margin: 20px 0;
        }

        .story-transition .princess-display .princess-sprite {
            font-size: 3.5rem;
            animation: princessFloat 2s ease-in-out infinite;
        }

        @keyframes princessFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .story-transition .story-info {
            color: #888;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        /* ==================== ANIMATIONS ==================== */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            75% { transform: translateX(6px); }
        }

        .attack-animation {
            animation: attackPulse 0.3s ease-out;
        }

        @keyframes attackPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .princess-sprite {
            font-size: 3rem;
        }

        /* ==================== SCROLLBAR ==================== */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: #e94560;
            border-radius: 2px;
        }

        .hidden {
            display: none !important;
        }

        /* Landscape adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .event-panel {
                min-height: 100px;
            }
            
            .combatant-sprite {
                font-size: 2.5rem;
            }
            
            .treasure-icon {
                font-size: 2rem;
            }
            
            .tab-panel {
                max-height: 35vh;
            }
            
            .stats-panel {
                padding: 4px 12px;
            }
            
            .stat-box {
                padding: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Main Menu -->
        <div class="main-menu" id="main-menu">
            <h1>üè∞ È≠îÂ°îÂÇ≥Ë™™ üè∞</h1>
            <div class="subtitle">‚ú® ÊãØÊïëÂÖ¨‰∏ª ‚ú®</div>
            
            <div class="menu-story">
                <p>Âú®ÈÅôÈÅ†ÁöÑÁéãÂúãÔºåÁæéÈ∫óÁöÑÊÑõËéâÁµ≤ÂÖ¨‰∏ªË¢´ÈÇ™ÊÉ°ÁöÑÈ≠îÁéãÊìÑËµ∞ÔºåÂõöÁ¶ÅÂú®È≠îÂ°îÁöÑÊúÄÈ†ÇÂ±§„ÄÇ</p>
                <p>Ë∫´ÁÇ∫ÁéãÂúãÊúÄÂãáÊï¢ÁöÑÈ®éÂ£´Ôºå‰Ω†Ë™ìË®ÄË¶ÅÊîÄÁôªÈÄôÂ∫ßÈ≠îÂ°îÔºåÁ©øË∂äÂçÅÂÄãÂç±Èö™ÂçÄÂüüÔºåÊìäÊïóÈ≠îÁéãÔºåÊãØÊïëÂÖ¨‰∏ªÔºÅ</p>
                <p>„ÄåÈ®éÂ£´Â§ß‰∫∫ÔºåË´ã‰∏ÄÂÆöË¶Å‰æÜÊïëÊàë...„Äç</p>
            </div>

            <div class="soul-display">
                <span class="soul-icon">üíé</span>
                <span>ÈùàÈ≠ÇÁ¢éÁâáÔºö</span>
                <span class="soul-count" id="menu-soul-count">0</span>
            </div>

            <div class="menu-buttons">
                <button class="menu-btn start" onclick="game.startNewRun()">‚öîÔ∏è ÈñãÂßãÂÜíÈö™</button>
                <button class="menu-btn soul-shop" onclick="game.openSoulShop()">üíé ÈùàÈ≠ÇÂïÜÂ∫ó</button>
            </div>
        </div>

        <!-- Soul Shop -->
        <div class="soul-shop-container" id="soul-shop">
            <div class="soul-shop-header">
                <h2>üíé ÈùàÈ≠ÇÂïÜÂ∫ó üíé</h2>
                <div class="soul-display" style="justify-content: center; margin-top: 10px;">
                    <span class="soul-icon">üíé</span>
                    <span>ÈùàÈ≠ÇÁ¢éÁâáÔºö</span>
                    <span class="soul-count" id="shop-soul-count">0</span>
                </div>
            </div>
            <div class="soul-shop-items" id="soul-shop-items"></div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="game.closeSoulShop()">ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen hidden" id="game-screen">
            <!-- 1. Title/Header -->
            <div class="game-header">
                <h1>üè∞ È≠îÂ°îÂÇ≥Ë™™ üè∞</h1>
                <div class="floor-display">
                    <span class="area-icon" id="floor-area-icon">‚õìÔ∏è</span>
                    <span class="area-name" id="floor-area-name">Âú∞‰∏ãÁõ£Áâ¢</span>
                    <span>Á¨¨ <span id="current-floor">1</span> Â±§</span>
                </div>
            </div>

            <!-- 2. Event Panel -->
            <div class="event-panel" id="event-panel"></div>

            <!-- 3. HP Bar -->
            <div class="hp-section">
                <div class="hp-bar-container">
                    <div class="hp-bar" id="hp-bar">
                        <span class="hp-bar-text" id="hp-bar-text">100 / 100</span>
                    </div>
                </div>
            </div>

            <!-- 4. Stats Panel - 2x2 Matrix with Gold and Buffs -->
            <div class="stats-panel">
                <div class="stats-left">
                    <div class="stat-box attack">
                        <div class="stat-row">
                            <span class="stat-icon">‚öîÔ∏è</span>
                            <span class="stat-value" id="stat-attack">10</span>
                        </div>
                        <div class="stat-label">ÊîªÊìä</div>
                    </div>
                    <div class="stat-box defense">
                        <div class="stat-row">
                            <span class="stat-icon">üõ°Ô∏è</span>
                            <span class="stat-value" id="stat-defense">5</span>
                        </div>
                        <div class="stat-label">Èò≤Á¶¶</div>
                    </div>
                    <div class="stat-box crit">
                        <div class="stat-row">
                            <span class="stat-icon">üí•</span>
                            <span class="stat-value" id="stat-crit">5%</span>
                        </div>
                        <div class="stat-label">ÁàÜÊìä</div>
                    </div>
                    <div class="stat-box dodge">
                        <div class="stat-row">
                            <span class="stat-icon">üí®</span>
                            <span class="stat-value" id="stat-dodge">5%</span>
                        </div>
                        <div class="stat-label">ÈñÉÈÅø</div>
                    </div>
                </div>
                <div class="stats-right">
                    <div class="gold-box">
                        <span class="gold-icon">üí∞</span>
                        <span class="gold-value" id="stat-gold">0</span>
                    </div>
                    <div class="buffs-box" id="buffs-panel">
                        <div class="no-buffs">ÁÑ°Â¢ûÁõäÊïàÊûú</div>
                    </div>
                </div>
            </div>

            <!-- 5. Potions -->
            <div class="potions-panel" id="potions-panel">
                <span class="potions-label">üíä Ëó•Ê∞¥:</span>
            </div>

            <!-- 6. Bottom Tabs -->
            <div class="bottom-tabs">
                <button class="tab-btn" onclick="game.toggleTab('equipment')" id="tab-equipment">
                    <span class="tab-icon">‚öîÔ∏è</span>
                    <span class="tab-label">Ë£ùÂÇô (<span id="equip-bag-count">0</span>/20)</span>
                </button>
                <button class="tab-btn" onclick="game.toggleTab('materials')" id="tab-materials">
                    <span class="tab-icon">üì¶</span>
                    <span class="tab-label">Á¥†Êùê</span>
                </button>
            </div>

            <!-- Equipment Tab Panel (Combined: Wearing + Bag) -->
            <div class="tab-panel" id="panel-equipment">
                <div class="equipment-tab-content">
                    <!-- Wearing Section -->
                    <div class="equipment-wearing-section">
                        <h4>üéñÔ∏è Ë£ùÂÇô‰∏≠</h4>
                        <div class="equipment-slots-horizontal" id="equipment-slots"></div>
                    </div>
                    
                    <!-- Bag Section - 3 Column Grid -->
                    <div class="bag-section">
                        <h4>üéí Ë£ùÂÇôËÉåÂåÖ</h4>
                        <div class="bag-grid-3col" id="equip-bag-grid"></div>
                    </div>
                </div>
            </div>

            <!-- Materials Tab Panel -->
            <div class="tab-panel" id="panel-materials">
                <div class="materials-tab-content">
                    <h4>üì¶ Á¥†ÊùêËÉåÂåÖ</h4>
                    <div class="materials-grid" id="material-bag-items"></div>
                </div>
            </div>
        </div>
    
    <!-- Game Over Modal -->
    <div class="modal" id="game-over-modal">
        <div class="modal-content">
            <h2 id="modal-title">ÈÅäÊà≤ÁµêÊùü</h2>
            <p id="modal-message">‰Ω†Âú®Êà∞È¨•‰∏≠ÂÄí‰∏ã‰∫Ü...</p>
            <div class="soul-reward" id="soul-reward">
                <div class="soul-reward-text">üíé Áç≤ÂæóÈùàÈ≠ÇÁ¢éÁâáÔºö<span id="soul-gained">0</span></div>
            </div>
            <div class="final-stats" id="final-stats"></div>
            <button class="btn btn-primary" onclick="game.returnToMenu()">ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
        </div>
    </div>
    
    <!-- Area Transition Overlay -->
    <div class="area-transition hidden" id="area-transition">
        <div class="area-icon" id="area-icon">üè∞</div>
        <h2 id="area-transition-title">ÈÄ≤ÂÖ•Á¨¨1ÂçÄÂüü</h2>
        <div class="area-name" id="area-name">Âú∞‰∏ãÁõ£Áâ¢</div>
        <div class="area-desc" id="area-desc">Èô∞ÊöóÊΩÆÊøïÁöÑÁõ£Áâ¢ÔºåÈóúÊäºËëóË¢´ÈÅ∫ÂøòÁöÑÈùàÈ≠Ç...</div>
        <button class="btn btn-primary" onclick="game.closeAreaTransition()">ÁπºÁ∫åÂâçÈÄ≤</button>
    </div>

    <!-- Story Transition Overlay -->
    <div class="story-transition hidden" id="story-transition">
        <div class="story-icon" id="story-icon">üëë</div>
        <h2 id="story-title">ÁéãÂüéÂ§ßÊÆø</h2>
        <div class="dialog-box">
            <div class="dialog-speaker" id="story-speaker">ËÄÅÂúãÁéã</div>
            <div class="dialog-text" id="story-text">ÂãáÊï¢ÁöÑÈ®éÂ£´Âïä...</div>
        </div>
        <div class="princess-display">
            <div class="princess-sprite">üë∏</div>
            <p style="color: #ffd700;">ÂÖ¨‰∏ªÂú®È≠îÂ°îÈ†ÇÂ±§Á≠âÂæÖÊïëÊè¥...</p>
        </div>
        <div class="story-info">Á©øË∂ä10ÂÄãÂçÄÂüüÔºå500Â±§È≠îÂ°î</div>
        <button class="btn btn-primary" onclick="game.closeStoryTransition()">Ë∏èÂÖ•È≠îÂ°î</button>
    </div>

    <!-- Equipment Compare Modal -->
    <div class="equip-compare-modal hidden" id="equip-compare-modal">
        <div class="equip-compare-content">
            <div class="equip-compare-title">üîÑ Êõ¥ÊèõË£ùÂÇô</div>
            <div class="equip-compare-container" id="equip-compare-container"></div>
            <div class="equip-compare-buttons">
                <button class="btn btn-primary btn-small" id="equip-confirm-btn">Ë£ùÂÇô</button>
                <button class="btn btn-danger btn-small" id="equip-discard-btn">‰∏üÊ£Ñ</button>
                <button class="btn btn-secondary btn-small" onclick="game.closeEquipCompare()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== PERSISTENT DATA ====================
        const SAVE_KEY = 'magicTower_soulData_v2';
        const GAME_VERSION = '0.5c';

        function getNewSoulData() {
            return {
                version: GAME_VERSION, 
                souls: 0,
                upgrades: {
                    vitality: 0,
                    strength: 0,
                    resilience: 0,
                    agility: 0,
                    precision: 0,
                    fortune: 0,
                    soulHarvest: 0,
                    potionMaster: 0,
                    startingGold: 0,
                    secondChance: 0
                },
                totalRuns: 0,
                bestFloor: 0,
                bossesKilled: 0
            };
        }

        function calculateTotalLifetimeSouls(oldData) {
            let total = oldData.souls || 0; // Start with currently held souls

            // Add up cost of every purchased upgrade
            if (oldData.upgrades) {
                Object.keys(oldData.upgrades).forEach(key => {
                    const level = oldData.upgrades[key];
                    const upgradeDef = SOUL_UPGRADES.find(u => u.id === key);
                    
                    if (upgradeDef && level > 0) {
                        // Sum cost for levels 0 to current_level-1
                        for (let i = 0; i < level; i++) {
                            total += Math.floor(upgradeDef.baseCost * Math.pow(upgradeDef.costMult, i));
                        }
                    }
                });
            }
            return total;
        }

        function loadSoulData() {
            const dataStr = localStorage.getItem(SAVE_KEY);
            
            // Default empty data if new player
            let data = dataStr ? JSON.parse(dataStr) : getNewSoulData();

            // --- VERSION CHECK & MIGRATION ---
            if (data.version !== GAME_VERSION) {
                console.log(`Version update detected: ${data.version || 'Unknown'} -> ${GAME_VERSION}`);
                
                // 1. Calculate Permanent Souls (Current + Spent on Upgrades)
                let totalVal = calculateTotalLifetimeSouls(data);

                // 2. [NEW] Check Active Run for Unbanked Souls
                const runStr = localStorage.getItem('magicTower_autoSave');
                if (runStr) {
                    try {
                        const runData = JSON.parse(runStr);
                        
                        // Add souls collected so far in this run
                        if (runData.soulGainedThisRun) {
                            totalVal += runData.soulGainedThisRun;
                        }
                        
                        // Add souls waiting in a loot box (if you just killed a mob but didn't collect yet)
                        if (runData.pendingLoot && runData.pendingLoot.souls) {
                            totalVal += runData.pendingLoot.souls;
                        }
                        
                        console.log(`Recovered unbanked souls from active run. New Total: ${totalVal}`);
                    } catch (e) {
                        console.error("Could not recover active run souls", e);
                    }
                }
                
                // 3. Calculate 50% Refund
                const refundAmount = Math.floor(totalVal * 0.5);
                
                // 4. Wipe Old Data
                localStorage.removeItem('magicTower_autoSave'); // Delete the run
                
                // 5. Create Fresh Soul Data with Refund
                const newData = getNewSoulData();
                newData.souls = refundAmount; 
                
                // 6. Save immediately
                saveSoulData(newData);

                // 7. Notify User
                alert(
                    `üéâ ÈÅäÊà≤ÁâàÊú¨Êõ¥Êñ∞Ëá≥ v${GAME_VERSION}ÔºÅ\n\n` +
                    `ÁÇ∫‰∫ÜÂπ≥Ë°°ÊÄßË™øÊï¥ÔºåÈÄ≤Â∫¶Â∑≤ÈáçÁΩÆ„ÄÇ\n` +
                    `\nüí∞ ÈùàÈ≠ÇË®àÁÆóÔºö\n` +
                    `ÂåÖÂê´ÊÇ®Ê≠£Âú®ÈÄ≤Ë°åÁöÑÂÜíÈö™ÔºåÁ∏ΩË≥áÁî¢ÁÇ∫ ${totalVal} ÈùàÈ≠Ç„ÄÇ\n` +
                    `Â∑≤ÁÇ∫ÊÇ®‰øùÁïô 50% (${refundAmount} ÈùàÈ≠Ç)ÔºÅ`
                );
                
                return newData;
            }
            // ---------------------------------

            return data;
        }

        function saveSoulData(data) {
            // Ensure the version is always the current one when saving
            data.version = GAME_VERSION; 
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        }

        const SOUL_UPGRADES = [
            { id: 'vitality', name: 'ÁîüÂëΩÂº∑Âåñ', desc: 'Ê∞∏‰πÖÂ¢ûÂä†ÊúÄÂ§ßÁîüÂëΩÂÄº', effect: '+10 ÁîüÂëΩ', maxLevel: 20, baseCost: 10, costMult: 1.5 },
            { id: 'strength', name: 'ÂäõÈáèÂº∑Âåñ', desc: 'Ê∞∏‰πÖÂ¢ûÂä†ÊîªÊìäÂäõ', effect: '+2 ÊîªÊìä', maxLevel: 10, baseCost: 15, costMult: 1.5 },
            { id: 'resilience', name: 'Â†ÖÈüåÂº∑Âåñ', desc: 'Ê∞∏‰πÖÂ¢ûÂä†Èò≤Á¶¶Âäõ', effect: '+2 Èò≤Á¶¶', maxLevel: 10, baseCost: 15, costMult: 1.5 },
            { id: 'agility', name: 'ÊïèÊç∑Âº∑Âåñ', desc: 'Ê∞∏‰πÖÂ¢ûÂä†ÈñÉÈÅøÁéá', effect: '+1% ÈñÉÈÅø', maxLevel: 5, baseCost: 15, costMult: 1.6 },
            { id: 'precision', name: 'Á≤æÊ∫ñÂº∑Âåñ', desc: 'Ê∞∏‰πÖÂ¢ûÂä†ÁàÜÊìäÁéá', effect: '+1% ÁàÜÊìä', maxLevel: 5, baseCost: 15, costMult: 1.6 },
            { id: 'fortune', name: 'Ë≤°ÈÅãÁ•ùÁ¶è', desc: 'Â¢ûÂä†ÈáëÂπ£Áç≤ÂèñÈáè', effect: '+5% ÈáëÂπ£', maxLevel: 10, baseCost: 20, costMult: 1.7 },
            { id: 'soulHarvest', name: 'ÈùàÈ≠ÇÊî∂Ââ≤', desc: 'Â¢ûÂä†ÈùàÈ≠ÇÁ¢éÁâáÁç≤Âèñ', effect: '+10% ÈùàÈ≠Ç', maxLevel: 10, baseCost: 25, costMult: 1.8 },
            { id: 'potionMaster', name: 'Ëó•ÂäëÂ§ßÂ∏´', desc: 'Â¢ûÂä†Ëó•Ê∞¥ÊïàÊûú', effect: '+10% ÊïàÊûú', maxLevel: 10, baseCost: 18, costMult: 1.6 },
            { id: 'startingGold', name: 'ÂàùÂßãË≥áÈáë', desc: 'ÊØèÊ¨°ÂÜíÈö™ÈñãÂßãÊôÇÁç≤ÂæóÈ°çÂ§ñÈáëÂπ£', effect: '+25 ÈáëÂπ£', maxLevel: 10, baseCost: 15, costMult: 1.5 },
            { id: 'secondChance', name: '‰∏çÊ≠ªÊ±∫ÂøÉ', desc: 'ÂèóÂà∞Ëá¥ÂëΩÂÇ∑ÂÆ≥ÊôÇÊúâÊ©üÊúÉÂ≠òÊ¥ª', effect: '+5% Ê©üÁéá', maxLevel: 10, baseCost: 30, costMult: 2.0 }
        ];

        // ==================== GAME DATA ====================
        
        const AREA_NAMES_CN = ['', 'Á¨¨‰∏ÄÂçÄ', 'Á¨¨‰∫åÂçÄ', 'Á¨¨‰∏âÂçÄ', 'Á¨¨ÂõõÂçÄ', 'Á¨¨‰∫îÂçÄ', 'Á¨¨ÂÖ≠ÂçÄ', 'Á¨¨‰∏ÉÂçÄ', 'Á¨¨ÂÖ´ÂçÄ', 'Á¨¨‰πùÂçÄ', 'Á¨¨ÂçÅÂçÄ'];
        
        const AREAS = [
            { id: 1, name: 'Âú∞‰∏ãÁõ£Áâ¢', icon: '‚õìÔ∏è', desc: 'Èô∞ÊöóÊΩÆÊøïÁöÑÁõ£Áâ¢ÔºåÈóúÊäºËëóË¢´ÈÅ∫ÂøòÁöÑÈùàÈ≠Ç...', startFloor: 1 },
            { id: 2, name: 'Èô∞ÊöóÊ¥ûÁ™ü', icon: 'üï≥Ô∏è', desc: 'ËúøËúíÊõ≤ÊäòÁöÑÊ¥ûÁ©¥ÔºåËø¥Áõ™Ëëó‰∏çÁ••ÁöÑËÅ≤Èüø...', startFloor: 51 },
            { id: 3, name: 'È™∑È´èÂ¢ìÂú∞', icon: 'üíÄ', desc: '‰∫°ÈùàÈÅäËï©ÁöÑÁ¶ÅÂú∞ÔºåÁ©∫Ê∞£‰∏≠ÁÄ∞Êº´ËëóÊ≠ª‰∫°ÁöÑÊ∞£ÊÅØ...', startFloor: 101 },
            { id: 4, name: 'ÂπΩÊöóÊ£ÆÊûó', icon: 'üå≤', desc: 'Ê∞∏Â§úÁ±†ÁΩ©ÁöÑÊ£ÆÊûóÔºåÊ®πÊú®‰πãÈñìÊΩõ‰ºèËëóÂç±Èö™...', startFloor: 151 },
            { id: 5, name: 'È≠îÊ≥ïÂØ¶È©óÂÆ§', icon: 'üß™', desc: 'ÁòãÁãÇÊ≥ïÂ∏´ÁöÑÂØ¶È©óÂ†¥ÔºåÂà∞ËôïÈÉΩÊòØÂ§±ÊïóÁöÑÈÄ†Áâ©...', startFloor: 201 },
            { id: 6, name: 'ÊÉ°È≠îÊÆøÂ†Ç', icon: 'üëø', desc: 'ÊÉ°È≠îËÅöÈõÜÁöÑÂ§ßÂª≥ÔºåÈÇ™ÊÉ°ÁöÑÂäõÈáèÂú®Ê≠§ÂåØËÅö...', startFloor: 251 },
            { id: 7, name: 'ÂÜ∞ÈúúËµ∞Âªä', icon: '‚ùÑÔ∏è', desc: 'ÂØíÂÜ∑Âà∫È™®ÁöÑÈÄöÈÅìÔºåÂáçÁµêÁöÑÂ±çÈ´îÈö®ËôïÂèØË¶ã...', startFloor: 301 },
            { id: 8, name: 'ÁÉàÁÑ∞ÈÄöÈÅì', icon: 'üî•', desc: 'ÁÜîÂ≤©ÊµÅÊ∑åÁöÑÂú∞ÁçÑÔºåÈ´òÊ∫´Ë∂≥‰ª•ËûçÂåñ‰∏ÄÂàá...', startFloor: 351 },
            { id: 9, name: 'ËôõÁ©∫Ë£ÇÈöô', icon: 'üåÄ', desc: 'Á©∫ÈñìÊâ≠Êõ≤ÁöÑÁï∞ÁïåÔºåÁèæÂØ¶ÁöÑÊ≥ïÂâáÂú®Ê≠§Â§±Êïà...', startFloor: 401 },
            { id: 10, name: 'È≠îÁéãÂØ∂Â∫ß', icon: 'üëë', desc: 'È≠îÁéãÁöÑÁéãÂ∫ß‰πãÈñìÔºåÂÖ¨‰∏ªÂ∞±Âú®ÈÄôË£°Á≠âÂæÖÊïëÊè¥ÔºÅ', startFloor: 451 }
        ];

        const STORY_DIALOGUES = {
            start: {
                speaker: 'ËÄÅÂúãÁéã',
                text: 'ÂãáÊï¢ÁöÑÈ®éÂ£´ÂïäÔºåÊàëÁöÑÂ•≥ÂÖíË¢´È≠îÁéãÊäìËµ∞‰∫Ü„ÄÇË´ã‰Ω†‰∏ÄÂÆöË¶ÅÊïëÂõûÂ•πÔºÅÈÄôÊääÂäçÊòØÂÖàÁéãÁïô‰∏ãÁöÑÂØ∂Áâ©ÔºåÂ∏åÊúõËÉΩÂä©‰Ω†‰∏ÄËáÇ‰πãÂäõ„ÄÇ'
            },
            area2: {
                speaker: 'Á•ûÁßòÂπΩÈùà',
                text: 'Ê¥ª‰∫∫ÔºüÂú®ÈÄôÈ≠îÂ°î‰∏≠ÈÇÑËÉΩË¶ãÂà∞Ê¥ª‰∫∫...‰Ω†ÊòØ‰æÜÊïëÈÇ£‰ΩçÂÖ¨‰∏ªÁöÑÂêßÔºüÂ∞èÂøÉÔºåË∂äÂæÄ‰∏äËµ∞ÔºåÈ≠îÁâ©Ë∂äÂº∑Â§ß...'
            },
            area3: {
                speaker: 'Ë¢´ÂõöÁ¶ÅÁöÑÂ£´ÂÖµ',
                text: 'Âí≥Âí≥...È®éÂ£´Â§ß‰∫∫ÔºüÊàëÊòØÂÖàÈÅ£ÈöäÁöÑÂÄñÂ≠òËÄÖ...ÂÖ∂‰ªñ‰∫∫ÈÉΩ...ÂÖ¨‰∏ªÊáâË©≤Ë¢´ÈóúÂú®ÊúÄÈ†ÇÂ±§ÔºåÈ≠îÁéãÂæàÂº∑ÔºåË´ãÂãôÂøÖÂ∞èÂøÉÔºÅ'
            },
            area5: {
                speaker: 'ÊÑõËéâÁµ≤ÂÖ¨‰∏ªÔºàÈÅ†ËôïÁöÑËÅ≤Èü≥Ôºâ',
                text: 'Êúâ‰∫∫Âú®ÂóéÔºüË´ãÊïëÊïëÊàë...ÊàëËÉΩÊÑüË¶∫Âà∞Êúâ‰∫∫Âú®Êé•Ëøë...ÊòØÈ®éÂ£´Â§ß‰∫∫ÂóéÔºüË´ãÂø´‰æÜÊïëÊàëÔºÅ'
            },
            area7: {
                speaker: 'È≠îÁéãÁöÑÂΩ±Â≠ê',
                text: 'ÂìºÂìºÂìº...Âèà‰∏ÄÂÄã‰∏çËá™ÈáèÂäõÁöÑ‰∫∫È°û„ÄÇ‰Ω†‰ª•ÁÇ∫ËÉΩÊïëËµ∞ÂÖ¨‰∏ªÔºüÊàëÂú®È†ÇÂ±§Á≠âËëó‰Ω†Ôºå‰æÜÈÄÅÊ≠ªÂêßÔºÅ'
            },
            area9: {
                speaker: 'ÊÑõËéâÁµ≤ÂÖ¨‰∏ª',
                text: 'È®éÂ£´Â§ß‰∫∫ÔºÅ‰Ω†ÁúüÁöÑ‰æÜ‰∫ÜÔºÅÈ≠îÁéãÂ∞±Âú®‰∏äÈù¢...‰ªñÂæàÂº∑Â§ßÔºå‰ΩÜÊàëÁõ∏‰ø°‰Ω†‰∏ÄÂÆöËÉΩÊâìÊïó‰ªñÔºÅ'
            },
            bossDefeat: {
                speaker: 'ÊÑõËéâÁµ≤ÂÖ¨‰∏ª',
                text: 'Â§™Â•Ω‰∫ÜÔºÅ‰Ω†ÊâìÊïó‰ªñ‰∫ÜÔºÅË¨ùË¨ù‰Ω†ÔºåÂãáÊï¢ÁöÑÈ®éÂ£´...ËÆìÊàëÂÄë‰∏ÄËµ∑ÂõûÂÆ∂ÂêßÔºÅ'
            }
        };

        const MATERIALS = {
    // Area 1
    slime_gel: { name: 'Âè≤ËêäÂßÜÂáùËÜ†', emoji: 'üü¢', basePrice: 5, rarity: 'common' },
    rat_tail: { name: 'ËÄÅÈº†Â∞æÂ∑¥', emoji: 'üêÅ', basePrice: 6, rarity: 'common' },
    bat_fang: { name: 'ËùôËù†Â∞ñÁâô', emoji: 'ü¶∑', basePrice: 7, rarity: 'common' },
    
    // Area 2
    spider_leg: { name: 'ËúòËõõÊñ∑ËÖø', emoji: 'ü¶µ', basePrice: 12, rarity: 'common' },
    goblin_ear: { name: 'Âì•Â∏ÉÊûóËÄ≥Êúµ', emoji: 'üëÇ', basePrice: 15, rarity: 'common' },
    cave_bat_wing: { name: 'Ê¥ûÁ©¥ËùôËù†Áøº', emoji: 'ü¶á', basePrice: 14, rarity: 'common' },
    
    // Area 3
    rib_bone: { name: 'ËÖêÊúΩËÇãÈ™®', emoji: 'ü¶¥', basePrice: 25, rarity: 'uncommon' },
    zombie_flesh: { name: 'ÊÑüÊüìËÖêËÇâ', emoji: 'üßü', basePrice: 28, rarity: 'uncommon' },
    ectoplasm: { name: 'ÂπΩÈùàÈùàË≥™', emoji: 'üëª', basePrice: 35, rarity: 'uncommon' },
    
    // Area 4
    wolf_pelt: { name: 'Áãº‰∫∫ÊØõÁöÆ', emoji: 'üê∫', basePrice: 45, rarity: 'uncommon' },
    dryad_branch: { name: 'Ê®πÂ¶ñÊûØÊûù', emoji: 'üçÇ', basePrice: 50, rarity: 'uncommon' },
    poison_gland: { name: 'ÂäáÊØíÂõäËÖ∫', emoji: 'üß™', basePrice: 48, rarity: 'uncommon' },
    
    // Area 5
    stone_heart: { name: 'Áü≥ÂÉèÈ¨º‰πãÂøÉ', emoji: 'üóø', basePrice: 70, rarity: 'rare' },
    puppet_gear: { name: 'È≠îÂÅ∂ÈΩíËº™', emoji: '‚öôÔ∏è', basePrice: 75, rarity: 'rare' },
    mutant_fluid: { name: 'Á™ÅËÆäÈ´îÊ∂≤', emoji: 'ü¶†', basePrice: 80, rarity: 'rare' },
    
    // Area 6
    imp_horn: { name: 'Â∞èÊÉ°È≠îËßí', emoji: 'üòà', basePrice: 100, rarity: 'rare' },
    hellhound_ash: { name: 'Âú∞ÁçÑÁä¨ÁÅ∞Ááº', emoji: 'üêï', basePrice: 110, rarity: 'rare' },
    black_feather: { name: 'Â¢ÆËêΩÈªëÁæΩ', emoji: 'ü™∂', basePrice: 120, rarity: 'rare' },
    
    // Area 7
    frost_core: { name: 'Ê∞∏ÂáçÊ†∏ÂøÉ', emoji: '‚ùÑÔ∏è', basePrice: 150, rarity: 'rare' },
    wraith_dust: { name: 'ÂÜ§È≠ÇÂ°µÂüÉ', emoji: 'üå™Ô∏è', basePrice: 160, rarity: 'rare' },
    ice_wolf_claw: { name: 'ÂÜ∞ÁãºÂà©Áà™', emoji: 'üêæ', basePrice: 155, rarity: 'rare' },
    
    // Area 8
    ember_spark: { name: '‰∏çÊªÖÁÅ´Á®Æ', emoji: 'üî•', basePrice: 200, rarity: 'epic' },
    magma_rock: { name: 'ÁÜîÂ≤©ÂáùÂ°ä', emoji: 'üåã', basePrice: 220, rarity: 'epic' },
    salamander_scale: { name: 'ÁÅ´Ëú•Ëú¥È±ó', emoji: 'ü¶é', basePrice: 210, rarity: 'epic' },
    
    // Area 9
    void_dust: { name: 'ËôõÁ©∫ÊòüÂ°µ', emoji: '‚ú®', basePrice: 280, rarity: 'epic' },
    alien_eye: { name: 'Áï∞ÁïåÁúºÁêÉ', emoji: 'üëÅÔ∏è', basePrice: 300, rarity: 'epic' },
    chaos_shard: { name: 'Ê∑∑Ê≤åÁ¢éÁâá', emoji: 'üåÄ', basePrice: 320, rarity: 'epic' },
    
    // Area 10
    guard_badge: { name: 'ËøëË°õÂã≥Á´†', emoji: 'üéñÔ∏è', basePrice: 400, rarity: 'epic' },
    dragon_scale: { name: 'ÈªëÈæçÈÄÜÈ±ó', emoji: 'üêâ', basePrice: 500, rarity: 'legendary' },
    dark_metal: { name: 'Ê≠ª‰∫°ÈáëÂ±¨', emoji: '‚õìÔ∏è', basePrice: 450, rarity: 'epic' },

    // Bosses - ‚úÖ All boss materials are legendary!
    boss_1: { name: 'ÁúãÂÆàÈë∞Âåô', emoji: 'üóùÔ∏è', basePrice: 100, rarity: 'rare' },
    boss_2: { name: 'ËõõÂêéÊØíÁâô', emoji: 'üï∑Ô∏è', basePrice: 150, rarity: 'rare' },
    boss_3: { name: 'È†ò‰∏ªÈ†≠È™®', emoji: 'üíÄ', basePrice: 250, rarity: 'rare' },
    boss_4: { name: 'Ê£ÆÊûó‰πãÂøÉ', emoji: 'üíö', basePrice: 350, rarity: 'epic' },
    boss_5: { name: 'Ë≥¢ËÄÖ‰πãÁü≥', emoji: 'üíé', basePrice: 500, rarity: 'epic' },
    boss_6: { name: 'ÊÉ°È≠î‰πãË°Ä', emoji: 'üç∑', basePrice: 650, rarity: 'epic' },
    boss_7: { name: 'ÂÜ∞ÈúúÁöáÂÜ†', emoji: 'üëë', basePrice: 850, rarity: 'legendary' },
    boss_8: { name: 'ÁÇéÈ≠îÊ†∏ÂøÉ', emoji: 'üåû', basePrice: 1100, rarity: 'legendary' },
    boss_9: { name: 'ËôõÁ©∫Ê∞¥Êô∂', emoji: 'üîÆ', basePrice: 1500, rarity: 'legendary' },
    boss_10: { name: 'È≠îÁéãÈùàÈ≠Ç', emoji: 'üëπ', basePrice: 5000, rarity: 'legendary' }
};

        const MONSTERS_BY_AREA = {
            1: [
                { name: 'Âè≤ËêäÂßÜ', emoji: 'üü¢', baseHp: 30, baseAtk: 8, baseDef: 2, goldMin: 5, goldMax: 12, material: 'slime_gel', matChance: 0.4 },
                { name: 'ËÄÅÈº†', emoji: 'üêÄ', baseHp: 25, baseAtk: 10, baseDef: 1, goldMin: 4, goldMax: 10, material: 'rat_tail', matChance: 0.35 },
                { name: 'ËùôËù†', emoji: 'ü¶á', baseHp: 22, baseAtk: 12, baseDef: 1, goldMin: 5, goldMax: 11, material: 'bat_fang', matChance: 0.35 },
            ],
            2: [
                { name: 'ËúòËõõ', emoji: 'üï∑Ô∏è', baseHp: 40, baseAtk: 15, baseDef: 4, goldMin: 8, goldMax: 18, material: 'spider_leg', matChance: 0.4 },
                { name: 'Âì•Â∏ÉÊûó', emoji: 'üë∫', baseHp: 50, baseAtk: 18, baseDef: 5, goldMin: 10, goldMax: 22, material: 'goblin_ear', matChance: 0.45 },
                { name: 'Ê¥ûÁ©¥ËùôËù†', emoji: 'ü¶á', baseHp: 35, baseAtk: 20, baseDef: 3, goldMin: 9, goldMax: 20, material: 'cave_bat_wing', matChance: 0.35 },
            ],
            3: [
                { name: 'È™∑È´è', emoji: 'üíÄ', baseHp: 60, baseAtk: 22, baseDef: 8, goldMin: 15, goldMax: 30, material: 'rib_bone', matChance: 0.4 },
                { name: 'ÊÆ≠Â±ç', emoji: 'üßü', baseHp: 80, baseAtk: 20, baseDef: 10, goldMin: 18, goldMax: 35, material: 'zombie_flesh', matChance: 0.35 },
                { name: 'ÂπΩÈùà', emoji: 'üëª', baseHp: 50, baseAtk: 28, baseDef: 5, goldMin: 20, goldMax: 40, material: 'ectoplasm', matChance: 0.3 },
            ],
            4: [
                { name: 'Áãº‰∫∫', emoji: 'üê∫', baseHp: 90, baseAtk: 30, baseDef: 12, goldMin: 25, goldMax: 45, material: 'wolf_pelt', matChance: 0.4 },
                { name: 'Ê®πÂ¶ñ', emoji: 'üå≥', baseHp: 120, baseAtk: 25, baseDef: 18, goldMin: 28, goldMax: 50, material: 'dryad_branch', matChance: 0.35 },
                { name: 'ÊØíËúòËõõ', emoji: 'üï∑Ô∏è', baseHp: 70, baseAtk: 35, baseDef: 8, goldMin: 22, goldMax: 42, material: 'poison_gland', matChance: 0.4 },
            ],
            5: [
                { name: 'Áü≥ÂÉèÈ¨º', emoji: 'üóø', baseHp: 200, baseAtk: 45, baseDef: 25, goldMin: 40, goldMax: 65, material: 'stone_heart', matChance: 0.35 },
                { name: 'È≠îÂÅ∂', emoji: 'üé≠', baseHp: 180, baseAtk: 50, baseDef: 20, goldMin: 45, goldMax: 70, material: 'puppet_gear', matChance: 0.3 },
                { name: 'Â§±ÊïóÂØ¶È©óÈ´î', emoji: 'üß™', baseHp: 220, baseAtk: 48, baseDef: 22, goldMin: 45, goldMax: 75, material: 'mutant_fluid', matChance: 0.35 },
            ],
            6: [
                { name: 'Â∞èÊÉ°È≠î', emoji: 'üòà', baseHp: 300, baseAtk: 65, baseDef: 30, goldMin: 60, goldMax: 90, material: 'imp_horn', matChance: 0.35 },
                { name: 'Âú∞ÁçÑÁä¨', emoji: 'üêï', baseHp: 320, baseAtk: 70, baseDef: 28, goldMin: 65, goldMax: 100, material: 'hellhound_ash', matChance: 0.3 },
                { name: 'Â¢ÆËêΩÂ§©‰Ωø', emoji: 'üëº', baseHp: 280, baseAtk: 75, baseDef: 25, goldMin: 70, goldMax: 110, material: 'black_feather', matChance: 0.3 },
            ],
            7: [
                { name: 'ÂÜ∞ÈúúÂ∑®‰∫∫', emoji: 'üßä', baseHp: 450, baseAtk: 85, baseDef: 40, goldMin: 80, goldMax: 130, material: 'frost_core', matChance: 0.35 },
                { name: 'ÂØíÂÜ∞ÂπΩÈ≠Ç', emoji: 'üëª', baseHp: 300, baseAtk: 95, baseDef: 25, goldMin: 85, goldMax: 140, material: 'wraith_dust', matChance: 0.3 },
                { name: 'ÂÜ∞Áãº', emoji: 'üê∫', baseHp: 380, baseAtk: 90, baseDef: 35, goldMin: 80, goldMax: 135, material: 'ice_wolf_claw', matChance: 0.35 },
            ],
            8: [
                { name: 'ÁÅ´ÁÑ∞Á≤æÈùà', emoji: 'üî•', baseHp: 400, baseAtk: 110, baseDef: 35, goldMin: 100, goldMax: 160, material: 'ember_spark', matChance: 0.35 },
                { name: 'ÁÜîÂ≤©Â∑®‰∫∫', emoji: 'üåã', baseHp: 650, baseAtk: 100, baseDef: 55, goldMin: 110, goldMax: 180, material: 'magma_rock', matChance: 0.3 },
                { name: 'ÁÅ´Ëú•Ëú¥', emoji: 'ü¶é', baseHp: 480, baseAtk: 105, baseDef: 45, goldMin: 105, goldMax: 170, material: 'salamander_scale', matChance: 0.35 },
            ],
            9: [
                { name: 'ËôõÁ©∫Ë°åËÄÖ', emoji: 'üåÄ', baseHp: 700, baseAtk: 130, baseDef: 50, goldMin: 140, goldMax: 220, material: 'void_dust', matChance: 0.3 },
                { name: 'Áï∞ÁïåÁçµÊâã', emoji: 'üëÅÔ∏è', baseHp: 600, baseAtk: 145, baseDef: 40, goldMin: 150, goldMax: 240, material: 'alien_eye', matChance: 0.3 },
                { name: 'Ê∑∑Ê≤å‰ΩøËÄÖ', emoji: 'üí´', baseHp: 650, baseAtk: 150, baseDef: 45, goldMin: 160, goldMax: 250, material: 'chaos_shard', matChance: 0.25 },
            ],
            10: [
                { name: 'È≠îÁéãËøëË°õ', emoji: '‚öîÔ∏è', baseHp: 900, baseAtk: 170, baseDef: 60, goldMin: 200, goldMax: 300, material: 'guard_badge', matChance: 0.3 },
                { name: 'ÊöóÈªëÈæç', emoji: 'üêâ', baseHp: 1200, baseAtk: 180, baseDef: 70, goldMin: 250, goldMax: 400, material: 'dragon_scale', matChance: 0.35 },
                { name: 'Ê≠ª‰∫°È®éÂ£´', emoji: 'üó°Ô∏è', baseHp: 1000, baseAtk: 190, baseDef: 65, goldMin: 220, goldMax: 350, material: 'dark_metal', matChance: 0.3 },
            ]
        };

        // Chest Mimics by Area
        const CHEST_MIMICS = {
            1: { name: 'ÂØ∂ÁÆ±ÊÄ™', emoji: 'üì¶', hpMult: 1.2, atkMult: 1.2, defMult: 1.0 },
            2: { name: 'Ë≤™Â©™È≠îÁÆ±', emoji: 'üéÅ', hpMult: 1.2, atkMult: 1.3, defMult: 1.0 },
            3: { name: 'Ë©õÂííÂØ∂ÁÆ±', emoji: 'üíÄ', hpMult: 1.3, atkMult: 1.3, defMult: 1.1 },
            4: { name: 'Ê£ÆÊûóÂØÑÁîüÁÆ±', emoji: 'üåø', hpMult: 1.3, atkMult: 1.4, defMult: 1.1 },
            5: { name: 'È≠îÊ≥ïÁÆ±È≠î', emoji: '‚ú®', hpMult: 1.4, atkMult: 1.4, defMult: 1.2 },
            6: { name: 'ÊÉ°È≠îÂØ∂ÁÆ±', emoji: 'üòà', hpMult: 1.4, atkMult: 1.5, defMult: 1.2 },
            7: { name: 'ÂÜ∞ÂáçÈ≠îÁÆ±', emoji: 'üßä', hpMult: 1.5, atkMult: 1.5, defMult: 1.3 },
            8: { name: 'ÁÉàÁÑ∞È≠îÁÆ±', emoji: 'üî•', hpMult: 1.5, atkMult: 1.6, defMult: 1.3 },
            9: { name: 'ËôõÁ©∫ÂêûÂô¨ËÄÖ', emoji: 'üåë', hpMult: 1.6, atkMult: 1.6, defMult: 1.4 },
            10: { name: 'È≠îÁéãÁöÑÂØ∂Áâ©', emoji: 'üëë', hpMult: 1.8, atkMult: 1.5, defMult: 1.5 } // Reduced Atk Mult from 2.0 to 1.5
        };

        const AREA_BOSSES = {
            1: { name: 'Áõ£ÁçÑÁúãÂÆàÈï∑', emoji: 'üëπ', baseHp: 400, baseAtk: 35, baseDef: 15, goldMin: 100, goldMax: 200, soulReward: 15, material: 'boss_1' },
            2: { name: 'Ê¥ûÁ™üËúòËõõÂêé', emoji: 'üï∑Ô∏è', baseHp: 700, baseAtk: 50, baseDef: 25, goldMin: 150, goldMax: 250, soulReward: 25, material: 'boss_2' },
            3: { name: 'È™∑È´èÈ†ò‰∏ª', emoji: '‚ò†Ô∏è', baseHp: 1000, baseAtk: 70, baseDef: 35, goldMin: 250, goldMax: 400, soulReward: 40, material: 'boss_3' },
            4: { name: 'Ê£ÆÊûóÂÆàË≠∑ËÄÖ', emoji: 'üå≤', baseHp: 1500, baseAtk: 85, baseDef: 45, goldMin: 400, goldMax: 600, soulReward: 60, material: 'boss_4' },
            5: { name: 'ÁòãÁãÇÈçäÈáëË°ìÂ∏´', emoji: 'üßô', baseHp: 2000, baseAtk: 100, baseDef: 55, goldMin: 600, goldMax: 900, soulReward: 80, material: 'boss_5' },
            6: { name: 'ÊÉ°È≠îÂ∞áËªç', emoji: 'üëø', baseHp: 2800, baseAtk: 130, baseDef: 70, goldMin: 800, goldMax: 1200, soulReward: 120, material: 'boss_6' },
            7: { name: 'ÂÜ∞ÈúúÂ•≥Áéã', emoji: 'üë∏', baseHp: 3500, baseAtk: 160, baseDef: 85, goldMin: 1000, goldMax: 1500, soulReward: 160, material: 'boss_7' },
            8: { name: 'ÁÉàÁÑ∞È≠îÂêõ', emoji: 'üî•', baseHp: 4200, baseAtk: 200, baseDef: 100, goldMin: 1500, goldMax: 2200, soulReward: 220, material: 'boss_8' },
            9: { name: 'ËôõÁ©∫È†ò‰∏ª', emoji: 'üåë', baseHp: 5000, baseAtk: 240, baseDef: 115, goldMin: 2000, goldMax: 3000, soulReward: 300, material: 'boss_9' },
            10: { name: 'È≠îÁéã', emoji: 'üëë', baseHp: 8000, baseAtk: 300, baseDef: 140, goldMin: 5000, goldMax: 10000, soulReward: 500, material: 'boss_10' }
        };

        const EQUIPMENT = {
            weapons: [
                { name: 'ÁîüÈèΩÁöÑÂäç', rarity: 'common', attack: 5, defense: 0, dodge: 0, crit: 1, hp: 0 },
                { name: 'ÈêµÂäç', rarity: 'common', attack: 10, defense: 0, dodge: 0, crit: 2, hp: 0 }, // Buffed
                { name: 'Áçµ‰∫∫Áü≠ÂàÄ', rarity: 'common', attack: 6, defense: 0, dodge: 2, crit: 3, hp: 0 },

                { name: 'ÈãºÂàÉ', rarity: 'uncommon', attack: 20, defense: 2, dodge: 1, crit: 3, hp: 0 }, // Buffed
                { name: 'ÈôÑÈ≠î‰πãÂäç', rarity: 'uncommon', attack: 25, defense: 5, dodge: 0, crit: 5, hp: 0 }, // Buffed
                { name: 'Âà∫ÂÆ¢ÂåïÈ¶ñ', rarity: 'uncommon', attack: 18, defense: 0, dodge: 5, crit: 10, hp: 0 }, // Buffed

                { name: 'ÁÉàÁÑ∞‰πãÂàÉ', rarity: 'rare', attack: 45, defense: 0, dodge: 3, crit: 8, hp: 0 }, // Buffed from 28
                { name: 'ÈúúÂØí‰πãÂàÉ', rarity: 'rare', attack: 40, defense: 10, dodge: 0, crit: 6, hp: 20 }, // Buffed
                { name: 'ÊöóÂΩ±ÂåïÈ¶ñ', rarity: 'rare', attack: 35, defense: 0, dodge: 8, crit: 15, hp: 0 }, // Buffed
                
                // End Game (Areas 9-10)
                { name: 'Â±†ÈæçËÄÖ', rarity: 'epic', attack: 75, defense: 15, dodge: 4, crit: 12, hp: 50 }, // Buffed from 45
                { name: 'Ëá¥ÂëΩÁ¥∞Âäç', rarity: 'epic', attack: 65, defense: 5, dodge: 12, crit: 25, hp: 0 }, // Buffed
                { name: 'ËÅñÂäç', rarity: 'legendary', attack: 120, defense: 30, dodge: 8, crit: 20, hp: 100 }, // Buffed from 70
            ],
            armor: [
                { name: 'Â∏ÉÁî≤', rarity: 'common', attack: 0, defense: 4, dodge: 1, crit: 0, hp: 10 },
                { name: 'ÁöÆÁî≤', rarity: 'common', attack: 0, defense: 6, dodge: 2, crit: 0, hp: 15 },
                { name: 'Áçµ‰∫∫ÁöÆÁî≤', rarity: 'common', attack: 2, defense: 5, dodge: 3, crit: 1, hp: 12 },
                { name: 'ÈéñÂ≠êÁî≤', rarity: 'uncommon', attack: 0, defense: 14, dodge: 0, crit: 0, hp: 30 },
                { name: 'Âº∑ÂåñÁöÆÁî≤', rarity: 'uncommon', attack: 3, defense: 12, dodge: 3, crit: 2, hp: 25 },
                { name: 'Âà∫ÂÆ¢Â•óË£ù', rarity: 'uncommon', attack: 5, defense: 8, dodge: 6, crit: 5, hp: 15 },
                { name: 'ÊùøÁî≤', rarity: 'rare', attack: 0, defense: 40, dodge: -5, crit: 0, hp: 100 }, // Buffed
                { name: 'ÁßòÈäÄÁî≤', rarity: 'rare', attack: 8, defense: 35, dodge: 4, crit: 4, hp: 80 }, // Buffed
                { name: 'ÈæçÈ±óÁî≤', rarity: 'epic', attack: 15, defense: 65, dodge: 3, crit: 6, hp: 200 }, // Buffed
                { name: 'ÂπªÂΩ±Êä´È¢®', rarity: 'epic', attack: 25, defense: 45, dodge: 20, crit: 15, hp: 80 }, // Buffed
                { name: 'Á•ûËÅñÊùøÁî≤', rarity: 'legendary', attack: 40, defense: 100, dodge: 5, crit: 10, hp: 300 }, // Massive Buff
            ],
            accessories: [
                { name: 'ÈäÖÊàíÊåá', rarity: 'common', attack: 2, defense: 2, dodge: 1, crit: 1, hp: 5 },
                { name: 'ÈäÄË≠∑Á¨¶', rarity: 'common', attack: 3, defense: 3, dodge: 0, crit: 1, hp: 8 },
                { name: 'ÁîüÂëΩÂ¢úÈ£æ', rarity: 'common', attack: 0, defense: 2, dodge: 0, crit: 0, hp: 20 },
                { name: 'Á¥ÖÂØ∂Áü≥ÊàíÊåá', rarity: 'uncommon', attack: 8, defense: 0, dodge: 2, crit: 3, hp: 10 },
                { name: 'ËóçÂØ∂Áü≥ÂêäÂ¢ú', rarity: 'uncommon', attack: 0, defense: 8, dodge: 3, crit: 2, hp: 25 },
                { name: 'ÁîüÂëΩË≠∑Á¨¶', rarity: 'uncommon', attack: 2, defense: 4, dodge: 0, crit: 0, hp: 40 },
                { name: 'Áø°Áø†Ë≠∑Á¨¶', rarity: 'rare', attack: 10, defense: 10, dodge: 5, crit: 5, hp: 30 },
                { name: 'ÈëΩÁü≥ÊàíÊåá', rarity: 'rare', attack: 25, defense: 10, dodge: 5, crit: 12, hp: 40 }, // Buffed
                { name: '‰∏çÊ≠ªË≠∑Á¨¶', rarity: 'rare', attack: 5, defense: 8, dodge: 2, crit: 2, hp: 70 },
                { name: 'È≥≥Âá∞ÁæΩÈ£æ', rarity: 'epic', attack: 35, defense: 25, dodge: 10, crit: 15, hp: 100 }, // Buffed
                { name: 'Èæç‰πãÂøÉ', rarity: 'epic', attack: 25, defense: 20, dodge: 5, crit: 8, hp: 100 },
                { name: 'ÊôÇ‰ª£‰πãÂÜ†', rarity: 'legendary', attack: 60, defense: 50, dodge: 15, crit: 20, hp: 200 }, // Massive Buff
            ]
        };

        const POTION_TYPES = {
            small: { name: 'Â∞èÂûãËó•Ê∞¥', healPercent: 0.15, basePrice: 20, emoji: 'üß™' },
            medium: { name: '‰∏≠ÂûãËó•Ê∞¥', healPercent: 0.25, basePrice: 45, emoji: 'üß¥' },
            large: { name: 'Â§ßÂûãËó•Ê∞¥', healPercent: 0.40, basePrice: 80, emoji: '‚öóÔ∏è' },
            full: { name: 'ÂÆåÂÖ®ÊÅ¢Âæ©', healPercent: 1.0, basePrice: 130, emoji: 'üíä' }
        };

        const RARITY_NAMES = {
            common: 'ÊôÆÈÄö',
            uncommon: 'ÂÑ™ËâØ',
            rare: 'Á®ÄÊúâ',
            epic: 'Âè≤Ë©©',
            legendary: 'ÂÇ≥Ë™™'
        };

        const SLOT_NAMES = {
            weapon: 'Ê≠¶Âô®',
            armor: 'Ë≠∑Áî≤',
            accessory: 'È£æÂìÅ'
        };

        const EVENTS = {
            fight: { weight: 60, icon: '‚öîÔ∏è', title: 'ÈÅ≠ÈÅáÊÄ™Áâ©ÔºÅ' },
            treasure: { weight: 10, icon: 'üíé', title: 'ÁôºÁèæÂØ∂ÁÆ±ÔºÅ' },
            merchant: { weight: 10, icon: 'üè™', title: 'ÊµÅÊµ™ÂïÜ‰∫∫' },
            event: { weight: 15, icon: '‚ùì', title: 'Á•ûÁßò‰∫ã‰ª∂' },
            rest: { weight: 5, icon: 'üèïÔ∏è', title: 'ÂÆâÂÖ®ÂçÄÂüü' }
        };

        const AREA_EVENTS = {
            // Area 1: Underground Prison (Âú∞‰∏ãÁõ£Áâ¢)
            1: [
                {
                    name: 'ÁîüÈèΩÁöÑÁâ¢ÈñÄ', icon: 'üö™', description: '‰∏ÄÊâáÂçäÊé©ÁöÑÁâ¢ÈñÄÔºåË£°Èù¢ÈªëÊºÜÊºÜÁöÑ„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 30 + game.level; game.player.gold += g; return `‰Ω†Âú®Á®ªËçâÂ†Ü‰∏ãÊâæÂà∞‰∫Ü ${g} ÈáëÂπ£ÔºÅ`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `ÈñÄËª∏Êñ∑‰∫ÜÔºÅÁ†∏Âà∞‰Ω†ÁöÑËÖ≥ÔºåÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ÁôºÈúâÁöÑÈ∫µÂåÖ', icon: 'üçû', description: 'Ê°å‰∏äÊîæËëó‰∏ÄÂ°äÁôºÈúâÁöÑÈ∫µÂåÖÔºå‰Ω†ËÇöÂ≠êÊ≠£Â•ΩÈ§ì‰∫Ü...',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.2); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // ‚úÖ FIX
                            return `ÈõñÁÑ∂Âë≥ÈÅìÊÄ™ÊÄ™ÁöÑÔºå‰ΩÜÊÑèÂ§ñÂú∞ÊÅ¢Âæ©‰∫Ü ${h} È´îÂäõ„ÄÇ`; 
                        },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `Âòî...ÈÄôÈ∫µÂåÖÂ£û‰∫ÜÔºå‰Ω†È£üÁâ©‰∏≠ÊØíÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ÁòãÁãÇÂõöÁäØ', icon: 'ü§™', description: '‰∏ÄÂÄãË¢´ÈóúÂ§™‰πÖÁöÑÂõöÁäØÂú®Ëá™Ë®ÄËá™Ë™û„ÄÇË¶ÅÊê≠Ë©±ÂóéÔºü',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ÁòãÁãÇ‰πãÂäõ', 10, 'attack', 5, 'positive'); return `‰ªñÊïô‰∫Ü‰Ω†‰∏ÄÁ®ÆÁòãÁãÇÁöÑÊà∞È¨•Ê≥ïÔºÅÊîªÊìä +5 (10Â±§)`; },
                        () => { game.addBuff('Á≤æÁ•ûÊ±°Êüì', 10, 'defense', -3, 'negative'); return `‰ªñÁöÑÁòãË®ÄÁòãË™ûËÆì‰Ω†È†≠ÁóõÊ¨≤Ë£Ç„ÄÇÈò≤Á¶¶ -3 (10Â±§)`; }
                    )
                },
                {
                    name: 'ËÄÅÈº†Ê¥û', icon: 'üï≥Ô∏è', description: 'ÁâÜËßíÊúâÂÄãËÄÅÈº†Ê¥ûÔºåË£°Èù¢‰ºº‰πéÊúâÊù±Ë•øÂú®ÈñÉÂÖâ„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['rat_tail'] = (game.player.materials['rat_tail']||0)+1; return `‰Ω†ÊäìÂà∞‰∫Ü‰∏ÄÈöªËÄÅÈº†ÔºÅÁç≤Âæó [ËÄÅÈº†Â∞æÂ∑¥]`; },
                        () => { const d = 10; game.player.hp = Math.max(0, game.player.hp - d); return `ÂìéÂî∑ÔºÅÊâãÊåáË¢´ËÄÅÈº†Âí¨‰∫Ü‰∏ÄÂè£ÔºåÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive
                    name: 'Ââç‰∫∫ÁöÑÈÅ∫Áâ©', icon: 'üéí', description: '‰∏Ä‰ΩçË∂äÁçÑÊàêÂäüÁöÑÁäØ‰∫∫Áïô‰∏ãÁöÑË£úÁµ¶ÂåÖ„ÄÇ',
                    resolve: (game) => { const g = 50; game.player.gold += g; return { text: `ÈÅãÊ∞£ÁúüÂ•ΩÔºÅË£°Èù¢Êúâ ${g} ÈáëÂπ£Âíå‰∏Ä‰∫õ‰πæÁ≥ß„ÄÇ`, type: 'positive' }; }
                }
            ],

            // Area 2: Dark Cave (Èô∞ÊöóÊ¥ûÁ™ü)
            2: [
                {
                    name: 'ÁôºÂÖâËãîËòö', icon: 'üåø', description: 'ÁâÜ‰∏äÈï∑Êªø‰∫ÜÁôºÂá∫ÂπΩÂÖâÁöÑËãîËòö„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('Â§úË¶ñ', 20, 'dodge', 10, 'positive'); return `ÂêÉ‰∫Ü‰πãÂæåË¶ñÂäõËÆäÂ•Ω‰∫ÜÔºÅÈñÉÈÅø +10% (20Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `ÊúâÊØíÔºÅËàåÈ†≠È∫ªÁó∫‰∫ÜÔºåÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'Âª¢Ê£ÑÁ§¶Ëªä', icon: 'üõí', description: '‰∏ÄËºõÁøªÂÄíÁöÑÁ§¶ËªäÔºåÊàñË®±ÈÇÑËÉΩÁî®„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['goblin_ear'] = (game.player.materials['goblin_ear']||0)+1; return `Âú®ËªäÂ∫ïÁôºÁèæ‰∫ÜÂì•Â∏ÉÊûóÁöÑËóèÂØ∂ÔºÅÁç≤Âæó [Âì•Â∏ÉÊûóËÄ≥Êúµ]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `Á§¶ËªäÊªëÂãïÊíûÂà∞‰∫Ü‰Ω†ÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ËùôËù†Áæ§', icon: 'ü¶á', description: 'Â§©Ëä±Êùø‰∏äÊéõÊªø‰∫ÜËùôËù†„ÄÇË¶Å‰∏üÁü≥È†≠È©öÂöáÁâ†ÂÄëÂóéÔºü',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const g = 60; game.player.gold += g; return `ËùôËù†ÂöáÈ£õ‰∫ÜÔºåÊéâËêΩ‰∫Ü ${g} ÈáëÂπ£ÔºÅ`; },
                        () => { game.addBuff('Ê∑∑‰∫Ç', 10, 'attack', -5, 'negative'); return `ËùôËù†Áæ§Ëµ∑ÊîªÊìäÔºÅ‰Ω†ÊâãÂøôËÖ≥‰∫ÇÔºåÊîªÊìä -5 (10Â±§)`; }
                    )
                },
                {
                    name: 'Á•ûÁßòÁ§¶Áü≥', icon: 'ü™®', description: 'ÁâÜÂ£Å‰∏äÂµåËëó‰∏ÄÂ°äÂ•áÊÄ™ÁöÑÁü≥È†≠„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('Á°¨ÂåñÁöÆËÜö', 15, 'defense', 5, 'positive'); return `Ëß∏Êë∏ÂæåÁöÆËÜöËÆäÁ°¨‰∫ÜÔºÅÈò≤Á¶¶ +5 (15Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `Áü≥È†≠Á™ÅÁÑ∂ÁàÜÁÇ∏‰∫ÜÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive - ‚úÖ FIX
                    name: 'Âú∞‰∏ãÊ∏ÖÊ≥â', icon: 'üíß', description: '‰∏ÄËÇ°Ê∏ÖÊæàÁöÑÊ≥âÊ∞¥ÂæûÂ≤©Á∏´‰∏≠ÊµÅÂá∫„ÄÇ',
                    resolve: (game) => { 
                        const h = Math.floor(game.getMaxHp() * 0.3); 
                        game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // ‚úÖ FIX
                        return { text: `Ê∏ÖÊ∂ºÁöÑÊ≥âÊ∞¥ÔºÅÊÅ¢Âæ©‰∫Ü ${h} ÁîüÂëΩ„ÄÇ`, type: 'positive' }; 
                    }
                }
            ],

            // Area 3: Skeleton Graveyard (È™∑È´èÂ¢ìÂú∞)
            3: [
                {
                    name: 'ÁÑ°ÂêçÂ¢ìÁ¢ë', icon: 'ü™¶', description: '‰∏ÄÂ∫ßÊ≠™ÊñúÁöÑÂ¢ìÁ¢ë„ÄÇË¶ÅÊåñÊéòÁúãÁúãÂóéÔºü',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const s = 5; game.soulGainedThisRun += s; return `ÊåñÂà∞‰∫ÜÈùàÈ≠ÇÁ¢éÁâáÔºÅÁç≤Âæó ${s} ÈùàÈ≠Ç„ÄÇ`; },
                        () => { game.addBuff('Ë©õÂíí', 15, 'defense', -8, 'negative'); return `ÂÜíÁäØ‰∫Ü‰∫°ËÄÖÔºÅÈò≤Á¶¶ -8 (15Â±§)`; }
                    )
                },
                {
                    name: '‰æõÂìÅÁõ§', icon: 'ü•£', description: 'ÊîæÂú®Â¢ìÂâçÁöÑ‰æõÂìÅÁõ§ÔºåË£°Èù¢Êúâ‰∏Ä‰∫õÈáëÂπ£„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 80; game.player.gold += g; return `ÊãøËµ∞‰∫Ü‰æõÂìÅ„ÄÇÁç≤Âæó ${g} ÈáëÂπ£„ÄÇ`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `‰æõÂìÅÁõ§Âí¨‰∫Ü‰Ω†ÁöÑÊâãÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'È¨ºÁÅ´', icon: 'üî•', description: '‰∏ÄÂúòËóçËâ≤ÁöÑÁÅ´ÁÑ∞Âú®Á©∫‰∏≠ÊºÇÊµÆ„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ÂπΩÂÜ•ÁÅ´', 15, 'crit', 10, 'positive'); return `ÁÅ´ÁÑ∞ÈôÑËëóÂú®Ê≠¶Âô®‰∏äÔºÅÁàÜÊìä +10% (15Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `ÈùàÈ≠ÇË¢´ÁÅºÁáí‰∫ÜÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'Êï£ËêΩÁöÑÈ™®È†≠', icon: 'ü¶¥', description: '‰∏ÄÂ†ÜÁôΩÈ™®„ÄÇÁúãËµ∑‰æÜÂèØ‰ª•ÊãºÊπäÊàê‰ªÄÈ∫º„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['rib_bone'] = (game.player.materials['rib_bone']||0)+1; return `ÊâæÂà∞‰∫Ü‰∏ÄÊ†πÂ†ÖÂõ∫ÁöÑËÇãÈ™®ÔºÅÁç≤Âæó [ËÖêÊúΩËÇãÈ™®]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `È™®È†≠Á™ÅÁÑ∂Âà∫Âêë‰Ω†ÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive
                    name: 'ÂÆâÊÅØÁöÑÈùàÈ≠Ç', icon: 'üëª', description: '‰∏ÄÂÄãÂèãÂñÑÁöÑÂπΩÈùàÂêë‰Ω†ÈªûÈ†≠Ëá¥ÊÑè„ÄÇ',
                    resolve: (game) => { game.addBuff('ÂÆàË≠∑Èùà', 20, 'defense', 10, 'positive'); return { text: `‰Ω†ÊÑüÂà∞Ë¢´ÂÆàË≠∑Ëëó„ÄÇÈò≤Á¶¶ +10 (20Â±§)`, type: 'positive' }; }
                }
            ],

            // Area 4: Dark Forest (ÂπΩÊöóÊ£ÆÊûó)
            4: [
                {
                    name: 'Â•áÁï∞ÊûúÂØ¶', icon: 'üçí', description: 'Ê®π‰∏äÈï∑ËëóÈÆÆË±îÁöÑÊûúÂØ¶„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.4); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // ‚úÖ FIX
                            return `ÁæéÂë≥Â§öÊ±ÅÔºÅÊÅ¢Âæ©‰∫Ü ${h} ÁîüÂëΩ„ÄÇ`; 
                        },
                        () => { game.addBuff('Ëá¥Âπª', 15, 'dodge', -10, 'negative'); return `ÂêÉ‰∫Ü‰πãÂæåÂ§©ÊóãÂú∞ËΩâ... ÈñÉÈÅø -10% (15Â±§)`; }
                    )
                },
                {
                    name: 'Áçµ‰∫∫Èô∑Èò±', icon: 'üï∏Ô∏è', description: 'Âú∞‰∏äÊúâÂÄãËàäÁöÑÊçïÁç∏Â§æ„ÄÇË©¶ËëóÊãÜÈô§ÂÆÉÔºü',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const g = 100; game.player.gold += g; return `ÊãÜÈô§ÊàêÂäüÔºÅÂ∞áÂª¢ÈêµË≥£ÊéâÁç≤Âæó ${g} ÈáëÂπ£„ÄÇ`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `Â§æÂà∞Êâã‰∫ÜÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'Ê®πÊ¥û', icon: 'üå≥', description: 'ËÄÅÊ®π‰∏äÊúâÂÄãÊ∑±ÈÇÉÁöÑÊ®πÊ¥û„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.player.materials['dryad_branch'] = (game.player.materials['dryad_branch']||0)+1; return `Êë∏Âà∞‰∫ÜÊ®πÂ¶ñÁöÑÊûùÊ¢ùÔºÅÁç≤Âæó [Ê®πÂ¶ñÊûØÊûù]`; },
                        () => { game.addBuff('Á∫èÁπû', 10, 'dodge', -15, 'negative'); return `Ë¢´Ëó§ËîìÁ∫è‰Ωè‰∫ÜÔºÅÈñÉÈÅø -15% (10Â±§)`; }
                    )
                },
                {
                    name: 'Á≤æÈùàÂÖâÁí∞', icon: '‚ú®', description: '‰∏ÄÂúàÂ•áÊÄ™ÁöÑËòëËèáÂΩ¢ÊàêÁöÑÂúìÁí∞„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.addBuff('Ëá™ÁÑ∂‰πãÂäõ', 20, 'attack', 15, 'positive'); return `Áç≤Âæó‰∫ÜÊ£ÆÊûóÁöÑÁ•ùÁ¶èÔºÅÊîªÊìä +15 (20Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `Ë¢´Á≤æÈùàÊÉ°‰ΩúÂäá‰∫ÜÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive - ‚úÖ FIX
                    name: 'ÊúàÂÖâÁ©∫Âú∞', icon: 'üåô', description: 'ÊúàÂÖâÁÅëËêΩÂú®ÈÄôÁâáÂØßÈùúÁöÑÁ©∫Âú∞‰∏ä„ÄÇ',
                    resolve: (game) => { 
                        const h = Math.floor(game.getMaxHp() * 0.3); 
                        game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // ‚úÖ FIX
                        return { text: `ÂøÉÈùàÂæóÂà∞‰∫ÜÂπ≥Èùú„ÄÇÊÅ¢Âæ© ${h} ÁîüÂëΩ„ÄÇ`, type: 'positive' }; 
                    }
                }
            ],

            // Area 5: Magic Lab (È≠îÊ≥ïÂØ¶È©óÂÆ§)
            5: [
                {
                    name: 'ÂÜíÊ≥°ÁöÑÂù©Â†ù', icon: 'üç≤', description: '‰∏ÄÈçãÈ°èËâ≤Ë©≠Áï∞ÁöÑÊ∂≤È´îÊ≠£Âú®Ê≤∏È®∞„ÄÇÂñù‰∏ÄÂè£Ôºü',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('Â∑®‰∫∫‰πãÂäõ', 20, 'attack', 25, 'positive'); return `ÊÑüË¶∫ÂäõÈáèÊπß‰∏ä‰æÜ‰∫ÜÔºÅÊîªÊìä +25 (20Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.25); game.player.hp = Math.max(0, game.player.hp - d); return `ÁàÜÁÇ∏‰∫ÜÔºÅ‰Ω†Ë¢´ÁÇ∏È£õÔºåÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'Âè§ËÄÅÈ≠îÂ∞éÊõ∏', icon: 'üìñ', description: '‰∏ÄÊú¨Á©çÊªøÁÅ∞Â°µÁöÑÈ≠îÊ≥ïÊõ∏„ÄÇÈñ±ËÆÄÂÆÉÔºü',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const s = 10; game.soulGainedThisRun += s; return `Â≠∏Âà∞‰∫ÜÁ¶ÅÂøåÁöÑÁü•Ë≠òÔºÅÁç≤Âæó ${s} ÈùàÈ≠Ç„ÄÇ`; },
                        () => { game.addBuff('Ë©õÂííÁ¨¶Êñá', 15, 'defense', -15, 'negative'); return `ÁúºÁùõÂ•ΩÁóõÔºÅÈò≤Á¶¶ -15 (15Â±§)`; }
                    )
                },
                {
                    name: '‰∏çÁ©©ÂÆöÁöÑÈ≠îÂÅ∂', icon: 'ü§ñ', description: '‰∏ÄÂÄãÂçäÊàêÂìÅÁöÑÈ≠îÂÅ∂Âú®ÊäΩÊêê„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.player.materials['puppet_gear'] = (game.player.materials['puppet_gear']||0)+1; return `ÊãÜ‰∏ã‰∫Ü‰∏ÄÂÄãÈõ∂‰ª∂ÔºÅÁç≤Âæó [È≠îÂÅ∂ÈΩíËº™]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `È≠îÂÅ∂ÊîæÂá∫‰∫ÜÈõªÊµÅÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ÂØ¶È©óÊ®ôÊú¨', icon: 'üß™', description: 'Á¶èÈ¶¨ÊûóË£°Ê≥°ËëóÂ•áÊÄ™ÁöÑÁîüÁâ©„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.addBuff('ÁîüÁâ©Ê¥ûÂØü', 20, 'crit', 15, 'positive'); return `ÁôºÁèæ‰∫ÜÂº±ÈªûÔºÅÁàÜÊìä +15% (20Â±§)`; },
                        () => { game.addBuff('ÊØíÊ∞£', 10, 'attack', -10, 'negative'); return `ÁΩêÂ≠êÁ†¥‰∫ÜÔºåÊØíÊ∞£Â§ñÊ¥©ÔºÅÊîªÊìä -10 (10Â±§)`; }
                    )
                },
                {   // Positive
                    name: 'ÈçäÈáëËó•Êû∂', icon: 'üß¥', description: 'Êû∂Â≠ê‰∏äÈÇÑÁïôÊúâ‰∏Ä‰∫õÂÆåÂ•ΩÁöÑËó•Ê∞¥„ÄÇ',
                    resolve: (game) => { game.player.potions['medium']++; return { text: `ÊâæÂà∞‰∫Ü‰∏ÄÁì∂‰∏≠ÂûãËó•Ê∞¥ÔºÅ`, type: 'positive' }; }
                }
            ],

            // Area 6: Demon Hall (ÊÉ°È≠îÊÆøÂ†Ç)
            6: [
                {
                    name: 'ÈÆÆË°ÄÂô¥Ê≥â', icon: 'ü©∏', description: 'Âô¥Ê≥âË£°ÊµÅÊ∑åËëóÈÆÆÁ¥ÖÁöÑÊ∂≤È´î„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ÂóúË°Ä', 20, 'attack', 30, 'positive'); return `Âñù‰∏ãÊÉ°È≠î‰πãË°ÄÔºÅÊîªÊìä +30 (20Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.3); game.player.hp = Math.max(0, game.player.hp - d); return `Ë°ÄÊ∂≤Âú®ÁáÉÁáíÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ÊÉ°È≠îÈõïÂÉè', icon: 'üëø', description: '‰∏ÄÂ∫ßÁåôÁç∞ÁöÑÈõïÂÉè„ÄÇË¶ÅÁ•àÁ¶±ÂóéÔºü',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const g = 200; game.player.gold += g; return `ÈõïÂÉèÂêêÂá∫‰∫ÜÈáëÂπ£ÔºÅÁç≤Âæó ${g} G„ÄÇ`; },
                        () => { game.addBuff('ÊÉ°È≠îÂáùË¶ñ', 15, 'defense', -20, 'negative'); return `ÈõïÂÉèÂãï‰∫ÜÔºÅ‰Ω†Ë¢´Ë©õÂíí‰∫ÜÔºåÈò≤Á¶¶ -20 (15Â±§)`; }
                    )
                },
                {
                    name: 'ÂàëÂÖ∑', icon: '‚õìÔ∏è', description: '‰∏ÄÂ•óÊ≤æÊªøË°ÄË∑°ÁöÑÂàëÂÖ∑„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.player.materials['imp_horn'] = (game.player.materials['imp_horn']||0)+1; return `Âú®ÊóÅÈÇäÊíøÂà∞‰∫ÜÊà∞Âà©ÂìÅÔºÅÁç≤Âæó [Â∞èÊÉ°È≠îËßí]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `‰∏çÂ∞èÂøÉËß∏Áôº‰∫ÜÊ©üÈóúÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ÈùàÈ≠ÇÂ•ëÁ¥Ñ', icon: 'üìú', description: '‰∏ÄÂºµÁæäÁöÆÁ¥ôÔºå‰∏äÈù¢ÂØ´ËëóÁúã‰∏çÊáÇÁöÑÊñáÂ≠ó„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const s = 15; game.soulGainedThisRun += s; return `‰Ω†Ê¨∫È®ô‰∫ÜÊÉ°È≠îÔºÅÁç≤Âæó ${s} ÈùàÈ≠Ç„ÄÇ`; },
                        () => { game.soulGainedThisRun = Math.max(0, game.soulGainedThisRun - 5); return `ÈùàÈ≠ÇË¢´Âê∏Ëµ∞‰∫Ü‰∏ÄÈÉ®ÂàÜ... Â§±Âéª 5 ÈùàÈ≠Ç„ÄÇ`; }
                    )
                },
                {   // Positive
                    name: 'Ë¢´ÂõöÁ¶ÅÁöÑÂ§©‰Ωø', icon: 'üëº', description: '‰∏ÄÂÄãÂæÆÂº±ÁöÑÂÖâËäíË¢´ÈéñÂú®Á±†Â≠êË£°„ÄÇ',
                    resolve: (game) => { game.addBuff('ËÅñÂÖâÂ∫áË≠∑', 30, 'defense', 25, 'positive'); return { text: `‰Ω†ÈáãÊîæ‰∫ÜÂÖâËäíÔºÅÈò≤Á¶¶ +25 (30Â±§)`, type: 'positive' }; }
                }
            ],

            // Area 7: Ice Corridor (ÂÜ∞ÈúúËµ∞Âªä)
            7: [
                {
                    name: 'ÂÜ∞ÂáçÂÜíÈö™ËÄÖ', icon: 'üßä', description: '‰∏ÄÂÄãË¢´ÂáçÂú®ÂÜ∞Â°äË£°ÁöÑÂÜíÈö™ËÄÖ„ÄÇÊï≤ÈñãÂÜ∞Â°äÔºü',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 250; game.player.gold += g; return `‰ªñË∫´‰∏äÂ∏∂ËëóÈå¢ÂåÖÔºÅÁç≤Âæó ${g} ÈáëÂπ£„ÄÇ`; },
                        () => { game.addBuff('ÂáçÂÇ∑', 15, 'dodge', -20, 'negative'); return `ÂØíÊ∞£ÂÖ•È™®ÔºÅÂãï‰ΩúËÆäÊÖ¢‰∫ÜÔºåÈñÉÈÅø -20% (15Â±§)`; }
                    )
                },
                {
                    name: 'ÂÜ∞Êô∂Á∞á', icon: 'üíé', description: 'ÁæéÈ∫ó‰ΩÜÈãíÂà©ÁöÑÂÜ∞Êô∂„ÄÇË©¶ËëóÊé°ÈõÜÔºü',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['frost_core'] = (game.player.materials['frost_core']||0)+1; return `Êé°ÈõÜÊàêÂäüÔºÅÁç≤Âæó [Ê∞∏ÂáçÊ†∏ÂøÉ]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `ÊâãË¢´Ââ≤ÂÇ∑‰∫ÜÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'Êö¥È¢®Èõ™', icon: 'üå®Ô∏è', description: 'ÂâçÊñπÂàÆËµ∑‰∫ÜÊö¥È¢®Èõ™„ÄÇË¶ÅÂº∑Ë°åÈÄöÈÅéÂóéÔºü',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ÂØíÂÜ∞Ë≠∑Áî≤', 20, 'defense', 30, 'positive'); return `ÂÜ∞Èõ™Ë¶ÜËìã‰∫ÜÁõîÁî≤ÔºÅÈò≤Á¶¶ +30 (20Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.25); game.player.hp = Math.max(0, game.player.hp - d); return `Â•ΩÂÜ∑ÔºÅÈ´îÊ∫´ÊµÅÂ§±ÔºåÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ÊªëÊ∫úÂú∞Èù¢', icon: '‚õ∏Ô∏è', description: 'Âú∞Èù¢ÁµêÂÜ∞‰∫ÜÔºåÈùûÂ∏∏Êªë„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.6, 
                        () => { game.addBuff('ÊªëË°å', 20, 'dodge', 20, 'positive'); return `‰Ω†ÊéåÊè°‰∫ÜÊªëË°åÁöÑÊäÄÂ∑ßÔºÅÈñÉÈÅø +20% (20Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `ÊªëÂÄí‰∫ÜÔºÅÊëîÂæó‰∏çËºïÔºåÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive - ‚úÖ FIX
                    name: 'Âú∞ÁÜ±Ê∫´Ê≥â', icon: '‚ô®Ô∏è', description: 'Âú®ÈÄôÂÜ∞Â§©Èõ™Âú∞‰∏≠Á´üÁÑ∂Êúâ‰∏ÄËôïÊ∫´Ê≥â„ÄÇ',
                    resolve: (game) => { 
                        const h = Math.floor(game.getMaxHp() * 0.4); 
                        game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // ‚úÖ FIX
                        return { text: `Ê∫´Êöñ‰∫ÜË∫´ÂøÉ„ÄÇÊÅ¢Âæ© ${h} ÁîüÂëΩ„ÄÇ`, type: 'positive' }; 
                    }
                }
            ],

            // Area 8: Flame Passage (ÁÉàÁÑ∞ÈÄöÈÅì)
            8: [
                {
                    name: 'Â≤©ÊºøÊ±†', icon: 'üåã', description: 'ÊªæÁáôÁöÑÂ≤©Êºø„ÄÇË£°Èù¢Â•ΩÂÉèÊúâÊù±Ë•øÔºü',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['ember_spark'] = (game.player.materials['ember_spark']||0)+1; return `Áî®Ê≠¶Âô®ÊíàÂá∫‰∫ÜÂØ∂Áâ©ÔºÅÁç≤Âæó [‰∏çÊªÖÁÅ´Á®Æ]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.3); game.player.hp = Math.max(0, game.player.hp - d); return `Â§™Ááô‰∫ÜÔºÅË¢´Âö¥ÈáçÁáíÂÇ∑ÔºåÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'ÁáÉÁáíÈêµÁ†ß', icon: 'üî®', description: 'ÁüÆ‰∫∫Áïô‰∏ãÁöÑÈçõÈÄ†Âè∞ÔºåÈÇÑÂú®ÁáÉÁáí„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ÈãíÂà©', 20, 'attack', 40, 'positive'); return `ÈáçÊñ∞Ê∑¨Èçä‰∫ÜÊ≠¶Âô®ÔºÅÊîªÊìä +40 (20Â±§)`; },
                        () => { game.addBuff('ÁÜîÊØÄ', 15, 'defense', -25, 'negative'); return `ÁõîÁî≤Ë¢´È´òÊ∫´ÊêçÂ£û‰∫ÜÔºÅÈò≤Á¶¶ -25 (15Â±§)`; }
                    )
                },
                {
                    name: 'ÁÅ∞ÁáºÂ†Ü', icon: 'üå´Ô∏è', description: '‰∏ÄÂ†ÜÂéöÂéöÁöÑÁÅ´Â±±ÁÅ∞„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 300; game.player.gold += g; return `ÁÅ∞Ááº‰∏ãÂüãËëóÈªÉÈáëÔºÅÁç≤Âæó ${g} ÈáëÂπ£„ÄÇ`; },
                        () => { game.addBuff('Á™íÊÅØ', 10, 'attack', -15, 'negative'); return `Âê∏ÂÖ•‰∫ÜÁÅ´Â±±ÁÅ∞ÔºÅÊîªÊìä -15 (10Â±§)`; }
                    )
                },
                {
                    name: 'ÁÉàÁÑ∞Ëä±', icon: 'üå∫', description: 'Âú®ÁÅ´‰∏≠ÁõõÈñãÁöÑËä±Êúµ„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.2); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // ‚úÖ FIX
                            return `ÂÖÖÊªøÊ¥ªÂäõÁöÑËÉΩÈáèÔºÅÊÅ¢Âæ© ${h} ÁîüÂëΩ„ÄÇ`; 
                        },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `Ëä±ÊúµÂô¥Âá∫‰∫ÜÁÅ´ÁÑ∞ÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive
                    name: 'ÁÅ´Á•ûÁ•≠Â£á', icon: 'üî±', description: '‰∏ÄÂ∫ß‰æõÂ•âÁÅ´Á•ûÁöÑÁ•≠Â£áÔºåÂë®ÂúçÂæàÊ∂ºÁàΩ„ÄÇ',
                    resolve: (game) => { game.addBuff('ÁÅ´ÁÑ∞ÊäóÊÄß', 30, 'defense', 35, 'positive'); return { text: `Áç≤Âæó‰∫ÜÁÅ´Á•ûÁöÑÂ∫á‰ΩëÔºÅÈò≤Á¶¶ +35 (30Â±§)`, type: 'positive' }; }
                }
            ],

            // Area 9: Void Rift (ËôõÁ©∫Ë£ÇÈöô)
            9: [
                {
                    name: 'ÊºÇÊµÆÁúºÁêÉ', icon: 'üëÅÔ∏è', description: '‰∏ÄÂÄãÂ∑®Â§ßÁöÑÁúºÁêÉÂú®ÁõØËëó‰Ω†„ÄÇËàáÂÆÉÂ∞çË¶ñÔºü',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('Âº±ÈªûË≠òÁ†¥', 25, 'crit', 25, 'positive'); return `‰Ω†ÁúãÁ©ø‰∫ÜÁúüÁêÜÔºÅÁàÜÊìä +25% (25Â±§)`; },
                        () => { game.addBuff('ÊÅêÊáº', 15, 'attack', -30, 'negative'); return `‰Ω†ÁúãÂà∞‰∫Ü‰∏çÂèØÂêçÁãÄÁöÑÊÅêÊÄñ... ÊîªÊìä -30 (15Â±§)`; }
                    )
                },
                {
                    name: 'Á©∫ÈñìË£ÇÁ∏´', icon: 'üåÄ', description: 'Á©∫ÈñìÂá∫Áèæ‰∫ÜË£ÇÁóï„ÄÇ‰º∏ÊâãÈÄ≤ÂéªÔºü',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['void_dust'] = (game.player.materials['void_dust']||0)+1; return `Êäì‰Ωè‰∫ÜËôõÁ©∫ÁöÑÁâ©Ë≥™ÔºÅÁç≤Âæó [ËôõÁ©∫ÊòüÂ°µ]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.35); game.player.hp = Math.max(0, game.player.hp - d); return `ÊâãËáÇÂ∑ÆÈªûË¢´ÂàáÊñ∑ÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: '‰ΩéË™ûÁêÉÈ´î', icon: 'üîÆ', description: '‰∏ÄÂÄãÁôºÂá∫Á´äÁ´äÁßÅË™ûÁöÑÈªëËâ≤ÁêÉÈ´î„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const s = 25; game.soulGainedThisRun += s; return `ËÅΩÊáÇ‰∫ÜËôõÁ©∫ÁöÑË™ûË®ÄÔºÅÁç≤Âæó ${s} ÈùàÈ≠Ç„ÄÇ`; },
                        () => { game.addBuff('Á≤æÁ•ûÈåØ‰∫Ç', 20, 'dodge', -30, 'negative'); return `ËÖ¶Ë¢ãË¶ÅÁÇ∏Èñã‰∫ÜÔºÅÈñÉÈÅø -30% (20Â±§)`; }
                    )
                },
                {
                    name: 'ÈáçÂäõ‰∫ï', icon: 'üåå', description: 'ÈÄôË£°ÁöÑÈáçÂäõÁï∞Â∏∏Âº∑Â§ß„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ËºïÁõà', 20, 'dodge', 30, 'positive'); return `ÈÅ©Êáâ‰∫ÜÈáçÂäõËÆäÂåñÔºÅÈñÉÈÅø +30% (20Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `Ë¢´ÈáçÂäõÂ£ìÂûÆ‰∫ÜÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive
                    name: 'ËôõÁ©∫Ë°åÂïÜ', icon: 'üëΩ', description: '‰∏ÄÂÄãÂèãÂ•ΩÁöÑËôõÁ©∫ÁîüÁâ©Ë∑ØÈÅé„ÄÇ',
                    resolve: (game) => { game.player.potions['full']++; return { text: `‰ªñÈÄÅ‰∫Ü‰Ω†‰∏ÄÁì∂Âº∑ÂäõËó•Ê∞¥ÔºÅÁç≤Âæó [ÂÆåÂÖ®ÊÅ¢Âæ©Ëó•Ê∞¥]`, type: 'positive' }; }
                }
            ],

            // Area 10: Demon King's Throne (È≠îÁéãÂØ∂Â∫ß)
            10: [
                {
                    name: 'ÁöáÂÆ∂ÊóóÂπü', icon: 'üö©', description: 'È≠îÁéãÁöÑÊóóÂπü„ÄÇÊíïÊØÄÂÆÉÔºü',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('Â£´Ê∞£Â§ßÊåØ', 30, 'attack', 50, 'positive'); return `ÂãáÊ∞£ÂÄçÂ¢ûÔºÅÊîªÊìä +50 (30Â±§)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.3); game.player.hp = Math.max(0, game.player.hp - d); return `ÊóóÊ°øÂÄí‰∏ãÁ†∏‰∏≠‰∫Ü‰Ω†ÔºÅÂèóÂà∞ ${d} ÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {
                    name: 'Ë©õÂííÈ≠îÈè°', icon: 'ü™û', description: 'Êò†ÁÖßÂá∫ÂÖßÂøÉÊÅêÊáºÁöÑÈè°Â≠ê„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ÂøÉÂ¶ÇÊ≠¢Ê∞¥', 30, 'defense', 50, 'positive'); return `Êà∞Âãù‰∫ÜÂøÉÈ≠îÔºÅÈò≤Á¶¶ +50 (30Â±§)`; },
                        () => { game.addBuff('Ëá™ÊàëÊá∑Áñë', 20, 'crit', -50, 'negative'); return `Ë¢´ÂÄíÂΩ±ÂöáÂ£û‰∫ÜÔºÅÁàÜÊìä -50% (20Â±§)`; }
                    )
                },
                {
                    name: 'ÈªÉÈáëÈÖíÊùØ', icon: 'üç∑', description: 'Ê°å‰∏äÊúâ‰∏ÄÊùØÊú™ÂñùÂÆåÁöÑÈÖí„ÄÇ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.5); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // ‚úÖ FIX
                            return `ÊòØÈ≠îÂäõÁöÑÁìäÊºøÔºÅÊÅ¢Âæ© ${h} ÁîüÂëΩ„ÄÇ`; 
                        },
                        () => { game.addBuff('ÂäáÊØí', 20, 'attack', -40, 'negative'); return `ÊòØÊØíÈÖíÔºÅÊîªÊìä -40 (20Â±§)`; }
                    )
                },
                {
                    name: 'ÈªëÊöóÁéãÂ∫ß', icon: 'üëë', description: 'Á©∫Ëï©Ëï©ÁöÑÁéãÂ∫ß„ÄÇÂùê‰∏äÂéªË©¶Ë©¶Ôºü',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const s = 50; game.soulGainedThisRun += s; return `ÊÑüÂèóÂà∞ÁéãËÄÖÁöÑÊ∞£ÊÅØÔºÅÁç≤Âæó ${s} ÈùàÈ≠Ç„ÄÇ`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.4); game.player.hp = Math.max(0, game.player.hp - d); return `Ë¢´ÁéãÂ∫ßÊãíÁµï‰∫ÜÔºÅÂèóÂà∞ ${d} Èõ∑ÊìäÂÇ∑ÂÆ≥„ÄÇ`; }
                    )
                },
                {   // Positive
                    name: 'ÂÖ¨‰∏ªÁöÑÊâãÂ∏ï', icon: 'üß£', description: 'Âú∞‰∏äÊéâËêΩËëó‰∏ÄÊ¢ùÁπ°ËëóÁöáÂÆ§ÂæΩÁ´†ÁöÑÊâãÂ∏ï„ÄÇ',
                    resolve: (game) => { game.addBuff('ÊÑõÁöÑ‰ø°Âøµ', 50, 'attack', 30, 'positive'); game.addBuff('ÂÆàË≠∑Ë™ìË®Ä', 50, 'defense', 30, 'positive'); return { text: `ÂÖ¨‰∏ªÂ∞±Âú®ÂâçÈù¢‰∫ÜÔºÅÂÖ®Â±¨ÊÄßÂ§ßÂπÖÊèêÂçáÔºÅ`, type: 'positive' }; }
                }
            ]
        };

        // ==================== GAME CLASS ====================
        class Game {
            constructor() {
                this.soulData = loadSoulData();
                this.resetRunState();
                this.updateMenuSoulDisplay();

                if (this.loadGame()) {
                    this.restoreScreen();
                }
            }
            
            toggleTab(tabName) {
            const tabs = ['equipment', 'materials'];
            const wasActive = document.getElementById(`tab-${tabName}`).classList.contains('active');
            
            // Close all tabs first
            tabs.forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`panel-${t}`).classList.remove('active');
            });
            
            // If it wasn't active, open it
            if (!wasActive) {
                document.getElementById(`tab-${tabName}`).classList.add('active');
                document.getElementById(`panel-${tabName}`).classList.add('active');
            }
        }

        closeAllTabs() {
            const tabs = ['equipment', 'materials'];
            tabs.forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`panel-${t}`).classList.remove('active');
            });
        }

            gambleEvent(chance, successFn, failFn) {
                if (Math.random() < chance) {
                    const text = successFn();
                    return { text: text, type: 'positive' };
                } else {
                    const text = failFn();
                    return { text: text, type: 'negative' };
                }
            }

            saveGame() {
                if (!this.gameStarted || this.player.hp <= 0) return;

                const saveData = {
                    version: GAME_VERSION,
                    level: this.level,
                    player: this.player,
                    buffs: this.buffs,
                    currentArea: this.currentArea,
                    lastArea: this.lastArea,
                    storyShown: this.storyShown,
                    soulGainedThisRun: this.soulGainedThisRun,
                    inCombat: this.inCombat,
                    isMimicFight: this.isMimicFight,
                    mimicLootBonus: this.mimicLootBonus,
                    currentEvent: this.currentEvent,
                    currentMonster: this.currentMonster,
                    merchantItems: this.merchantItems,
                    pendingLoot: this.pendingLoot,
                    lastBattleLog: this.lastBattleLog,
                    randomEventName: this.currentRandomEvent ? this.currentRandomEvent.name : null,
                    isActionLocked: false  // ‚úÖ Always save as false (reset on load)
                };

                localStorage.setItem('magicTower_autoSave', JSON.stringify(saveData));
            }

            loadGame() {
                const dataStr = localStorage.getItem('magicTower_autoSave');
                if (!dataStr) return false;

                try {
                    const data = JSON.parse(dataStr);
                    // --- VERSION CHECK ---
                    if (data.version !== GAME_VERSION) {
                        console.log("Save file is from an old version. Resetting run.");
                        localStorage.removeItem('magicTower_autoSave');
                        alert("ÈÅäÊà≤Â∑≤Êõ¥Êñ∞ÔºÅÁî±ÊñºÂπ≥Ë°°Ë™øÊï¥ÔºåÊÇ®ÁöÑËàäÂ≠òÊ™îÂ∑≤ÈáçÁΩÆ„ÄÇË´ãÈñãÂßãÊñ∞ÁöÑÂÜíÈö™ÔºÅ");
                        return false;
                    }
                    // ---------------------

                    // Restore data
                    Object.assign(this, data);
                    
                    // ‚úÖ FIX: Explicitly set gameStarted to true when loading a valid save
                    this.gameStarted = true;
                    
                    // Restore Random Event reference (since functions don't save in JSON)
                    if (data.randomEventName) {
                        const areaNum = this.getAreaNumber();
                        const pool = AREA_EVENTS[areaNum] || AREA_EVENTS[1];
                        this.currentRandomEvent = pool.find(e => e.name === data.randomEventName);
                    }

                    return true;
                } catch (e) {
                    console.error("Save file corrupted", e);
                    localStorage.removeItem('magicTower_autoSave'); // ‚úÖ Clean up corrupted save
                    return false;
                }
            }

            restoreScreen() {
                this.gameStarted = true;
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                this.updateUI();

                // Decide what to render based on the saved state
                if (this.currentEvent === 'fight' || (this.inCombat && this.currentMonster)) {
                    this.renderCombat();
                } else if (this.currentEvent === 'merchant') {
                    this.renderMerchant();
                } else if (this.currentEvent === 'treasure') {
                    if (this.pendingLoot) this.renderTreasure();
                    else this.generateTreasureChoice();
                } else if (this.currentEvent === 'rest') {
                    this.generateRestArea();
                } else if (this.currentEvent === 'event' && this.currentRandomEvent) {
                    // Re-render the event choice UI since we can't restore mid-resolution
                    this.renderRandomEventChoice();
                } else if (this.pendingLoot) {
                    // Loot screen after battle
                    if (this.level > 500) this.renderFinalVictory();
                    else this.renderVictory();
                } else {
                    // ‚úÖ FIX: Always generate a new event if no valid state exists
                    // This is safer than checking innerHTML
                    this.generateEvent();
                }
            }

            // ‚úÖ NEW: Add helper method to re-render random event choice
            renderRandomEventChoice() {
                const event = this.currentRandomEvent;
                const panel = document.getElementById('event-panel');
                
                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${event.icon}</div>
                        <div><div class="event-title">${event.name}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="event-description" style="font-size: 1rem; color: #ddd; padding: 10px;">
                            ${event.description}
                        </div>
                        <div style="text-align: center; color: #888; font-size: 0.8rem; margin-top: 10px;">
                            (ÁµêÊûúÊú™Áü•ÔºåÂèØËÉΩÁç≤ÂæóÁçéÂãµÊàñÊá≤ÁΩ∞)
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="game.resolveRandomEvent()">ü§î Êé¢Á¥¢ (Ë≥≠ÈÅãÊ∞£)</button>
                        <button class="btn btn-secondary" onclick="game.skipRandomEvent()">üèÉ Áõ¥Êé•Èõ¢Èñã</button>
                    </div>
                `;
            }

            resetRunState() {
                this.level = 1;
                const soulBonuses = this.getSoulBonuses();
                
                this.player = {
                    hp: 100 + soulBonuses.vitality,
                    maxHp: 100 + soulBonuses.vitality,
                    baseAttack: 12 + soulBonuses.strength,
                    baseDefense: 5 + soulBonuses.resilience,
                    baseDodge: 5 + soulBonuses.agility,
                    baseCrit: 5 + soulBonuses.precision,
                    gold: 50 + soulBonuses.startingGold,
                    equipment: {
                        weapon: null,
                        armor: null,
                        accessory: null
                    },
                    bag: [],
                    materials: {},
                    potions: {
                        small: 2,
                        medium: 0,
                        large: 0,
                        full: 0
                    }
                };
                this.buffs = [];
                this.currentEvent = null;
                this.currentMonster = null;
                this.lastBattleLog = null;
                this.pendingLoot = null;
                this.gameStarted = false;
                this.inCombat = false;
                this.merchantItems = [];
                this.soulGainedThisRun = 0;
                this.storyShown = {};
                this.currentArea = 1;
                this.lastArea = 0;
                this.selectedBagIndex = -1;
                this.isMimicFight = false;
                this.mimicLootBonus = false;  // ‚úÖ FIX: Was missing
                this.isActionLocked = false;  // ‚úÖ NEW: Debounce flag
            }

            getSoulBonuses() {
                const u = this.soulData.upgrades;
                return {
                    vitality: u.vitality * 10,
                    strength: u.strength * 2,
                    resilience: u.resilience * 2,
                    agility: u.agility * 1,
                    precision: u.precision * 1,
                    fortune: u.fortune * 5,
                    soulHarvest: u.soulHarvest * 10,
                    potionMaster: u.potionMaster * 10,
                    startingGold: u.startingGold * 25,
                    secondChance: u.secondChance * 5
                };
            }

            updateMenuSoulDisplay() {
                const menuCount = document.getElementById('menu-soul-count');
                const shopCount = document.getElementById('shop-soul-count');
                if (menuCount) menuCount.textContent = this.soulData.souls;
                if (shopCount) shopCount.textContent = this.soulData.souls;
            }

            // ==================== AREA FUNCTIONS ====================

            getCurrentArea() {
                for (let i = AREAS.length - 1; i >= 0; i--) {
                    if (this.level >= AREAS[i].startFloor) {
                        return AREAS[i];
                    }
                }
                return AREAS[0];
            }

            getAreaNumber() {
                return this.getCurrentArea().id;
            }

            getFloorInArea() {
                const area = this.getCurrentArea();
                return this.level - area.startFloor + 1;
            }

            isAreaBossFloor() {
                const areaNum = this.getAreaNumber();
                const bossFloor = areaNum * 50;
                return this.level === bossFloor;
            }

            isNewArea() {
                const currentAreaNum = this.getAreaNumber();
                if (currentAreaNum !== this.lastArea) {
                    this.lastArea = currentAreaNum;
                    return true;
                }
                return false;
            }

            showAreaTransition() {
                const area = this.getCurrentArea();
                const areaNum = this.getAreaNumber();
                document.getElementById('area-icon').textContent = area.icon;
                document.getElementById('area-name').textContent = area.name;
                document.getElementById('area-desc').textContent = area.desc;
                document.getElementById('area-transition-title').textContent = `ÈÄ≤ÂÖ•Á¨¨${areaNum}ÂçÄÂüü`;
                document.getElementById('area-transition').classList.remove('hidden');
            }

            closeAreaTransition() {
                document.getElementById('area-transition').classList.add('hidden');
                this.checkStoryDialogue();
                this.generateEvent();
                this.updateUI();
            }

            // ==================== STORY TRANSITION ====================

            showStoryTransition() {
                const dialogue = STORY_DIALOGUES.start;
                document.getElementById('story-icon').textContent = 'üëë';
                document.getElementById('story-title').textContent = 'ÁéãÂüéÂ§ßÊÆø';
                document.getElementById('story-speaker').textContent = dialogue.speaker;
                document.getElementById('story-text').textContent = dialogue.text;
                document.getElementById('story-transition').classList.remove('hidden');
            }

            closeStoryTransition() {
                document.getElementById('story-transition').classList.add('hidden');
                this.lastArea = 1;
                this.showAreaTransition();
            }

            // ==================== MENU FUNCTIONS ====================

            openSoulShop() {
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('soul-shop').style.display = 'flex';
                this.renderSoulShop();
            }

            closeSoulShop() {
                document.getElementById('soul-shop').style.display = 'none';
                document.getElementById('main-menu').classList.remove('hidden');
                this.updateMenuSoulDisplay();
            }

            renderSoulShop() {
                const container = document.getElementById('soul-shop-items');
                this.updateMenuSoulDisplay();
                
                container.innerHTML = SOUL_UPGRADES.map(upgrade => {
                    const currentLevel = this.soulData.upgrades[upgrade.id];
                    const isMaxed = currentLevel >= upgrade.maxLevel;
                    const cost = isMaxed ? 0 : Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, currentLevel));
                    const canAfford = this.soulData.souls >= cost;
                    
                    return `
                        <div class="soul-upgrade ${isMaxed ? 'maxed' : ''}">
                            <div class="upgrade-info">
                                <div class="upgrade-name">${upgrade.name}</div>
                                <div class="upgrade-desc">${upgrade.desc}</div>
                                <div class="upgrade-level">Á≠âÁ¥ö ${currentLevel} / ${upgrade.maxLevel} (${upgrade.effect})</div>
                            </div>
                            <div class="upgrade-cost ${isMaxed ? 'maxed' : (!canAfford ? 'disabled' : '')}" 
                                 onclick="${isMaxed ? '' : `game.purchaseUpgrade('${upgrade.id}')`}">
                                ${isMaxed ? '‚úì Â∑≤ÊªøÁ¥ö' : `üíé ${cost}`}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            purchaseUpgrade(upgradeId) {
                const upgrade = SOUL_UPGRADES.find(u => u.id === upgradeId);
                if (!upgrade) return;
                
                const currentLevel = this.soulData.upgrades[upgradeId];
                if (currentLevel >= upgrade.maxLevel) return;
                
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, currentLevel));
                if (this.soulData.souls < cost) return;
                
                this.soulData.souls -= cost;
                this.soulData.upgrades[upgradeId]++;
                saveSoulData(this.soulData);
                this.renderSoulShop();
            }

            startNewRun() {
                this.resetRunState();
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                this.gameStarted = true;
                this.soulData.totalRuns++;
                saveSoulData(this.soulData);
                this.updateUI();
                this.showStoryTransition();
            }

            returnToMenu() {
                document.getElementById('game-over-modal').classList.remove('active');
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('main-menu').classList.remove('hidden');
                this.updateMenuSoulDisplay();
            }

            // ==================== STAT GETTERS ====================

            getAttack() {
                let total = this.player.baseAttack;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.attack;
                if (this.player.equipment.armor) total += this.player.equipment.armor.attack;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.attack;
                this.buffs.forEach(b => { if (b.stat === 'attack') total += b.value; });
                return Math.max(1, total);
            }

            getDefense() {
                let total = this.player.baseDefense;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.defense;
                if (this.player.equipment.armor) total += this.player.equipment.armor.defense;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.defense;
                this.buffs.forEach(b => { if (b.stat === 'defense') total += b.value; });
                return Math.max(0, total);
            }

            getDodge() {
                let total = this.player.baseDodge;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.dodge;
                if (this.player.equipment.armor) total += this.player.equipment.armor.dodge;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.dodge;
                this.buffs.forEach(b => { if (b.stat === 'dodge') total += b.value; });
                return Math.min(50, Math.max(0, total));
            }

            getCrit() {
                let total = this.player.baseCrit;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.crit;
                if (this.player.equipment.armor) total += this.player.equipment.armor.crit;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.crit;
                this.buffs.forEach(b => { if (b.stat === 'crit') total += b.value; });
                return Math.min(60, Math.max(0, total));
            }

            getMaxHp() {
                let total = this.player.maxHp;
                if (this.player.equipment.weapon && this.player.equipment.weapon.hp) total += this.player.equipment.weapon.hp;
                if (this.player.equipment.armor && this.player.equipment.armor.hp) total += this.player.equipment.armor.hp;
                if (this.player.equipment.accessory && this.player.equipment.accessory.hp) total += this.player.equipment.accessory.hp;
                return total;
            }

            getFleeChance() {
                return Math.min(60, 25 + Math.floor(this.getDodge() * 0.6));
            }

            getGoldMultiplier() {
                return 1 + (this.getSoulBonuses().fortune / 100);
            }

            getSoulMultiplier() {
                return 1 + (this.getSoulBonuses().soulHarvest / 100);
            }

            getPotionMultiplier() {
                return 1 + (this.getSoulBonuses().potionMaster / 100);
            }

            // ==================== GAME FLOW ====================

            nextLevel() {
                if (this.level > 500) {
                    this.victory();
                    return;
                }

                this.buffs = this.buffs.filter(b => {
                    b.duration--;
                    return b.duration > 0;
                });

                this.lastBattleLog = null;
                this.isMimicFight = false;

                if (this.isNewArea() && this.level > 1) {
                    this.showAreaTransition();
                    return;
                }

                this.checkStoryDialogue();
                this.generateEvent();
                this.updateUI();
            }

            checkStoryDialogue() {
                const area = this.getAreaNumber();
                const dialogueKey = `area${area}`;
                
                if (STORY_DIALOGUES[dialogueKey] && !this.storyShown[dialogueKey] && 
                    this.level === AREAS[area - 1].startFloor) {
                    this.storyShown[dialogueKey] = true;
                }
            }

            generateEvent() {
                // Close tabs when generating new event
                this.closeAllTabs();
                
                if (this.isAreaBossFloor()) {
                    this.currentEvent = 'fight';
                    this.generateBoss();
                    return;
                }

                const areaNum = this.getAreaNumber();
                const bossFloor = areaNum * 50;
                if (this.level === bossFloor - 3) {
                    this.currentEvent = 'merchant';
                    this.generateMerchant();
                    return;
                }

                if (this.level % 10 === 0 && !this.isAreaBossFloor()) {
                    this.currentEvent = 'rest';
                    this.generateRestArea();
                    return;
                }

                const roll = Math.random() * 100;
                let cumulative = 0;
                for (const [event, data] of Object.entries(EVENTS)) {
                    cumulative += data.weight;
                    if (roll < cumulative) {
                        this.currentEvent = event;
                        break;
                    }
                }

                switch (this.currentEvent) {
                    case 'fight': this.generateMonster(); break;
                    case 'treasure': this.generateTreasureChoice(); break;
                    case 'merchant': this.generateMerchant(); break;
                    case 'event': this.generateRandomEvent(); break;
                    case 'rest': this.generateRestArea(); break;
                }
            }

            // ==================== REST AREA ====================

            generateRestArea() {
                const panel = document.getElementById('event-panel');
                const healAmount = Math.floor(this.getMaxHp() * 0.25);
                
                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">üèïÔ∏è</div>
                        <div><div class="event-title">ÂÆâÂÖ®ÂçÄÂüü</div></div>
                    </div>
                    <div class="event-content">
                        <div class="event-description">
                            ‰Ω†ÊâæÂà∞‰∫Ü‰∏ÄÂÄãÊö´ÊôÇÂÆâÂÖ®ÁöÑÂú∞ÊñπÔºåÂèØ‰ª•Á®ç‰Ωú‰ºëÊÅØ„ÄÇÈÄôË£°Êúâ‰∏ÄÂÄãÂ∞èÁáüÁÅ´Âíå‰∏Ä‰∫õË£úÁµ¶ÂìÅ„ÄÇ
                        </div>
                        <div class="treasure-display">
                            <div class="treasure-icon">üî•</div>
                            <p style="color: #4ecdc4">Âú®Ê≠§‰ºëÊÅØÂèØÊÅ¢Âæ© ${healAmount} ÈªûÁîüÂëΩ</p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="game.restHeal()">‰ºëÊÅØÊÅ¢Âæ©</button>
                        <button class="btn btn-primary" onclick="game.level++; game.nextLevel()">Áõ¥Êé•Èõ¢Èñã</button>
                    </div>
                `;
            }

            restHeal() {
                const healAmount = Math.floor(this.getMaxHp() * 0.25);
                this.player.hp = Math.min(this.player.hp + healAmount, this.getMaxHp());
                this.updateUI();
                this.level++;
                this.nextLevel();
            }

            // ==================== MONSTER SYSTEM ====================

            generateMonster() {
                this.inCombat = true;
                const areaNum = this.getAreaNumber();
                const monsterPool = MONSTERS_BY_AREA[areaNum] || MONSTERS_BY_AREA[1];
                const base = monsterPool[Math.floor(Math.random() * monsterPool.length)];

                const floorInArea = ((this.level - 1) % 50) + 1;
                const difficultyTier = Math.floor((floorInArea - 1) / 10);
                const buffPerTier = 0.125; 
                const scaling = 1 + (difficultyTier * buffPerTier);
                const HPscaling = 1 + (difficultyTier * (buffPerTier/2));

                const eliteChance = Math.min(0.18, 0.08 + (difficultyTier * 0.025));
                const isElite = Math.random() < eliteChance;
                const eliteMultiplier = isElite ? 1.5 : 1;

                this.currentMonster = {
                    ...base,
                    type: isElite ? 'elite' : 'normal',
                    hp: Math.floor(base.baseHp * HPscaling * eliteMultiplier),
                    maxHp: Math.floor(base.baseHp * HPscaling * eliteMultiplier),
                    attack: Math.floor(base.baseAtk * scaling * eliteMultiplier),
                    defense: Math.floor(base.baseDef * scaling * eliteMultiplier),
                    gold: Math.floor((base.goldMin + Math.random() * (base.goldMax - base.goldMin)) * scaling * this.getGoldMultiplier() * (isElite ? 1.5 : 1)),
                    dropChance: isElite ? 0.25 : 0.06,
                    matChance: base.matChance * (isElite ? 1.3 : 1),
                    soulReward: isElite ? 3 : 0
                };

                this.renderCombat();
            }

            generateMimic() {
                this.inCombat = true;
                this.isMimicFight = true;
                const areaNum = this.getAreaNumber();
                const mimicData = CHEST_MIMICS[areaNum];
                const monsterPool = MONSTERS_BY_AREA[areaNum] || MONSTERS_BY_AREA[1];
                
                // Base stats on area's strongest monster
                const baseMonster = monsterPool[monsterPool.length - 1];
                const floorInArea = ((this.level - 1) % 50) + 1;
                const scaling = 1 + (floorInArea - 1) * 0.02;

                this.currentMonster = {
                    name: mimicData.name,
                    emoji: mimicData.emoji,
                    type: 'elite',
                    hp: Math.floor(baseMonster.baseHp * scaling * mimicData.hpMult),
                    maxHp: Math.floor(baseMonster.baseHp * scaling * mimicData.hpMult),
                    attack: Math.floor(baseMonster.baseAtk * scaling * mimicData.atkMult),
                    defense: Math.floor(baseMonster.baseDef * scaling * mimicData.defMult),
                    gold: Math.floor((baseMonster.goldMax * 2) * scaling * this.getGoldMultiplier()),
                    dropChance: 0.6, // Higher drop chance for mimic
                    matChance: 0.7,
                    material: monsterPool[0].material,
                    soulReward: Math.floor(5 + areaNum)
                };

                // Store better loot for mimic
                this.mimicLootBonus = true;

                this.renderCombat();
            }

            generateBoss() {
                this.inCombat = true;
                const areaNum = this.getAreaNumber();
                const boss = AREA_BOSSES[areaNum];

                if (!boss) {
                    this.generateMonster();
                    return;
                }

                this.currentMonster = {
                    ...boss,
                    type: 'boss',
                    hp: boss.baseHp,
                    maxHp: boss.baseHp,
                    attack: boss.baseAtk,
                    defense: boss.baseDef,
                    gold: Math.floor((boss.goldMin + Math.random() * (boss.goldMax - boss.goldMin)) * this.getGoldMultiplier()),
                    dropChance: 0.85,
                    matChance: 1.0,
                    material: boss.material, 
                    soulReward: Math.floor(boss.soulReward * this.getSoulMultiplier())
                };

                this.renderCombat();
            }

            // ==================== COMBAT SYSTEM ====================

            performAttack() {
                // ‚úÖ FIX: Add debounce check
                if (!this.inCombat || !this.currentMonster || this.isActionLocked) return;
                
                // Lock actions
                this.isActionLocked = true;

                this.lastBattleLog = {
                    playerDamage: 0,
                    playerCrit: false,
                    monsterDamage: 0,
                    playerDodged: false,
                    potionUsed: null
                };

                const playerAttack = this.getAttack();
                const monsterDefense = this.currentMonster.defense;
                
                const isCrit = Math.random() * 100 < this.getCrit();
                const critMultiplier = isCrit ? 1.75 : 1;
                const baseDamage = Math.max(1, playerAttack - monsterDefense);
                const playerDamage = Math.floor(baseDamage * critMultiplier);
                
                this.currentMonster.hp -= playerDamage;
                this.lastBattleLog.playerDamage = playerDamage;
                this.lastBattleLog.playerCrit = isCrit;

                setTimeout(() => {
                    const monsterSprite = document.querySelector('.combatant.monster .combatant-sprite');
                    if (monsterSprite) monsterSprite.classList.add('attack-animation');
                    setTimeout(() => {
                        if (monsterSprite) monsterSprite.classList.remove('attack-animation');
                    }, 300);
                }, 100);

                if (this.currentMonster.hp <= 0) {
                    this.currentMonster.hp = 0;
                    this.renderCombat();
                    setTimeout(() => {
                        this.isActionLocked = false; // ‚úÖ Unlock after victory
                        this.monsterDefeated();
                    }, 500);
                    return;
                }

                this.monsterAttack();
            }

            monsterAttack() {
                const playerDodge = this.getDodge();
                
                if (Math.random() * 100 < playerDodge) {
                    this.lastBattleLog.playerDodged = true;
                    this.lastBattleLog.monsterDamage = 0;
                } else {
                    const playerDefense = this.getDefense();
                    const monsterAttack = this.currentMonster.attack;
                    
                    const monsterDamage = Math.max(1, monsterAttack - playerDefense);
                    this.player.hp -= monsterDamage;
                    this.lastBattleLog.monsterDamage = monsterDamage;

                    document.querySelector('.hp-section').classList.add('shake');
                    setTimeout(() => document.querySelector('.hp-section').classList.remove('shake'), 500);
                }

                if (this.player.hp <= 0) {
                    const secondChance = this.getSoulBonuses().secondChance;
                    if (secondChance > 0 && Math.random() * 100 < secondChance) {
                        this.player.hp = 1;
                        this.lastBattleLog.secondChance = true;
                    } else {
                        this.player.hp = 0;
                        this.renderCombat();
                        setTimeout(() => {
                            this.isActionLocked = false; // ‚úÖ Unlock after game over
                            this.gameOver();
                        }, 500);
                        return;
                    }
                }

                this.updateUI();
                this.renderCombat();
                
                // ‚úÖ FIX: Unlock actions after a short delay
                setTimeout(() => {
                    this.isActionLocked = false;
                }, 400);
            }

            monsterDefeated() {
                this.inCombat = false;
                const monster = this.currentMonster;
                
                // Better loot for mimic
                const rarityBoost = this.mimicLootBonus ? 0.35 : (monster.type === 'boss' ? 0.4 : (monster.type === 'elite' ? 0.2 : 0));
                
                this.pendingLoot = {
                    gold: monster.gold,
                    material: null,
                    equipment: null,
                    souls: monster.soulReward || 0,
                    potion: null
                };

                if (Math.random() < monster.matChance && monster.material && MATERIALS[monster.material]) {
                    this.pendingLoot.material = {
                        key: monster.material,
                        ...MATERIALS[monster.material]
                    };
                }

                if (Math.random() < monster.dropChance) {
                    this.pendingLoot.equipment = this.generateEquipmentDrop(rarityBoost);
                }

                const potionChance = monster.type === 'boss' ? 0.9 : (monster.type === 'elite' ? 0.35 : 0.15);
                if (Math.random() < potionChance) {
                    const areaNum = this.getAreaNumber();
                    const potionRoll = Math.random();
                    if (areaNum >= 8 && potionRoll < 0.1) this.pendingLoot.potion = 'full';
                    else if (areaNum >= 5 && potionRoll < 0.3) this.pendingLoot.potion = 'large';
                    else if (areaNum >= 3 && potionRoll < 0.5) this.pendingLoot.potion = 'medium';
                    else this.pendingLoot.potion = 'small';
                }

                if (this.pendingLoot.souls > 0) {
                    this.soulGainedThisRun += this.pendingLoot.souls;
                }

                if (this.level > this.soulData.bestFloor) {
                    this.soulData.bestFloor = this.level;
                }
                if (monster.type === 'boss') {
                    this.soulData.bossesKilled++;
                }
                saveSoulData(this.soulData);

                this.mimicLootBonus = false;

                if (this.level === 500 && monster.type === 'boss') {
                    this.renderFinalVictory();
                } else {
                    this.renderVictory();
                }
            }

            collectLoot() {
                if (!this.pendingLoot) return;

                this.player.gold += this.pendingLoot.gold;
                
                if (this.pendingLoot.material) {
                    const matKey = this.pendingLoot.material.key;
                    this.player.materials[matKey] = (this.player.materials[matKey] || 0) + 1;
                }

                if (this.pendingLoot.equipment && this.player.bag.length < 20) {
                    this.player.bag.push(this.pendingLoot.equipment);
                }

                if (this.pendingLoot.potion) {
                    this.player.potions[this.pendingLoot.potion]++;
                }

                this.pendingLoot = null;
                this.level++;
                this.updateUI();
                this.nextLevel();
            }

            tryFlee() {
                // ‚úÖ FIX: Add debounce check
                if (this.isActionLocked) return;
                this.isActionLocked = true;
                
                const fleeChance = this.getFleeChance();
                if (Math.random() * 100 < fleeChance) {
                    this.inCombat = false;
                    this.isMimicFight = false;
                    this.isActionLocked = false; // ‚úÖ Unlock on success
                    this.renderFleeSuccess();
                } else {
                    this.lastBattleLog = {
                        playerDamage: 0,
                        playerCrit: false,
                        monsterDamage: 0,
                        playerDodged: false,
                        fleeFailed: true
                    };
                    this.monsterAttack();
                }
            }

            // ==================== POTION SYSTEM ====================

            usePotion(type) {
                if (!this.player.potions[type] || this.player.potions[type] <= 0) return;
                
                const maxHp = this.getMaxHp();
                if (this.player.hp >= maxHp) return;

                const potion = POTION_TYPES[type];
                const healAmount = Math.floor(maxHp * potion.healPercent * this.getPotionMultiplier());
                
                this.player.potions[type]--;
                this.player.hp = Math.min(this.player.hp + healAmount, maxHp);
                
                if (this.lastBattleLog) {
                    this.lastBattleLog.potionUsed = { type, healAmount };
                }

                this.updateUI();
                
                if (this.inCombat) {
                    this.renderCombat();
                }
            }

            // ==================== EQUIPMENT SYSTEM ====================

            generateEquipmentDrop(rarityBoost = 0) {
                const types = ['weapons', 'armor', 'accessories'];
                const type = types[Math.floor(Math.random() * types.length)];
                const pool = EQUIPMENT[type];

                let rarityRoll = (Math.random() * 100) - (rarityBoost * 100);
                let targetRarity;
                
                const areaNum = this.getAreaNumber();
                
                if (areaNum >= 9) {
                    // Areas 9-10 (Endgame): High chance of good gear
                    if (rarityRoll < 1) targetRarity = 'legendary';
                    else if (rarityRoll < 15) targetRarity = 'epic';
                    else if (rarityRoll < 50) targetRarity = 'rare';
                    else targetRarity = 'uncommon';
                } else if (areaNum >= 7) {
                    // Areas 7-8: Legendaries become possible (very rare)
                    if (rarityRoll < 0.5) targetRarity = 'legendary';
                    else if (rarityRoll < 10) targetRarity = 'epic';
                    else if (rarityRoll < 50) targetRarity = 'rare';
                    else targetRarity = 'uncommon';
                } else if (areaNum >= 5) {
                    // Areas 5-6: Epics become possible
                    if (rarityRoll < 5) targetRarity = 'epic';
                    else if (rarityRoll < 30) targetRarity = 'rare';
                    else if (rarityRoll < 40) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                } else if (areaNum >= 3) {
                    // Areas 3-4: Rares become accessible
                    if (rarityRoll < 10) targetRarity = 'rare';
                    else if (rarityRoll < 40) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                } else if (areaNum >= 2) {
                    // Area 2: Mostly Common/Uncommon
                    if (rarityRoll < 20) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                } else {
                    // Area 1: Strictly Common/Uncommon
                    if (rarityRoll < 5) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                }

                // Fallback: If we selected a rarity that doesn't exist in the list (safety check)
                // Filter items by the chosen rarity
                let candidates = pool.filter(item => item.rarity === targetRarity);
                
                // If no items of that rarity exist (shouldn't happen with correct config), fallback to common
                if (candidates.length === 0) {
                    candidates = pool.filter(item => item.rarity === 'common');
                }

                const item = candidates[Math.floor(Math.random() * candidates.length)];

                return { 
                    ...item, 
                    type: type === 'weapons' ? 'weapon' : type === 'armor' ? 'armor' : 'accessory',
                    id: Date.now() + Math.random()
                };
            }

            showEquipCompare(index) {
                this.selectedBagIndex = index;
                const newItem = this.player.bag[index];
                const currentItem = this.player.equipment[newItem.type];

                const container = document.getElementById('equip-compare-container');
                
                const getStatChange = (stat, newVal, oldVal) => {
                    const diff = newVal - oldVal;
                    if (diff > 0) return `<span class="stat-change positive">+${diff}</span>`;
                    if (diff < 0) return `<span class="stat-change negative">${diff}</span>`;
                    return '';
                };

                const currentStats = currentItem ? {
                    attack: currentItem.attack,
                    defense: currentItem.defense,
                    dodge: currentItem.dodge,
                    crit: currentItem.crit,
                    hp: currentItem.hp || 0
                } : { attack: 0, defense: 0, dodge: 0, crit: 0, hp: 0 };

                container.innerHTML = `
                    <div class="equip-card current">
                        <div class="equip-card-label">ÁõÆÂâçË£ùÂÇô</div>
                        <div class="equip-card-name ${currentItem ? currentItem.rarity : ''}" style="color: ${currentItem ? this.getRarityColor(currentItem.rarity) : '#555'}">
                            ${currentItem ? currentItem.name : 'ÁÑ°'}
                        </div>
                        ${currentItem ? `
                            <div class="equip-card-stats">
                                <div class="stat-line"><span>‚öîÔ∏è ÊîªÊìä</span><span>${currentStats.attack}</span></div>
                                <div class="stat-line"><span>üõ°Ô∏è Èò≤Á¶¶</span><span>${currentStats.defense}</span></div>
                                <div class="stat-line"><span>üí® ÈñÉÈÅø</span><span>${currentStats.dodge}%</span></div>
                                <div class="stat-line"><span>üí• ÁàÜÊìä</span><span>${currentStats.crit}%</span></div>
                                ${currentStats.hp ? `<div class="stat-line"><span>‚ù§Ô∏è ÁîüÂëΩ</span><span>${currentStats.hp}</span></div>` : ''}
                            </div>
                        ` : '<div class="equip-card-stats" style="color:#555">Á©∫</div>'}
                    </div>
                    <div class="compare-arrow">‚û°Ô∏è</div>
                    <div class="equip-card new ${newItem.rarity}">
                        <div class="equip-card-label">Êñ∞Ë£ùÂÇô</div>
                        <div class="equip-card-name" style="color: ${this.getRarityColor(newItem.rarity)}">
                            ${newItem.name}
                        </div>
                        <div class="equip-card-stats">
                            <div class="stat-line">
                                <span>‚öîÔ∏è ÊîªÊìä</span>
                                <span>${newItem.attack} ${getStatChange('attack', newItem.attack, currentStats.attack)}</span>
                            </div>
                            <div class="stat-line">
                                <span>üõ°Ô∏è Èò≤Á¶¶</span>
                                <span>${newItem.defense} ${getStatChange('defense', newItem.defense, currentStats.defense)}</span>
                            </div>
                            <div class="stat-line">
                                <span>üí® ÈñÉÈÅø</span>
                                <span>${newItem.dodge}% ${getStatChange('dodge', newItem.dodge, currentStats.dodge)}</span>
                            </div>
                            <div class="stat-line">
                                <span>üí• ÁàÜÊìä</span>
                                <span>${newItem.crit}% ${getStatChange('crit', newItem.crit, currentStats.crit)}</span>
                            </div>
                            ${newItem.hp ? `
                                <div class="stat-line">
                                    <span>‚ù§Ô∏è ÁîüÂëΩ</span>
                                    <span>${newItem.hp} ${getStatChange('hp', newItem.hp, currentStats.hp)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                document.getElementById('equip-confirm-btn').onclick = () => {
                    this.equipFromBag(this.selectedBagIndex);
                    this.closeEquipCompare();
                };

                document.getElementById('equip-discard-btn').onclick = () => {
                    this.discardFromBag(this.selectedBagIndex);
                    this.closeEquipCompare();
                };

                document.getElementById('equip-compare-modal').classList.remove('hidden');
            }

            closeEquipCompare() {
                document.getElementById('equip-compare-modal').classList.add('hidden');
                this.selectedBagIndex = -1;
            }

            equipFromBag(index) {
                if (index < 0 || index >= this.player.bag.length) return;
                
                const item = this.player.bag[index];
                const currentEquip = this.player.equipment[item.type];
                
                const oldMaxHp = this.getMaxHp();
                
                this.player.equipment[item.type] = item;
                this.player.bag.splice(index, 1);
                
                if (currentEquip && this.player.bag.length < 20) {
                    this.player.bag.push(currentEquip);
                }
                
                const newMaxHp = this.getMaxHp();
                if (newMaxHp > oldMaxHp) {
                    this.player.hp += (newMaxHp - oldMaxHp);
                } else if (this.player.hp > newMaxHp) {
                    this.player.hp = newMaxHp;
                }
                
                this.updateUI();
            }

            discardFromBag(index) {
                if (index < 0 || index >= this.player.bag.length) return;
                
                const item = this.player.bag[index];
                
                // ‚úÖ FIX: Add confirmation for rare+ equipment
                if (item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary') {
                    const rarityName = RARITY_NAMES[item.rarity];
                    if (!confirm(`‚ö†Ô∏è Á¢∫ÂÆöË¶Å‰∏üÊ£Ñ„Äê${rarityName}„Äë${item.name} ÂóéÔºü\n\nÈÄôÂÄãÂãï‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                        return;
                    }
                }
                
                this.player.bag.splice(index, 1);
                this.updateUI();
            }

            // ==================== TREASURE SYSTEM ====================

            generateTreasureChoice() {
                const panel = document.getElementById('event-panel');
                const areaNum = this.getAreaNumber();
                const mimicData = CHEST_MIMICS[areaNum];

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">üíé</div>
                        <div><div class="event-title">ÁôºÁèæÂØ∂ÁÆ±ÔºÅ</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                            <div class="treasure-icon">üì¶</div>
                            <p>‰Ω†ÁôºÁèæ‰∫Ü‰∏ÄÂÄãÁ•ûÁßòÁöÑÂØ∂ÁÆ±ÔºÅ</p>
                            <p style="color: #aaa; font-size: 0.8rem; margin-top: 8px;">‰Ω†ÂèØ‰ª•ÈÅ∏ÊìáÂÆâÂÖ®Âú∞ÊâìÈñãÔºåÊàñËÄÖÂòóË©¶Âº∑Ë°åÊí¨ÈñãÁç≤ÂèñÊõ¥Â§öÂØ∂Áâ©...</p>
                        </div>
                        <div class="chest-choice">
                            <div class="chest-option safe" onclick="game.openChestSafe()">
                                <div class="option-icon">üîì</div>
                                <div class="option-title">ÂÆâÂÖ®ÈñãÂïü</div>
                                <div class="option-desc">Áç≤ÂæóÊôÆÈÄöÂØ∂Áâ©</div>
                            </div>
                            <div class="chest-option risky" onclick="game.openChestRisky()">
                                <div class="option-icon">‚ö†Ô∏è</div>
                                <div class="option-title">Âº∑Ë°åÊí¨Èñã</div>
                                <div class="option-desc">ÂèØËÉΩÊòØ ${mimicData.name}ÔºÅ<br>‰ΩÜÊà∞ÂãùÂæåÁçéÂãµÊõ¥Ë±êÂéö</div>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="game.skipTreasure()">Èõ¢ÈñãÂØ∂ÁÆ±</button>
                    </div>
                `;
            }

            openChestSafe() {
                const goldAmount = Math.floor((20 + this.level * 0.4 + Math.random() * 30) * this.getGoldMultiplier());
                const hasEquipment = Math.random() < 0.30;
                const equipment = hasEquipment ? this.generateEquipmentDrop(0.05) : null;
                
                let potion = null;
                if (Math.random() < 0.40) {
                    const areaNum = this.getAreaNumber();
                    const potionRoll = Math.random();
                    if (areaNum >= 7 && potionRoll < 0.15) potion = 'large';
                    else if (areaNum >= 4 && potionRoll < 0.35) potion = 'medium';
                    else potion = 'small';
                }

                this.pendingLoot = {
                    gold: goldAmount,
                    equipment: equipment,
                    material: null,
                    potion: potion,
                    souls: 0
                };

                this.renderTreasure();
            }

            openChestRisky() {
                // 40% chance of mimic
                if (Math.random() < 0.55) {
                    this.generateMimic();
                } else {
                    // Better loot for risky choice
                    const goldAmount = Math.floor((40 + this.level * 0.6 + Math.random() * 50) * this.getGoldMultiplier());
                    const hasEquipment = Math.random() < 0.30;
                    const equipment = hasEquipment ? this.generateEquipmentDrop(0.15) : null;
                    
                    let potion = null;
                    if (Math.random() < 0.60) {
                        const areaNum = this.getAreaNumber();
                        const potionRoll = Math.random();
                        if (areaNum >= 6 && potionRoll < 0.25) potion = 'large';
                        else if (areaNum >= 3 && potionRoll < 0.50) potion = 'medium';
                        else potion = 'small';
                    }

                    // Chance for souls
                    const souls = Math.random() < 0.3 ? Math.floor(2 + this.getAreaNumber() * 0.5) : 0;

                    this.pendingLoot = {
                        gold: goldAmount,
                        equipment: equipment,
                        material: null,
                        potion: potion,
                        souls: souls
                    };

                    if (souls > 0) {
                        this.soulGainedThisRun += souls;
                    }

                    this.renderTreasure();
                }
            }

            skipTreasure() {
                this.level++;
                this.nextLevel();
            }

            renderTreasure() {
                const panel = document.getElementById('event-panel');
                const loot = this.pendingLoot;

                let rewardsHtml = `<p style="color: #ffd700; font-size: 1.1rem; margin: 10px 0">üí∞ +${loot.gold} ÈáëÂπ£</p>`;
                
                if (loot.potion) {
                    const potion = POTION_TYPES[loot.potion];
                    rewardsHtml += `<p style="color: #4ecdc4; font-size: 0.9rem">${potion.emoji} ${potion.name}</p>`;
                }

                if (loot.souls > 0) {
                    rewardsHtml += `<p style="color: #c084fc; font-size: 0.9rem">üíé ${loot.souls} ÈùàÈ≠ÇÁ¢éÁâá</p>`;
                }

                if (loot.equipment) {
                    rewardsHtml += `
                        <div class="shop-item ${loot.equipment.rarity}" style="margin-top: 10px; cursor: default; max-width: 250px; margin-left: auto; margin-right: auto;">
                            <div class="shop-item-header">
                                <span class="shop-item-name slot-name ${loot.equipment.rarity}">${loot.equipment.name}</span>
                                <span class="shop-item-rarity ${loot.equipment.rarity}">${RARITY_NAMES[loot.equipment.rarity]}</span>
                            </div>
                            <div class="shop-item-description">
                                ${SLOT_NAMES[loot.equipment.type]} | ‚öîÔ∏è${loot.equipment.attack} üõ°Ô∏è${loot.equipment.defense} üí®${loot.equipment.dodge}% üí•${loot.equipment.crit}% ${loot.equipment.hp ? `‚ù§Ô∏è${loot.equipment.hp}` : ''}
                            </div>
                        </div>
                    `;
                }

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${EVENTS.treasure.icon}</div>
                        <div><div class="event-title">${EVENTS.treasure.title}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                            <div class="treasure-icon">üì¶</div>
                            <div class="treasure-rewards">
                                <p>ÂØ∂ÁÆ±ÊâìÈñã‰∫ÜÔºÅ</p>
                                ${rewardsHtml}
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.collectLoot()">Êî∂ÈõÜ</button>
                    </div>
                `;
            }

            // ==================== MERCHANT SYSTEM ====================

            generateMerchant() {
                this.merchantItems = [];
                const areaNum = this.getAreaNumber();
                const priceMultiplier = 1 + (areaNum * 0.15); // Increased price scaling

                const potionTypes = ['small', 'medium'];
                if (areaNum >= 4) potionTypes.push('large');
                if (areaNum >= 7) potionTypes.push('full');

                potionTypes.forEach(type => {
                    const potion = POTION_TYPES[type];
                    const healAmount = Math.floor(this.getMaxHp() * potion.healPercent * this.getPotionMultiplier());
                    this.merchantItems.push({
                        shopType: 'potion',
                        potionType: type,
                        name: potion.name,
                        emoji: potion.emoji,
                        description: `ÊÅ¢Âæ© ${healAmount} ÈªûÁîüÂëΩ (${Math.floor(potion.healPercent * 100)}%)`,
                        price: Math.floor(potion.basePrice * priceMultiplier)
                    });
                });

                const equipCount = 2 + Math.floor(Math.random() * 3);
                for (let i = 0; i < equipCount; i++) {
                    //const rarityBoost = areaNum > 6 ? 0.25 : (areaNum > 3 ? 0.15 : 0.05);
                    //const equip = this.generateEquipmentDrop(rarityBoost);
                    const equip = this.generateEquipmentDrop(0); 
                    equip.price = this.calculateEquipmentPrice(equip);
                    this.merchantItems.push({
                        shopType: 'equipment',
                        ...equip
                    });
                }

                this.renderMerchant();
            }

            calculateEquipmentPrice(equip) {
                const rarityMultiplier = {
                    common: 1,
                    uncommon: 3,
                    rare: 8,
                    epic: 20,
                    legendary: 50
                };
                const statValue = equip.attack + equip.defense + equip.dodge + equip.crit + (equip.hp || 0) * 0.2;
                const areaNum = this.getAreaNumber();
                return Math.floor((50 + statValue * 4) * rarityMultiplier[equip.rarity]);
            }

            buyItem(index) {
                const item = this.merchantItems[index];
                if (!item || this.player.gold < item.price) return;

                if (item.shopType === 'potion') {
                    this.player.gold -= item.price;
                    this.player.potions[item.potionType]++;
                } else if (item.shopType === 'equipment') {
                    if (this.player.bag.length < 20) {
                        this.player.gold -= item.price;
                        
                        const equipCopy = { 
                            name: item.name,
                            rarity: item.rarity,
                            attack: item.attack,
                            defense: item.defense,
                            dodge: item.dodge,
                            crit: item.crit,
                            hp: item.hp || 0,
                            type: item.type,
                            id: Date.now() + Math.random()
                        };
                        
                        this.player.bag.push(equipCopy);
                    } else {
                        return;
                    }
                }

                this.merchantItems.splice(index, 1);
                this.updateUI();
                this.renderMerchant();
            }

            sellMaterial(matKey) {
                if (!this.player.materials[matKey] || this.player.materials[matKey] <= 0) return;
                
                const mat = MATERIALS[matKey];
                const areaNum = this.getAreaNumber();
                const price = Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier());
                
                this.player.materials[matKey]--;
                if (this.player.materials[matKey] <= 0) {
                    delete this.player.materials[matKey];
                }
                
                this.player.gold += price;
                this.updateUI();
                this.renderMerchant();
            }

            sellAllMaterials() {
                const matKeys = Object.keys(this.player.materials);
                if (matKeys.length === 0) return;

                let totalGold = 0;
                const areaNum = this.getAreaNumber();

                matKeys.forEach(key => {
                    const mat = MATERIALS[key];
                    const count = this.player.materials[key];
                    const price = Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier());
                    totalGold += price * count;
                });

                this.player.materials = {};
                this.player.gold += totalGold;
                this.updateUI();
                this.renderMerchant();
            }

            sellEquipFromBag(index) {
                if (index < 0 || index >= this.player.bag.length) return;
                
                const item = this.player.bag[index];
                const price = Math.floor(this.calculateEquipmentPrice(item) * 0.35);
                
                // ‚úÖ FIX: Add confirmation for rare+ equipment
                if (item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary') {
                    const rarityName = RARITY_NAMES[item.rarity];
                    if (!confirm(`‚ö†Ô∏è Á¢∫ÂÆöË¶ÅË≥£Êéâ„Äê${rarityName}„Äë${item.name} ÂóéÔºü\n\nÂîÆÂÉπ: ${price} ÈáëÂπ£\nÈÄôÂÄãÂãï‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) {
                        return;
                    }
                }
                
                this.player.bag.splice(index, 1);
                this.player.gold += price;
                this.updateUI();
                this.renderMerchant();
            }

            // ==================== RANDOM EVENT SYSTEM ====================

            generateRandomEvent() {
                const areaNum = this.getAreaNumber();
                // Fallback to Area 1 events if something goes wrong
                const pool = AREA_EVENTS[areaNum] || AREA_EVENTS[1];
                
                const event = pool[Math.floor(Math.random() * pool.length)];
                this.currentRandomEvent = event;

                const panel = document.getElementById('event-panel');
                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${event.icon}</div>
                        <div><div class="event-title">${event.name}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="event-description" style="font-size: 1rem; color: #ddd; padding: 10px;">
                            ${event.description}
                        </div>
                        <div style="text-align: center; color: #888; font-size: 0.8rem; margin-top: 10px;">
                            (ÁµêÊûúÊú™Áü•ÔºåÂèØËÉΩÁç≤ÂæóÁçéÂãµÊàñÊá≤ÁΩ∞)
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="game.resolveRandomEvent()">ü§î Êé¢Á¥¢ (Ë≥≠ÈÅãÊ∞£)</button>
                        <button class="btn btn-secondary" onclick="game.skipRandomEvent()">üèÉ Áõ¥Êé•Èõ¢Èñã</button>
                    </div>
                `;
            }

            resolveRandomEvent() {
                // Call the resolve function defined in the event object
                const result = this.currentRandomEvent.resolve(this);
                
                const panel = document.getElementById('event-panel');
                
                // Determine color based on result type
                let color = '#ffd700'; // Default
                if (result.type === 'positive') color = '#4ecdc4'; // Green/Teal
                if (result.type === 'negative') color = '#e94560'; // Red

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${this.currentRandomEvent.icon}</div>
                        <div><div class="event-title">${this.currentRandomEvent.name}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                             <!-- Result Animation Icon -->
                            <div class="treasure-icon" style="font-size: 3rem; margin-bottom: 15px">
                                ${result.type === 'positive' ? '‚ú®' : 'üí¢'}
                            </div>
                            <p style="font-size: 1.1rem; color: ${color}; font-weight: bold; line-height: 1.6;">
                                ${result.text}
                            </p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.level++; game.nextLevel()">ÁπºÁ∫åÂÜíÈö™</button>
                    </div>
                `;

                if (this.player.hp <= 0) {
                    // Slight delay to read text before game over
                    setTimeout(() => this.gameOver(), 1500);
                } else {
                    this.updateUI();
                }
            }

            skipRandomEvent() {
                this.level++;
                this.nextLevel();
            }

            // ==================== BUFF SYSTEM ====================

            addBuff(name, duration, stat, value, type) {
                this.buffs = this.buffs.filter(b => b.name !== name);
                this.buffs.push({ name, duration, stat, value, type });
                this.updateUI();
            }

            // ==================== RENDER METHODS ====================

            renderCombat() {
                const panel = document.getElementById('event-panel');
                const monster = this.currentMonster;
                const typeText = monster.type === 'elite' ? '‚≠ê Á≤æËã±' : monster.type === 'boss' ? 'üëë È¶ñÈ†ò' : '';
                const fleeChance = this.getFleeChance();

                let battleLogHtml = '';
                if (this.lastBattleLog) {
                    const log = this.lastBattleLog;
                    battleLogHtml = `<div class="battle-log">`;
                    
                    if (log.fleeFailed) {
                        battleLogHtml += `<div class="battle-log-entry" style="color: #888;">ÈÄÉË∑ëÂ§±ÊïóÔºÅ</div>`;
                    }
                    
                    if (log.playerDamage > 0) {
                        if (log.playerCrit) {
                            battleLogHtml += `<div class="battle-log-entry player-crit">üí• ÁàÜÊìäÔºÅ‰Ω†ÈÄ†Êàê <span class="damage-number">${log.playerDamage}</span> ÂÇ∑ÂÆ≥</div>`;
                        } else {
                            battleLogHtml += `<div class="battle-log-entry player-attack">‚öîÔ∏è ‰Ω†ÈÄ†Êàê <span class="damage-number">${log.playerDamage}</span> ÂÇ∑ÂÆ≥</div>`;
                        }
                    }
                    
                    if (log.playerDodged) {
                        battleLogHtml += `<div class="battle-log-entry dodge">üí® ‰Ω†ÈñÉÈÅø‰∫ÜÊîªÊìäÔºÅ</div>`;
                    } else if (log.monsterDamage > 0) {
                        battleLogHtml += `<div class="battle-log-entry monster-attack">üí¢ ${monster.name} ÈÄ†Êàê <span class="damage-number">${log.monsterDamage}</span> ÂÇ∑ÂÆ≥</div>`;
                    }
                    
                    if (log.secondChance) {
                        battleLogHtml += `<div class="battle-log-entry heal">üí´ ‰∏çÊ≠ªÊ±∫ÂøÉÔºÅ‰Ω†Â≠òÊ¥ª‰∫Ü‰∏ã‰æÜÔºÅ</div>`;
                    }
                    
                    if (log.potionUsed) {
                        battleLogHtml += `<div class="battle-log-entry heal">üíä ‰ΩøÁî®Ëó•Ê∞¥ÊÅ¢Âæ© <span class="damage-number">${log.potionUsed.healAmount}</span> ÁîüÂëΩ</div>`;
                    }
                    
                    battleLogHtml += `</div>`;
                }

                let bossDialogue = '';
                if (monster.type === 'boss' && !this.lastBattleLog) {
                    const bossDialogues = {
                        1: '„ÄåÂìºÔºå‰Ω†Á´üÊï¢ÈóñÂÖ•ÊàëÁöÑÈ†òÂú∞ÔºÅ„Äç',
                        2: '„ÄåÈÄôË£°Â∞áÊòØ‰Ω†ÁöÑËë¨Ë∫´‰πãÂú∞ÔºÅ„Äç',
                        3: '„ÄåÊ¥ª‰∫∫ÔºüÂú®ÊàëÁöÑÂ¢ìÂú∞ÔºüÂèóÊ≠ªÂêßÔºÅ„Äç',
                        4: '„ÄåÊ£ÆÊûóÁöÑÊÄíÁÅ´Â∞áÂêûÂô¨‰Ω†ÔºÅ„Äç',
                        5: '„ÄåÊàêÁÇ∫ÊàëÊñ∞ÂØ¶È©óÁöÑÊùêÊñôÂêßÔºÅ„Äç',
                        6: '„ÄåÊ∏∫Â∞èÁöÑ‰∫∫È°ûÔºåË∑™‰∏ãÔºÅ„Äç',
                        7: '„ÄåËÆìÂØíÂÜ∞ÂáçÁµê‰Ω†ÁöÑÈùàÈ≠ÇÔºÅ„Äç',
                        8: '„ÄåÂú®ÁÉàÁÑ∞‰∏≠ÂåñÁÇ∫ÁÅ∞ÁáºÂêßÔºÅ„Äç',
                        9: '„ÄåËôõÁ©∫Â∞áÂêûÂô¨‰∏ÄÂàáÔºÅ„Äç',
                        10: '„ÄåÂÖ¨‰∏ªÊòØÊàëÁöÑÔºÅ‰Ω†ÂéªÊ≠ªÂêßÔºÅ„Äç'
                    };
                    const areaNum = this.getAreaNumber();
                    if (bossDialogues[areaNum]) {
                        bossDialogue = `
                            <div class="dialog-box" style="margin-bottom: 10px;">
                                <div class="dialog-speaker">${monster.name}</div>
                                <div class="dialog-text">${bossDialogues[areaNum]}</div>
                            </div>
                        `;
                    }
                }

                // Mimic dialogue
                let mimicDialogue = '';
                if (this.isMimicFight && !this.lastBattleLog) {
                    mimicDialogue = `
                        <div class="dialog-box" style="margin-bottom: 10px; border-left-color: #e94560;">
                            <div class="dialog-speaker" style="color: #e94560;">${monster.name}</div>
                            <div class="dialog-text">„ÄåÂòøÂòøÂòø...ÂèàÊúâ‰∫∫‰∏äÁï∂‰∫ÜÔºÅ„Äç</div>
                        </div>
                    `;
                }

                const eventTitle = this.isMimicFight ? '‚ö†Ô∏è ÂØ∂ÁÆ±ÊÄ™ÔºÅ' : (monster.type === 'boss' ? '‚ö†Ô∏è È¶ñÈ†òÊà∞ÔºÅ' : EVENTS.fight.title);

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${monster.type === 'boss' ? 'üëë' : (this.isMimicFight ? 'üì¶' : '‚öîÔ∏è')}</div>
                        <div>
                            <div class="event-title">${eventTitle}</div>
                        </div>
                    </div>
                    <div class="event-content">
                        ${bossDialogue}
                        ${mimicDialogue}
                        <div class="battle-arena" style="justify-content: center;">
                            <div class="combatant monster" style="max-width: 80%;">
                                <div class="combatant-sprite" style="font-size: 4rem;">${monster.emoji}</div>
                                <div class="combatant-name ${monster.type}" style="font-size: 1.1rem;">${typeText} ${monster.name}</div>
                                <div class="combatant-hp-bar" style="height: 16px; margin-top: 5px;">
                                    <div class="combatant-hp-fill" style="width: ${Math.max(0, (monster.hp / monster.maxHp) * 100)}%"></div>
                                </div>
                                <div class="combatant-hp-text" style="font-size: 0.9rem;">${Math.max(0, monster.hp)} / ${monster.maxHp}</div>
                                <div class="combatant-stats" style="font-size: 0.8rem;">‚öîÔ∏è${monster.attack} üõ°Ô∏è${monster.defense}</div>
                            </div>
                        </div>
                        ${battleLogHtml}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.performAttack()" ${monster.hp <= 0 ? 'disabled' : ''}>‚öîÔ∏è ÊîªÊìä</button>
                        ${monster.type !== 'boss' ? `
                            <button class="btn btn-danger" onclick="game.tryFlee()" ${monster.hp <= 0 ? 'disabled' : ''}>
                                üèÉ ÈÄÉË∑ë
                                <span class="flee-info">(${fleeChance}%)</span>
                            </button>
                        ` : ''}
                    </div>
                `;
            }

            renderVictory() {
                const panel = document.getElementById('event-panel');
                const loot = this.pendingLoot;
                const monster = this.currentMonster;
                
                let lootHtml = '';
                if (loot) {
                    lootHtml = `<div class="loot-display">
                        <div class="loot-title">üéÅ Êà∞Âà©ÂìÅ</div>
                        <div class="loot-items">
                            <div class="loot-item"><span style="color:#ffd700">üí∞ ${loot.gold}</span></div>
                            ${loot.material && loot.material.name ? `
                                <div class="loot-item" style="border-left: 2px solid ${this.getRarityColor(loot.material.rarity || 'common')}">
                                    <span style="color: ${this.getRarityColor(loot.material.rarity || 'common')}">${loot.material.emoji} ${loot.material.name}</span>
                                    ${loot.material.rarity && loot.material.rarity !== 'common' ? `<span class="shop-item-rarity ${loot.material.rarity}">${RARITY_NAMES[loot.material.rarity]}</span>` : ''}
                                </div>
                            ` : ''}
                            ${loot.equipment ? `<div class="loot-item" style="border-left: 2px solid ${this.getRarityColor(loot.equipment.rarity)}"><span class="slot-name ${loot.equipment.rarity}">${loot.equipment.name}</span><span class="shop-item-rarity ${loot.equipment.rarity}">${RARITY_NAMES[loot.equipment.rarity]}</span></div>` : ''}
                            ${loot.potion ? `<div class="loot-item"><span>${POTION_TYPES[loot.potion].emoji} ${POTION_TYPES[loot.potion].name}</span></div>` : ''}
                            ${loot.souls > 0 ? `<div class="loot-item"><span style="color:#c084fc">üíé ${loot.souls} ÈùàÈ≠ÇÁ¢éÁâá</span></div>` : ''}
                        </div>
                    </div>`;
                }

                const victoryTitle = this.isMimicFight ? 'ÂØ∂ÁÆ±ÊÄ™Ë¢´ÊìäÊïóÔºÅ' : 'ÂãùÂà©ÔºÅ';

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">üèÜ</div>
                        <div><div class="event-title">${victoryTitle}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display" style="padding: 10px">
                            <div class="treasure-icon" style="font-size: 2.5rem">${monster.emoji}</div>
                            <p>ÊìäÊïó‰∫Ü ${monster.name}ÔºÅ</p>
                        </div>
                        ${lootHtml}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.collectLoot()">Êî∂ÈõÜÊà∞Âà©ÂìÅ</button>
                    </div>
                `;
            }

            renderFinalVictory() {
                const panel = document.getElementById('event-panel');
                const loot = this.pendingLoot;
                const dialogue = STORY_DIALOGUES.bossDefeat;

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">üéâ</div>
                        <div><div class="event-title">È≠îÁéãË¢´ÊâìÊïó‰∫ÜÔºÅ</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display" style="padding: 10px">
                            <div class="princess-sprite">üë∏</div>
                            <p style="color: #ffd700; font-size: 1.1rem; margin-top: 10px;">ÂÖ¨‰∏ªÂæóÊïë‰∫ÜÔºÅ</p>
                        </div>
                        <div class="dialog-box">
                            <div class="dialog-speaker">${dialogue.speaker}</div>
                            <div class="dialog-text">${dialogue.text}</div>
                        </div>
                        <div class="loot-display">
                            <div class="loot-title">üéÅ Êà∞Âà©ÂìÅ</div>
                            <div class="loot-items">
                                <div class="loot-item"><span style="color:#ffd700">üí∞ ${loot.gold}</span></div>
                                ${loot.souls > 0 ? `<div class="loot-item"><span style="color:#c084fc">üíé ${loot.souls} ÈùàÈ≠ÇÁ¢éÁâá</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.collectLoot()">Â∏∂ÂÖ¨‰∏ªÂõûÂÆ∂</button>
                    </div>
                `;
            }

            renderFleeSuccess() {
                const panel = document.getElementById('event-panel');
                const fleeMessage = this.isMimicFight ? 
                    '‰Ω†ÊàêÂäüÈÄÉÈõ¢‰∫ÜÂØ∂ÁÆ±ÊÄ™ÁöÑËøΩÊìäÔºÅ' : 
                    '‰Ω†ÊàêÂäüÊì∫ËÑ´‰∫ÜÊÄ™Áâ©ÁöÑËøΩÊìäÔºÅ';

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">üèÉ</div>
                        <div><div class="event-title">ÈÄÉËÑ´ÊàêÂäü</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                            <div class="treasure-icon">üí®</div>
                            <p style="color: #a8e6cf; font-size: 1.1rem; margin-top: 10px;">${fleeMessage}</p>
                            <p style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">ÈõñÁÑ∂Êúâ‰∫õÁãºÁãΩÔºå‰ΩÜËá≥Â∞ë‰øù‰Ωè‰∫ÜÊÄßÂëΩ„ÄÇ</p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.level++; game.nextLevel()">ÁπºÁ∫åÂâçÈÄ≤</button>
                    </div>
                `;
            }

            renderMerchant() {
                const panel = document.getElementById('event-panel');
                const areaNum = this.getAreaNumber();
                
                let itemsHtml = this.merchantItems.map((item, index) => {
                    if (item.shopType === 'potion') {
                        return `
                            <div class="shop-item potion-item ${this.player.gold >= item.price ? '' : 'disabled'}" 
                                onclick="game.buyItem(${index})">
                                <div class="shop-item-header">
                                    <span class="shop-item-name potion">${item.emoji} ${item.name}</span>
                                    <span class="shop-item-price">üí∞ ${item.price}</span>
                                </div>
                                <div class="shop-item-description">${item.description}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="shop-item ${item.rarity} ${this.player.gold >= item.price ? '' : 'disabled'}" 
                                onclick="game.buyItem(${index})">
                                <div class="shop-item-header">
                                    <span class="shop-item-name slot-name ${item.rarity}">${item.name}</span>
                                    <span class="shop-item-rarity ${item.rarity}">${RARITY_NAMES[item.rarity]}</span>
                                    <span class="shop-item-price">üí∞ ${item.price}</span>
                                </div>
                                <div class="shop-item-description">
                                    ${SLOT_NAMES[item.type]} | ‚öîÔ∏è${item.attack} üõ°Ô∏è${item.defense} üí®${item.dodge}% üí•${item.crit}% ${item.hp ? `‚ù§Ô∏è${item.hp}` : ''}
                                </div>
                            </div>
                        `;
                    }
                }).join('');

                // Materials to sell
                let materialsHtml = '';
                const matKeys = Object.keys(this.player.materials);
                if (matKeys.length > 0) {
                    let totalValue = 0;
                    matKeys.forEach(key => {
                        const mat = MATERIALS[key];
                        const count = this.player.materials[key];
                        totalValue += Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier()) * count;
                    });

                    materialsHtml = `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1)">
                            <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                                <span>üì¶ Âá∫ÂîÆÁ¥†Êùê</span>
                                <button class="sell-all-btn" onclick="game.sellAllMaterials()">ÂÖ®ÈÉ®Ë≥£Âá∫ (üí∞${totalValue})</button>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px">
                                ${matKeys.map(key => {
                                    const mat = MATERIALS[key];
                                    if (!mat) return '';
                                    const count = this.player.materials[key];
                                    const price = Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier());
                                    const rarityColor = this.getRarityColor(mat.rarity || 'common');
                                    return `
                                        <div class="bag-item material" style="border-left: 2px solid ${rarityColor}; background: rgba(139, 69, 19, 0.2);" onclick="game.sellMaterial('${key}')" title="ÈªûÊìäÂá∫ÂîÆ‰∏ÄÂÄã - ${RARITY_NAMES[mat.rarity] || 'ÊôÆÈÄö'}">
                                            <span style="color: ${rarityColor}">${mat.emoji} x${count}</span>
                                            <span style="color: #ffd700; margin-left: 4px">üí∞${price}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Equipment to sell - with colored boxes
                let bagSellHtml = '';
                if (this.player.bag.length > 0) {
                    bagSellHtml = `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1)">
                            <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px">üéí Âá∫ÂîÆË£ùÂÇô</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                ${this.player.bag.map((item, index) => {
                                    const price = Math.floor(this.calculateEquipmentPrice(item) * 0.35);
                                    return `
                                        <div class="bag-slot ${item.rarity}" onclick="game.sellEquipFromBag(${index})" style="min-height: 50px; cursor: pointer;">
                                            <div class="item-type">${SLOT_NAMES[item.type]}</div>
                                            <div class="item-name ${item.rarity}" style="font-size: 0.65rem;">${item.name}</div>
                                            <div style="color: #ffd700; font-size: 0.6rem; margin-top: 2px;">üí∞${price}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">üè™</div>
                        <div class="event-title">Á•ûÁßòÂïÜ‰∫∫ - „ÄåÂòøÂòøÔºåÂãáÊï¢ÁöÑÈ®éÂ£´ÔºåÈúÄË¶Å‰∫õ‰ªÄÈ∫ºÂóéÔºü„Äç</div>
                    </div>
                    <div class="event-content">
                        <div class="shop-items">${itemsHtml}</div>
                        ${materialsHtml}
                        ${bagSellHtml}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="game.level++; game.nextLevel()">Èõ¢ÈñãÂïÜÂ∫ó</button>
                    </div>
                `;
            }

            getRarityColor(rarity) {
                const colors = {
                    common: '#888',
                    uncommon: '#4ecdc4',
                    rare: '#667eea',
                    epic: '#a855f7',
                    legendary: '#ffd700'
                };
                return colors[rarity] || '#888';
            }

            // ==================== UI UPDATE ====================

            updateUI() {
            const maxHp = this.getMaxHp();
            const area = this.getCurrentArea();
            const areaNum = this.getAreaNumber();
            const floorInArea = this.getFloorInArea();
            
            // Update header
            document.getElementById('floor-area-icon').textContent = area.icon;
            document.getElementById('floor-area-name').textContent = area.name;
            document.getElementById('current-floor').textContent = floorInArea;
            
            // Stats
            document.getElementById('stat-attack').textContent = this.getAttack();
            document.getElementById('stat-defense').textContent = this.getDefense();
            document.getElementById('stat-dodge').textContent = `${this.getDodge()}%`;
            document.getElementById('stat-crit').textContent = `${this.getCrit()}%`;
            document.getElementById('stat-gold').textContent = this.player.gold;

            // HP Bar
            const hpPercent = Math.max(0, (this.player.hp / maxHp) * 100);
            document.getElementById('hp-bar').style.width = `${hpPercent}%`;
            document.getElementById('hp-bar-text').textContent = `‚ù§Ô∏è ${this.player.hp} / ${maxHp}`;

            // Potions Panel
            const potionsPanel = document.getElementById('potions-panel');
            const potionMult = this.getPotionMultiplier();
            let potionsHtml = '<span class="potions-label">üíä Ëó•Ê∞¥:</span>';
            let hasPotions = false;
            
            Object.entries(this.player.potions).forEach(([type, count]) => {
                if (count > 0) {
                    hasPotions = true;
                    const potion = POTION_TYPES[type];
                    const healAmount = Math.floor(maxHp * potion.healPercent * potionMult);
                    potionsHtml += `
                        <div class="potion-slot" onclick="game.usePotion('${type}')" title="‰ΩøÁî®ÂæåÊÅ¢Âæ© ${healAmount} ÈªûÁîüÂëΩ">
                            ${potion.emoji}
                            <span class="potion-name">${potion.name}</span>
                            <span class="potion-heal">+${healAmount}</span>
                            <span class="potion-count">x${count}</span>
                        </div>
                    `;
                }
            });
            
            if (!hasPotions) {
                potionsHtml += '<span class="no-potions">ÁÑ°Ëó•Ê∞¥</span>';
            }
            potionsPanel.innerHTML = potionsHtml;

            // Buffs Panel
            const buffsPanel = document.getElementById('buffs-panel');
            const statNames = { attack: 'Êîª', defense: 'Èò≤', dodge: 'ÈñÉ', crit: 'ÁàÜ' };
            
            let buffHtml = '';
            const soulBonuses = this.getSoulBonuses();
            const hasSoulBonus = soulBonuses.vitality > 0 || soulBonuses.strength > 0 || 
                                soulBonuses.resilience > 0 || soulBonuses.agility > 0 || 
                                soulBonuses.precision > 0;
            if (hasSoulBonus) {
                buffHtml += `<div class="buff soul">üíé ÈùàÈ≠ÇÂº∑Âåñ</div>`;
            }
            
            buffHtml += this.buffs.map(buff => `
                <div class="buff ${buff.type}">
                    ${buff.name} ${buff.value > 0 ? '+' : ''}${buff.value}${statNames[buff.stat]} (${buff.duration})
                </div>
            `).join('');
            
            if (buffHtml === '') {
                buffHtml = '<div class="no-buffs">ÁÑ°Â¢ûÁõäÊïàÊûú</div>';
            }
            buffsPanel.innerHTML = buffHtml;

            // Equipment Slots (Wearing)
            const equipSlots = document.getElementById('equipment-slots');
            equipSlots.innerHTML = ['weapon', 'armor', 'accessory'].map(slot => {
                const item = this.player.equipment[slot];
                if (item) {
                    return `
                        <div class="equipment-slot-h ${item.rarity}">
                            <div class="slot-type">${SLOT_NAMES[slot]}</div>
                            <div class="slot-name ${item.rarity}">${item.name}</div>
                            <div class="slot-stats">
                                <span>‚öîÔ∏è${item.attack}</span>
                                <span>üõ°Ô∏è${item.defense}</span>
                                <span>üí®${item.dodge}%</span>
                                <span>üí•${item.crit}%</span>
                                ${item.hp ? `<span>‚ù§Ô∏è${item.hp}</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="equipment-slot-h">
                            <div class="slot-type">${SLOT_NAMES[slot]}</div>
                            <div class="slot-name" style="color: #555">Á©∫</div>
                            <div class="slot-stats" style="color: #444">-</div>
                        </div>
                    `;
                }
            }).join('');

            // Equipment Bag - 3 Column Grid (20 slots)
            const equipBagGrid = document.getElementById('equip-bag-grid');
            document.getElementById('equip-bag-count').textContent = this.player.bag.length;
            
            let bagHtml = '';
            
            // Render existing items
            this.player.bag.forEach((item, index) => {
                bagHtml += `
                    <div class="bag-slot ${item.rarity}" onclick="game.showEquipCompare(${index})">
                        <div class="item-type">${SLOT_NAMES[item.type]}</div>
                        <div class="item-name ${item.rarity}">${item.name}</div>
                        <div class="item-stats">‚öîÔ∏è${item.attack} üõ°Ô∏è${item.defense}</div>
                    </div>
                `;
            });
            
            // Fill remaining empty slots (up to 20)
            const emptySlots = 20 - this.player.bag.length;
            for (let i = 0; i < emptySlots; i++) {
                bagHtml += `
                    <div class="bag-slot empty">
                        <span class="empty-text">Á©∫</span>
                    </div>
                `;
            }
            
            equipBagGrid.innerHTML = bagHtml;

            // Material Bag Items
            const materialBagItems = document.getElementById('material-bag-items');
            let materialBagHtml = '';

            Object.keys(this.player.materials).forEach(key => {
                const mat = MATERIALS[key];
                if (!mat) return;
                const count = this.player.materials[key];
                const rarityColor = this.getRarityColor(mat.rarity || 'common');
                const rarityClass = mat.rarity || 'common';
                
                materialBagHtml += `
                    <div class="material-item ${rarityClass}">
                        <span style="color: ${rarityColor}">${mat.emoji} ${mat.name}</span>
                        <span class="material-count">x${count}</span>
                    </div>
                `;
            });

            if (materialBagHtml === '') {
                materialBagHtml = '<div class="empty-materials">Á©∫ÁöÑ</div>';
            }
            materialBagItems.innerHTML = materialBagHtml;

            this.saveGame();
        }

            // ==================== GAME END ====================

            gameOver() {
                localStorage.removeItem('magicTower_autoSave');
                const floorBonus = Math.floor(this.level * 0.1);
                const totalSouls = Math.floor((this.soulGainedThisRun + floorBonus) * this.getSoulMultiplier());
                
                this.soulData.souls += totalSouls;
                if (this.level > this.soulData.bestFloor) {
                    this.soulData.bestFloor = this.level;
                }
                saveSoulData(this.soulData);

                document.getElementById('modal-title').textContent = 'üíÄ ÊóÖÁ®ãÁµêÊùü üíÄ';
                document.getElementById('modal-message').textContent = '‰Ω†Âú®È≠îÂ°î‰∏≠ÂÄí‰∏ã‰∫Ü...‰ΩÜ‰Ω†ÁöÑÈùàÈ≠ÇÂæóÂà∞‰∫ÜÂº∑Âåñ„ÄÇ';
                document.getElementById('soul-gained').textContent = totalSouls;
                document.getElementById('final-stats').innerHTML = `
                    <div>Âà∞ÈÅîÂçÄÂüü: <strong style="color: #c084fc">${AREA_NAMES_CN[this.getAreaNumber()]} - ${this.getCurrentArea().name}</strong></div>
                    <div>ÂçÄÂüüÂ±§Êï∏: <strong style="color: #ffd700">${this.getFloorInArea()}</strong> / 50</div>
                    <div>Á∏ΩÂ±§Êï∏: <strong>${this.level}</strong> / 500</div>
                    <div>ÊúÄÈ´òÁ¥ÄÈåÑ: <strong>${this.soulData.bestFloor}</strong></div>
                    <div>Êî∂ÈõÜÈáëÂπ£: <strong>${this.player.gold}</strong></div>
                    <div>ÊúÄÁµÇÊîªÊìä: <strong style="color: #ff6b35">${this.getAttack()}</strong></div>
                    <div>ÊúÄÁµÇÈò≤Á¶¶: <strong style="color: #4ecdc4">${this.getDefense()}</strong></div>
                `;
                document.getElementById('game-over-modal').classList.add('active');
            }

            victory() {
                localStorage.removeItem('magicTower_autoSave');
                const victoryBonus = 300;
                const totalSouls = Math.floor((this.soulGainedThisRun + victoryBonus) * this.getSoulMultiplier());
                
                this.soulData.souls += totalSouls;
                this.soulData.bestFloor = 500;
                saveSoulData(this.soulData);

                document.getElementById('modal-title').textContent = 'üéâ ÂÖ¨‰∏ªÂæóÊïë‰∫ÜÔºÅ üéâ';
                document.getElementById('modal-message').textContent = '‰Ω†ÊàêÂäüÊìäÊïóÈ≠îÁéãÔºåÊãØÊïë‰∫ÜÂÖ¨‰∏ªÔºÅÁéãÂúãÂ∞áÊ∞∏ÈÅ†Ë®ò‰Ωè‰Ω†ÁöÑËã±Âãá‰∫ãËπüÔºÅ';
                document.getElementById('soul-gained').textContent = totalSouls;
                document.getElementById('final-stats').innerHTML = `
                    <div style="color: #ffd700; font-size: 1.1rem; margin-bottom: 8px">üèÜ ÈÄöÈóúÈ≠îÂ°îÔºÅ üèÜ</div>
                    <div>üë∏ ÊÑõËéâÁµ≤ÂÖ¨‰∏ªÁç≤Êïë</div>
                    <div>Á∏ΩÂÜíÈö™Ê¨°Êï∏: <strong>${this.soulData.totalRuns}</strong></div>
                    <div>ÊìäÊïóÈ¶ñÈ†òÊï∏: <strong style="color: #e94560">${this.soulData.bossesKilled}</strong></div>
                    <div>ÊúÄÁµÇÊîªÊìä: <strong style="color: #ff6b35">${this.getAttack()}</strong></div>
                    <div>ÊúÄÁµÇÈò≤Á¶¶: <strong style="color: #4ecdc4">${this.getDefense()}</strong></div>
                    <div>ÊúÄÁµÇÈñÉÈÅø: <strong style="color: #a8e6cf">${this.getDodge()}%</strong></div>
                    <div>ÊúÄÁµÇÁàÜÊìä: <strong style="color: #f39c12">${this.getCrit()}%</strong></div>
                `;
                document.getElementById('game-over-modal').classList.add('active');
            }
        }

        // ==================== INITIALIZE GAME ====================
        const game = new Game();
    </script>
</body>
</html>