<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­”å¡”å‚³èªª - æ‹¯æ•‘å…¬ä¸»</title>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    height: 100%;
    overflow: hidden;
    touch-action: manipulation;
}

body {
    font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    color: #e8e8e8;
    display: flex;
    justify-content: center;
}

.game-container {
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 500px;
    overflow: hidden;
}

/* ==================== MAIN MENU ==================== */
.main-menu {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 20px;
    overflow-y: auto;
}

.main-menu h1 {
    font-size: clamp(1.5rem, 5vw, 2.5rem);
    color: #e94560;
    text-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
    margin-bottom: 10px;
}

.main-menu .subtitle {
    font-size: clamp(0.9rem, 2.5vw, 1.2rem);
    color: #ffd700;
    margin-bottom: 30px;
}

.menu-story {
    background: rgba(0, 0, 0, 0.4);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
    max-width: 400px;
    border: 1px solid rgba(233, 69, 96, 0.3);
}

.menu-story p {
    font-size: 0.9rem;
    line-height: 1.6;
    color: #ccc;
    margin-bottom: 10px;
}

.menu-story p:last-child {
    margin-bottom: 0;
    color: #e94560;
    font-weight: bold;
}

.soul-display {
    background: rgba(147, 51, 234, 0.2);
    border: 1px solid #9333ea;
    padding: 10px 25px;
    border-radius: 20px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.soul-display .soul-icon {
    font-size: 1.3rem;
}

.soul-display .soul-count {
    font-size: 1.2rem;
    color: #c084fc;
    font-weight: bold;
}

.menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 250px;
}

.menu-btn {
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.menu-btn:active {
    transform: scale(0.98);
}

.menu-btn.start {
    background: linear-gradient(135deg, #e94560, #ff6b6b);
    color: white;
}

.menu-btn.soul-shop {
    background: linear-gradient(135deg, #9333ea, #c084fc);
    color: white;
}

/* ==================== SOUL SHOP ==================== */
.soul-shop-container {
    display: none;
    flex-direction: column;
    height: 100%;
    padding: 10px;
}

.soul-shop-header {
    text-align: center;
    padding: 15px;
    border-bottom: 2px solid #9333ea;
    margin-bottom: 15px;
    flex-shrink: 0;
}

.soul-shop-header h2 {
    font-size: 1.5rem;
    color: #c084fc;
    margin-bottom: 8px;
}

.soul-shop-items {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
}

.soul-upgrade {
    background: rgba(147, 51, 234, 0.15);
    border: 1px solid rgba(147, 51, 234, 0.4);
    padding: 12px 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
}

.soul-upgrade.maxed {
    opacity: 0.6;
    border-color: #4ecdc4;
}

.upgrade-info {
    flex: 1;
}

.upgrade-name {
    font-weight: bold;
    color: #c084fc;
    margin-bottom: 4px;
}

.upgrade-desc {
    font-size: 0.8rem;
    color: #aaa;
}

.upgrade-level {
    font-size: 0.75rem;
    color: #ffd700;
    margin-top: 4px;
}

.upgrade-cost {
    display: flex;
    align-items: center;
    gap: 5px;
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.upgrade-cost:active:not(.disabled) {
    background: rgba(147, 51, 234, 0.4);
}

.upgrade-cost.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.upgrade-cost.maxed {
    background: rgba(78, 205, 196, 0.3);
    cursor: default;
}

/* ==================== GAME SCREEN ==================== */
.game-screen {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

/* Main scrollable area containing event + inventory */
.game-scroll-area {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
}


/* 1. Title/Header */
.game-header {
    text-align: center;
    padding: 6px 10px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 2px solid #e94560;
    flex-shrink: 0;
}

.game-header h1 {
    font-size: 1rem;
    color: #e94560;
    text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
    margin-bottom: 2px;
}

.floor-display {
    font-size: 0.8rem;
    color: #ffd700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.floor-display .area-icon {
    font-size: 1rem;
}

.floor-display .area-name {
    color: #c084fc;
    font-weight: bold;
}

/* 2. Event Panel - Now part of scroll area */
.event-panel {
    display: flex;
    flex-direction: column;
    background: rgba(255, 255, 255, 0.03);
    border-bottom: 2px solid rgba(233, 69, 96, 0.3);
    min-height: var(--combat-height, 320px); /* Default fallback */
}

.event-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.event-icon {
    font-size: 1.5rem;
}

.event-title {
    font-size: 1rem;
    color: #e94560;
    font-weight: bold;
}

.event-content {
    padding: 8px 12px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.event-description {
    font-size: 0.85rem;
    line-height: 1.4;
    color: #ccc;
    margin-bottom: 8px;
}

.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.2);
}

/* 3. HP Bar */
.hp-section {
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.hp-bar-container {
    background: rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    padding: 3px;
}

.hp-bar {
    height: 22px;
    background: linear-gradient(90deg, #e94560, #ff6b6b);
    border-radius: 6px;
    transition: width 0.3s ease;
    position: relative;
}

.hp-bar-text {
    position: absolute;
    width: 100%;
    text-align: center;
    line-height: 22px;
    font-weight: bold;
    font-size: 0.8rem;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
}

/* 4. Stats Panel */
.stats-panel {
    display: flex;
    gap: 8px;
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.stats-left {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
    flex: 1;
}

.stat-box {
    text-align: center;
    padding: 6px 4px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
}

.stat-box .stat-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.stat-icon {
    font-size: 0.85rem;
}

.stat-label {
    font-size: 0.6rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: clamp(0.8rem, 2.2vw, 1rem);
    font-weight: bold;
    color: #fff;
}

.stat-box.attack .stat-value { color: #ff6b35; }
.stat-box.defense .stat-value { color: #4ecdc4; }
.stat-box.dodge .stat-value { color: #a8e6cf; }
.stat-box.crit .stat-value { color: #f39c12; }

.stats-right {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 110px;
}

.gold-box {
    background: rgba(255, 215, 0, 0.15);
    border: 1px solid rgba(255, 215, 0, 0.3);
    padding: 6px 10px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.gold-box .gold-icon {
    font-size: 1rem;
}

.gold-box .gold-value {
    font-size: 0.95rem;
    font-weight: bold;
    color: #ffd700;
}

.buffs-box {
    background: rgba(0, 0, 0, 0.3);
    padding: 5px 8px;
    border-radius: 6px;
    flex: 1;
    overflow-y: auto;
    max-height: 50px;
}

.buffs-box .buff {
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.55rem;
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin: 1px;
}

.buffs-box .buff.positive {
    background: rgba(78, 205, 196, 0.2);
    border: 1px solid #4ecdc4;
    color: #4ecdc4;
}

.buffs-box .buff.negative {
    background: rgba(233, 69, 96, 0.2);
    border: 1px solid #e94560;
    color: #e94560;
}

.buffs-box .buff.soul {
    background: rgba(147, 51, 234, 0.2);
    border: 1px solid #9333ea;
    color: #c084fc;
}

.no-buffs {
    font-size: 0.6rem;
    color: #555;
    text-align: center;
}

/* 5. Potions Panel */
.potions-panel {
    display: flex;
    gap: 6px;
    padding: 6px 12px;
    background: rgba(0, 0, 0, 0.2);
    flex-wrap: wrap;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.potions-label {
    font-size: 0.7rem;
    color: #888;
    margin-right: 4px;
}

.potion-slot {
    background: rgba(78, 205, 196, 0.15);
    border: 1px solid rgba(78, 205, 196, 0.4);
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.potion-slot:active {
    background: rgba(78, 205, 196, 0.4);
    transform: scale(0.98);
}

.potion-slot .potion-name {
    color: #4ecdc4;
    font-size: 0.7rem;
}

.potion-slot .potion-count {
    background: rgba(0, 0, 0, 0.3);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.65rem;
}

.potion-slot .potion-heal {
    font-size: 0.6rem;
    color: #aaa;
}

.no-potions {
    font-size: 0.7rem;
    color: #555;
}

/* 6. Inventory Sections - Dynamic sizing */
.inventory-section {
    padding: 8px 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.inventory-section:last-child {
    border-bottom: none;
    padding-bottom: 12px;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.section-header h4 {
    font-size: 0.75rem;
    color: #888;
    display: flex;
    align-items: center;
    gap: 4px;
    margin: 0;
}

.section-header .section-count {
    font-size: 0.65rem;
    color: #666;
}

/* Equipment Wearing Section */
.equipment-slots-horizontal {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}

.equipment-slot-h {
    background: rgba(0, 0, 0, 0.3);
    padding: 6px 4px;
    border-radius: 6px;
    border-left: 3px solid #444;
    text-align: center;
}

.equipment-slot-h.common { border-left-color: #888; }
.equipment-slot-h.uncommon { border-left-color: #4ecdc4; }
.equipment-slot-h.rare { border-left-color: #667eea; }
.equipment-slot-h.epic { border-left-color: #a855f7; }
.equipment-slot-h.legendary { border-left-color: #ffd700; }

.equipment-slot-h .slot-type {
    font-size: 0.55rem;
    color: #666;
    margin-bottom: 1px;
}

.equipment-slot-h .slot-name {
    font-weight: bold;
    font-size: 0.65rem;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.equipment-slot-h .slot-name.common { color: #888; }
.equipment-slot-h .slot-name.uncommon { color: #4ecdc4; }
.equipment-slot-h .slot-name.rare { color: #667eea; }
.equipment-slot-h .slot-name.epic { color: #a855f7; }
.equipment-slot-h .slot-name.legendary { color: #ffd700; }

.equipment-slot-h .slot-stats {
    font-size: 0.5rem;
    color: #aaa;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 2px;
}

/* Bag Grid - 3 columns with merchant style */
.bag-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}

.bag-slot {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 6px;
    padding: 8px;
    border: 2px solid #444;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
}

.bag-slot:active {
    background: rgba(233, 69, 96, 0.2);
    transform: scale(0.98);
}

.bag-slot.common { border-color: #888; }
.bag-slot.uncommon { border-color: #4ecdc4; }
.bag-slot.rare { border-color: #667eea; }
.bag-slot.epic { border-color: #a855f7; }
.bag-slot.legendary { border-color: #ffd700; animation: legendaryGlow 2s ease-in-out infinite; }

.bag-slot .bag-title-row {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
}

.bag-slot .item-name {
    font-weight: bold;
    font-size: 0.8rem;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.bag-slot .item-name.common { color: #888; }
.bag-slot .item-name.uncommon { color: #4ecdc4; }
.bag-slot .item-name.rare { color: #667eea; }
.bag-slot .item-name.epic { color: #a855f7; }
.bag-slot .item-name.legendary { color: #ffd700; }

.bag-slot .item-rarity {
    font-size: 0.5rem;
    padding: 1px 4px;
    border-radius: 3px;
    flex-shrink: 0;
}

.bag-slot .item-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
}

.bag-slot .item-stats .stat-tag {
    font-size: 0.6rem;
    color: #ccc;
    background: rgba(255,255,255,0.08);
    padding: 1px 4px;
    border-radius: 3px;
}

.bag-slot .item-stats .stat-tag.attack { color: #ff6b35; }
.bag-slot .item-stats .stat-tag.defense { color: #4ecdc4; }
.bag-slot .item-stats .stat-tag.dodge { color: #a8e6cf; }
.bag-slot .item-stats .stat-tag.crit { color: #f39c12; }
.bag-slot .item-stats .stat-tag.hp { color: #e94560; }

.bag-empty {
    text-align: center;
    color: #555;
    font-size: 0.7rem;
    padding: 8px;
}

/* Materials Section - Compact inline */
.materials-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.material-item {
    background: rgba(139, 69, 19, 0.2);
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 0.65rem;
    display: flex;
    align-items: center;
    gap: 3px;
    border-left: 2px solid #8b4513;
}

.material-item.common { border-left-color: #888; }
.material-item.uncommon { border-left-color: #4ecdc4; }
.material-item.rare { border-left-color: #667eea; }
.material-item.epic { border-left-color: #a855f7; }
.material-item.legendary { border-left-color: #ffd700; animation: legendaryGlow 2s ease-in-out infinite; }

.material-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 1px 4px;
    border-radius: 3px;
    font-size: 0.55rem;
}

.empty-materials {
    color: #555;
    font-size: 0.65rem;
}

@keyframes legendaryGlow {
    0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
    50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
}

/* Hide old tab system */
.bottom-tabs {
    display: none !important;
}

.tab-panel {
    display: none !important;
}

/* ==================== BATTLE ARENA ==================== */
.battle-arena {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 12px;
    background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%);
    border-radius: 10px;
    margin-bottom: 8px;
}

.combatant {
    text-align: center;
}

.combatant-sprite {
    font-size: 3.5rem;
    animation: combatantIdle 1.5s ease-in-out infinite;
}

@keyframes combatantIdle {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.combatant-name {
    font-weight: bold;
    font-size: 1rem;
    margin: 4px 0;
}

.combatant-name.normal { color: #888; }
.combatant-name.elite { color: #667eea; }
.combatant-name.boss { color: #ffd700; }

.combatant-hp-bar {
    width: 160px;
    height: 14px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 7px;
    overflow: hidden;
    margin: 4px auto;
}

.combatant-hp-fill {
    height: 100%;
    background: linear-gradient(90deg, #e94560, #ff6b6b);
    transition: width 0.3s ease;
}

.combatant-hp-text {
    font-size: 0.75rem;
    color: #aaa;
}

.combatant-stats {
    font-size: 0.7rem;
    color: #888;
    margin-top: 2px;
}

/* Battle Log */
.battle-log {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    padding: 8px;
    margin-top: 8px;
    height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.battle-log-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    gap: 2px;
}

.battle-log-content.single-line {
    min-height: 40px;
    justify-content: center;
}

.battle-log-entry {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 3px 0;
    font-size: 0.8rem;
    line-height: 1.4;
    height: 24px;
    flex-shrink: 0;
}

.battle-log-entry.player-attack { color: #4ecdc4; }
.battle-log-entry.player-crit { color: #f39c12; }
.battle-log-entry.monster-attack { color: #e94560; }
.battle-log-entry.dodge { color: #a8e6cf; }
.battle-log-entry.heal { color: #4ecdc4; }

.damage-number {
    font-weight: bold;
    font-size: 0.95rem;
}

/* ==================== DIALOG BOX ==================== */
.dialog-box {
    background: rgba(0, 0, 0, 0.5);
    border-left: 3px solid #ffd700;
    padding: 10px 12px;
    margin: 8px 0;
    border-radius: 0 8px 8px 0;
}

.dialog-speaker {
    color: #ffd700;
    font-weight: bold;
    font-size: 0.8rem;
    margin-bottom: 4px;
}

.dialog-text {
    color: #ddd;
    font-size: 0.85rem;
    line-height: 1.4;
    font-style: italic;
}

/* ==================== TREASURE ==================== */
.treasure-display {
    text-align: center;
    padding: 15px;
}

.treasure-icon {
    font-size: 3rem;
    margin-bottom: 10px;
    animation: treasureGlow 1.5s ease-in-out infinite;
}

@keyframes treasureGlow {
    0%, 100% { filter: drop-shadow(0 0 8px #ffd700); }
    50% { filter: drop-shadow(0 0 20px #ffd700); }
}

.chest-choice {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 12px;
}

.chest-option {
    background: rgba(0, 0, 0, 0.4);
    border: 2px solid #444;
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    flex: 1;
    max-width: 140px;
    transition: all 0.2s;
}

.chest-option:active {
    transform: scale(0.98);
}

.chest-option.safe { border-color: #4ecdc4; }
.chest-option.risky { border-color: #e94560; }

.chest-option .option-icon {
    font-size: 2.2rem;
    margin-bottom: 6px;
}

.chest-option .option-title {
    font-weight: bold;
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.chest-option.safe .option-title { color: #4ecdc4; }
.chest-option.risky .option-title { color: #e94560; }

.chest-option .option-desc {
    font-size: 0.65rem;
    color: #aaa;
}

/* Loot Display */
.loot-display {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 10px;
    margin-top: 8px;
}

.loot-title {
    font-size: 0.8rem;
    color: #ffd700;
    margin-bottom: 6px;
    text-align: center;
}

.loot-items {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}

.loot-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* ==================== SHOP ==================== */
.shop-items {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.shop-item {
    background: rgba(0, 0, 0, 0.3);
    padding: 10px;
    border-radius: 6px;
    border-left: 3px solid #444;
    cursor: pointer;
    transition: all 0.2s;
}

.shop-item:active:not(.disabled) {
    background: rgba(233, 69, 96, 0.2);
}

.shop-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.shop-item.potion-item { border-left-color: #4ecdc4; }
.shop-item.common { border-left-color: #888; }
.shop-item.uncommon { border-left-color: #4ecdc4; }
.shop-item.rare { border-left-color: #667eea; }
.shop-item.epic { border-left-color: #a855f7; }
.shop-item.legendary { border-left-color: #ffd700; }

.shop-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    flex-wrap: wrap;
    gap: 4px;
}

.shop-item-name {
    font-weight: bold;
    font-size: 0.85rem;
}

.shop-item-name.potion { color: #4ecdc4; }

.shop-item-price {
    color: #ffd700;
    font-weight: bold;
    font-size: 0.8rem;
}

.shop-item-description {
    font-size: 0.7rem;
    color: #aaa;
}

.shop-item-rarity {
    font-size: 0.6rem;
    padding: 2px 6px;
    border-radius: 4px;
}

.shop-item-rarity.common { background: rgba(136, 136, 136, 0.3); color: #888; }
.shop-item-rarity.uncommon { background: rgba(78, 205, 196, 0.3); color: #4ecdc4; }
.shop-item-rarity.rare { background: rgba(102, 126, 234, 0.3); color: #667eea; }
.shop-item-rarity.epic { background: rgba(168, 85, 247, 0.3); color: #a855f7; }
.shop-item-rarity.legendary { background: rgba(255, 215, 0, 0.3); color: #ffd700; }

.sell-all-btn {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.7rem;
    cursor: pointer;
}

.sell-all-btn:active {
    transform: scale(0.98);
}

/* ==================== MERCHANT EQUIPMENT GRID ==================== */
.merchant-equip-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
}

.merchant-equip-card {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 6px;
    padding: 8px;
    border: 2px solid #444;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
}

.merchant-equip-card:active:not(.disabled) {
    transform: scale(0.98);
    background: rgba(233, 69, 96, 0.2);
}

.merchant-equip-card.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.merchant-equip-card.common { border-color: #888; }
.merchant-equip-card.uncommon { border-color: #4ecdc4; }
.merchant-equip-card.rare { border-color: #667eea; }
.merchant-equip-card.epic { border-color: #a855f7; }
.merchant-equip-card.legendary { border-color: #ffd700; animation: legendaryGlow 2s ease-in-out infinite; }

.merchant-equip-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    gap: 4px;
}

.merchant-equip-name-group {
    display: flex;
    align-items: center;
    gap: 5px;
    flex: 1;
    min-width: 0;
}

.merchant-equip-name {
    font-weight: bold;
    font-size: 0.85rem;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.merchant-equip-name.common { color: #888; }
.merchant-equip-name.uncommon { color: #4ecdc4; }
.merchant-equip-name.rare { color: #667eea; }
.merchant-equip-name.epic { color: #a855f7; }
.merchant-equip-name.legendary { color: #ffd700; }

.merchant-equip-rarity {
    font-size: 0.5rem;
    padding: 1px 4px;
    border-radius: 3px;
    flex-shrink: 0;
}

.merchant-equip-price {
    color: #ffd700;
    font-weight: bold;
    font-size: 0.75rem;
    white-space: nowrap;
    flex-shrink: 0;
}

.merchant-equip-price.sell {
    color: #4ecdc4;
}

.merchant-equip-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
}

.merchant-equip-stats .stat-tag {
    font-size: 0.6rem;
    color: #ccc;
    background: rgba(255,255,255,0.08);
    padding: 1px 4px;
    border-radius: 3px;
}

.merchant-equip-stats .stat-tag.attack { color: #ff6b35; }
.merchant-equip-stats .stat-tag.defense { color: #4ecdc4; }
.merchant-equip-stats .stat-tag.dodge { color: #a8e6cf; }
.merchant-equip-stats .stat-tag.crit { color: #f39c12; }
.merchant-equip-stats .stat-tag.hp { color: #e94560; }

/* ==================== BUTTONS ==================== */
.btn {
    padding: 12px 24px;
    font-size: 0.85rem;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn:active:not(:disabled) {
    transform: scale(0.96);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: linear-gradient(135deg, #e94560, #ff6b6b);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #4ecdc4, #44a08d);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #ffd700, #ff9500);
    color: #1a1a2e;
}

.btn-danger {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.btn-small {
    padding: 8px 16px;
    font-size: 0.75rem;
}

.flee-info {
    font-size: 0.6rem;
    color: rgba(255,255,255,0.7);
    display: block;
    margin-top: 2px;
}

/* ==================== MODALS ==================== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    max-width: 350px;
    width: 100%;
    border: 2px solid #e94560;
}

.modal-content h2 {
    font-size: 1.3rem;
    margin-bottom: 12px;
    color: #e94560;
}

.modal-content p {
    margin-bottom: 12px;
    font-size: 0.9rem;
}

.final-stats {
    background: rgba(0, 0, 0, 0.3);
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 12px;
    font-size: 0.85rem;
}

.final-stats div {
    padding: 3px 0;
}

.soul-reward {
    background: rgba(147, 51, 234, 0.3);
    border: 1px solid #9333ea;
    padding: 10px;
    border-radius: 8px;
    margin: 10px 0;
}

.soul-reward-text {
    color: #c084fc;
    font-size: 1.1rem;
    font-weight: bold;
}

/* Equipment Compare Modal */
.equip-compare-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 15px;
}

.equip-compare-content {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 12px;
    padding: 20px;
    max-width: 380px;
    width: 100%;
    border: 2px solid #e94560;
}

.equip-compare-title {
    text-align: center;
    font-size: 1.1rem;
    color: #e94560;
    margin-bottom: 15px;
}

.equip-compare-container {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}

.equip-card {
    background: rgba(0, 0, 0, 0.4);
    padding: 12px;
    border-radius: 8px;
    text-align: center;
}

.equip-card.current {
    border: 2px solid #888;
}

.equip-card.new {
    border: 2px solid;
}

.equip-card.new.common { border-color: #888; }
.equip-card.new.uncommon { border-color: #4ecdc4; }
.equip-card.new.rare { border-color: #667eea; }
.equip-card.new.epic { border-color: #a855f7; }
.equip-card.new.legendary { border-color: #ffd700; }

.equip-card-label {
    font-size: 0.7rem;
    color: #888;
    margin-bottom: 5px;
}

.equip-card-name {
    font-weight: bold;
    font-size: 0.85rem;
    margin-bottom: 8px;
}

.equip-card-stats {
    font-size: 0.75rem;
    color: #aaa;
}

.equip-card-stats .stat-line {
    display: flex;
    justify-content: space-between;
    padding: 2px 0;
}

.compare-arrow {
    font-size: 1.5rem;
    color: #ffd700;
}

.stat-change {
    font-size: 0.7rem;
    margin-left: 5px;
}

.stat-change.positive { color: #4ecdc4; }
.stat-change.negative { color: #e94560; }

.equip-compare-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

/* ==================== OVERLAYS ==================== */
.area-transition, .story-transition {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.5s ease;
    padding: 20px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.area-transition h2 {
    font-size: 1.8rem;
    color: #e94560;
    margin-bottom: 15px;
    text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
}

.area-transition .area-name {
    font-size: 1.3rem;
    color: #ffd700;
    margin-bottom: 20px;
}

.area-transition .area-desc {
    font-size: 0.9rem;
    color: #aaa;
    text-align: center;
    max-width: 300px;
    line-height: 1.5;
    margin-bottom: 25px;
}

.area-transition .area-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.story-transition .story-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: pulse 2s ease-in-out infinite;
}

.story-transition h2 {
    font-size: 1.5rem;
    color: #ffd700;
    margin-bottom: 20px;
    text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.story-transition .princess-display {
    text-align: center;
    margin: 20px 0;
}

.story-transition .princess-display .princess-sprite {
    font-size: 3.5rem;
    animation: princessFloat 2s ease-in-out infinite;
}

@keyframes princessFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}

.story-transition .story-info {
    color: #888;
    font-size: 0.8rem;
    margin-top: 10px;
}

/* ==================== ANIMATIONS ==================== */
.shake {
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
}

.attack-animation {
    animation: attackPulse 0.3s ease-out;
}

@keyframes attackPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.princess-sprite {
    font-size: 3rem;
}

/* ==================== SCROLLBAR ==================== */
::-webkit-scrollbar {
    width: 4px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 2px;
}

::-webkit-scrollbar-thumb {
    background: #e94560;
    border-radius: 2px;
}

.hidden {
    display: none !important;
}

/* Landscape adjustments */
@media (orientation: landscape) and (max-height: 500px) {
    .combatant-sprite {
        font-size: 2.5rem;
    }
    
    .treasure-icon {
        font-size: 2rem;
    }
    
    .stats-panel {
        padding: 4px 12px;
    }
    
    .stat-box {
        padding: 4px;
    }
}
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Main Menu -->
        <div class="main-menu" id="main-menu">
            <h1>ğŸ° é­”å¡”å‚³èªª ğŸ°</h1>
            <div class="subtitle">âœ¨ æ‹¯æ•‘å…¬ä¸» âœ¨</div>
            
            <div class="menu-story">
                <p>åœ¨é™é çš„ç‹åœ‹ï¼Œç¾éº—çš„æ„›è‰çµ²å…¬ä¸»è¢«é‚ªæƒ¡çš„é­”ç‹æ“„èµ°ï¼Œå›šç¦åœ¨é­”å¡”çš„æœ€é ‚å±¤ã€‚</p>
                <p>èº«ç‚ºç‹åœ‹æœ€å‹‡æ•¢çš„é¨å£«ï¼Œä½ èª“è¨€è¦æ”€ç™»é€™åº§é­”å¡”ï¼Œç©¿è¶Šåå€‹å±éšªå€åŸŸï¼Œæ“Šæ•—é­”ç‹ï¼Œæ‹¯æ•‘å…¬ä¸»ï¼</p>
                <p>ã€Œé¨å£«å¤§äººï¼Œè«‹ä¸€å®šè¦ä¾†æ•‘æˆ‘...ã€</p>
            </div>

            <div class="soul-display">
                <span class="soul-icon">ğŸ’</span>
                <span>éˆé­‚ç¢ç‰‡ï¼š</span>
                <span class="soul-count" id="menu-soul-count">0</span>
            </div>

            <div class="menu-buttons">
                <button class="menu-btn start" onclick="game.startNewRun()">âš”ï¸ é–‹å§‹å†’éšª</button>
                <button class="menu-btn soul-shop" onclick="game.openSoulShop()">ğŸ’ éˆé­‚å•†åº—</button>
            </div>
        </div>

        <!-- Soul Shop -->
        <div class="soul-shop-container" id="soul-shop">
            <div class="soul-shop-header">
                <h2>ğŸ’ éˆé­‚å•†åº— ğŸ’</h2>
                <div class="soul-display" style="justify-content: center; margin-top: 10px;">
                    <span class="soul-icon">ğŸ’</span>
                    <span>éˆé­‚ç¢ç‰‡ï¼š</span>
                    <span class="soul-count" id="shop-soul-count">0</span>
                </div>
            </div>
            <div class="soul-shop-items" id="soul-shop-items"></div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="game.closeSoulShop()">è¿”å›ä¸»é¸å–®</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen hidden" id="game-screen">
            <!-- 1. Title/Header - Fixed -->
            <div class="game-header">
                <h1>ğŸ° é­”å¡”å‚³èªª ğŸ°</h1>
                <div class="floor-display">
                    <span class="area-icon" id="floor-area-icon">â›“ï¸</span>
                    <span class="area-name" id="floor-area-name">åœ°ä¸‹ç›£ç‰¢</span>
                    <span>ç¬¬ <span id="current-floor">1</span> å±¤</span>
                </div>
            </div>

            <!-- 2. Main Scrollable Area -->
            <div class="game-scroll-area">
                <!-- Event Panel - First in scroll area -->
                <div class="event-panel" id="event-panel">
                    <!-- Events render here -->
                </div>

                <!-- HP Bar -->
                <div class="hp-section">
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="hp-bar">
                            <span class="hp-bar-text" id="hp-bar-text">100 / 100</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Panel -->
                <div class="stats-panel">
                    <div class="stats-left">
                        <div class="stat-box attack">
                            <div class="stat-row">
                                <span class="stat-icon">âš”ï¸</span>
                                <span class="stat-value" id="stat-attack">10</span>
                            </div>
                            <div class="stat-label">æ”»æ“Š</div>
                        </div>
                        <div class="stat-box defense">
                            <div class="stat-row">
                                <span class="stat-icon">ğŸ›¡ï¸</span>
                                <span class="stat-value" id="stat-defense">5</span>
                            </div>
                            <div class="stat-label">é˜²ç¦¦</div>
                        </div>
                        <div class="stat-box crit">
                            <div class="stat-row">
                                <span class="stat-icon">ğŸ’¥</span>
                                <span class="stat-value" id="stat-crit">5%</span>
                            </div>
                            <div class="stat-label">çˆ†æ“Š</div>
                        </div>
                        <div class="stat-box dodge">
                            <div class="stat-row">
                                <span class="stat-icon">ğŸ’¨</span>
                                <span class="stat-value" id="stat-dodge">5%</span>
                            </div>
                            <div class="stat-label">é–ƒé¿</div>
                        </div>
                    </div>
                    <div class="stats-right">
                        <div class="gold-box">
                            <span class="gold-icon">ğŸ’°</span>
                            <span class="gold-value" id="stat-gold">0</span>
                        </div>
                        <div class="buffs-box" id="buffs-panel">
                            <div class="no-buffs">ç„¡å¢ç›Šæ•ˆæœ</div>
                        </div>
                    </div>
                </div>

                <!-- Potions -->
                <div class="potions-panel" id="potions-panel">
                    <span class="potions-label">ğŸ’Š è—¥æ°´:</span>
                </div>

                <!-- Equipment Wearing Section -->
                <div class="inventory-section" id="section-equipment">
                    <div class="section-header">
                        <h4>ğŸ–ï¸ è£å‚™ä¸­</h4>
                    </div>
                    <div class="equipment-slots-horizontal" id="equipment-slots"></div>
                </div>
                
                <!-- Equipment Bag Section -->
                <div class="inventory-section" id="section-bag">
                    <div class="section-header">
                        <h4>ğŸ’ è£å‚™èƒŒåŒ…</h4>
                        <span class="section-count"><span id="equip-bag-count">0</span>/20</span>
                    </div>
                    <div class="bag-grid" id="equip-bag-grid"></div>
                </div>
                
                <!-- Materials Section -->
                <div class="inventory-section" id="section-materials">
                    <div class="section-header">
                        <h4>ğŸ“¦ ç´ æ</h4>
                    </div>
                    <div class="materials-grid" id="material-bag-items"></div>
                </div>
            </div>
        </div>
    
    <!-- Game Over Modal -->
    <div class="modal" id="game-over-modal">
        <div class="modal-content">
            <h2 id="modal-title">éŠæˆ²çµæŸ</h2>
            <p id="modal-message">ä½ åœ¨æˆ°é¬¥ä¸­å€’ä¸‹äº†...</p>
            <div class="soul-reward" id="soul-reward">
                <div class="soul-reward-text">ğŸ’ ç²å¾—éˆé­‚ç¢ç‰‡ï¼š<span id="soul-gained">0</span></div>
            </div>
            <div class="final-stats" id="final-stats"></div>
            <button class="btn btn-primary" onclick="game.returnToMenu()">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>
    
    <!-- Area Transition Overlay -->
    <div class="area-transition hidden" id="area-transition">
        <div class="area-icon" id="area-icon">ğŸ°</div>
        <h2 id="area-transition-title">é€²å…¥ç¬¬1å€åŸŸ</h2>
        <div class="area-name" id="area-name">åœ°ä¸‹ç›£ç‰¢</div>
        <div class="area-desc" id="area-desc">é™°æš—æ½®æ¿•çš„ç›£ç‰¢ï¼Œé—œæŠ¼è‘—è¢«éºå¿˜çš„éˆé­‚...</div>
        <button class="btn btn-primary" onclick="game.closeAreaTransition()">ç¹¼çºŒå‰é€²</button>
    </div>

    <!-- Story Transition Overlay -->
    <div class="story-transition hidden" id="story-transition">
        <div class="story-icon" id="story-icon">ğŸ‘‘</div>
        <h2 id="story-title">ç‹åŸå¤§æ®¿</h2>
        <div class="dialog-box">
            <div class="dialog-speaker" id="story-speaker">è€åœ‹ç‹</div>
            <div class="dialog-text" id="story-text">å‹‡æ•¢çš„é¨å£«å•Š...</div>
        </div>
        <div class="princess-display">
            <div class="princess-sprite">ğŸ‘¸</div>
            <p style="color: #ffd700;">å…¬ä¸»åœ¨é­”å¡”é ‚å±¤ç­‰å¾…æ•‘æ´...</p>
        </div>
        <div class="story-info">ç©¿è¶Š10å€‹å€åŸŸï¼Œ500å±¤é­”å¡”</div>
        <button class="btn btn-primary" onclick="game.closeStoryTransition()">è¸å…¥é­”å¡”</button>
    </div>

    <!-- Equipment Compare Modal -->
    <div class="equip-compare-modal hidden" id="equip-compare-modal">
        <div class="equip-compare-content">
            <div class="equip-compare-title">ğŸ”„ æ›´æ›è£å‚™</div>
            <div class="equip-compare-container" id="equip-compare-container"></div>
            <div class="equip-compare-buttons">
                <button class="btn btn-primary btn-small" id="equip-confirm-btn">è£å‚™</button>
                <button class="btn btn-secondary btn-small" onclick="game.closeEquipCompare()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Sell Equipment Confirm Modal -->
    <div class="equip-compare-modal hidden" id="sell-equip-modal">
        <div class="equip-compare-content">
            <div class="equip-compare-title">ğŸ’° å‡ºå”®è£å‚™</div>
            <div id="sell-equip-modal-content"></div>
            <div class="equip-compare-buttons">
                <button class="btn btn-warning btn-small" id="sell-equip-confirm-btn">å‡ºå”®</button>
                <button class="btn btn-secondary btn-small" onclick="game.closeSellEquipModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Unequip Confirm Modal -->
    <div class="equip-compare-modal hidden" id="unequip-modal">
        <div class="equip-compare-content">
            <div class="equip-compare-title">ğŸ”„ å¸ä¸‹è£å‚™</div>
            <div id="unequip-modal-content"></div>
            <div class="equip-compare-buttons">
                <button class="btn btn-warning btn-small" id="unequip-confirm-btn">å¸ä¸‹</button>
                <button class="btn btn-secondary btn-small" onclick="game.closeUnequipModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== PERSISTENT DATA ====================
        const SAVE_KEY = 'magicTower_soulData_v2';
        const GAME_VERSION = '0.6';

        function getNewSoulData() {
            return {
                version: GAME_VERSION, 
                souls: 0,
                upgrades: {
                    vitality: 0,
                    strength: 0,
                    resilience: 0,
                    agility: 0,
                    precision: 0,
                    fortune: 0,
                    soulHarvest: 0,
                    potionMaster: 0,
                    startingGold: 0,
                    secondChance: 0
                },
                totalRuns: 0,
                bestFloor: 0,
                bossesKilled: 0
            };
        }

        function calculateTotalLifetimeSouls(oldData) {
            let total = oldData.souls || 0; // Start with currently held souls

            // Add up cost of every purchased upgrade
            if (oldData.upgrades) {
                Object.keys(oldData.upgrades).forEach(key => {
                    const level = oldData.upgrades[key];
                    const upgradeDef = SOUL_UPGRADES.find(u => u.id === key);
                    
                    if (upgradeDef && level > 0) {
                        // Sum cost for levels 0 to current_level-1
                        for (let i = 0; i < level; i++) {
                            total += Math.floor(upgradeDef.baseCost * Math.pow(upgradeDef.costMult, i));
                        }
                    }
                });
            }
            return total;
        }

        function loadSoulData() {
            const dataStr = localStorage.getItem(SAVE_KEY);
            
            // Default empty data if new player
            let data = dataStr ? JSON.parse(dataStr) : getNewSoulData();

            // --- VERSION CHECK & MIGRATION ---
            if (data.version !== GAME_VERSION) {
                console.log(`Version update detected: ${data.version || 'Unknown'} -> ${GAME_VERSION}`);
                
                // 1. Calculate Permanent Souls (Current + Spent on Upgrades)
                let totalVal = calculateTotalLifetimeSouls(data);

                // 2. [NEW] Check Active Run for Unbanked Souls
                const runStr = localStorage.getItem('magicTower_autoSave');
                if (runStr) {
                    try {
                        const runData = JSON.parse(runStr);
                        
                        // Add souls collected so far in this run
                        if (runData.soulGainedThisRun) {
                            totalVal += runData.soulGainedThisRun;
                        }
                        
                        // Add souls waiting in a loot box (if you just killed a mob but didn't collect yet)
                        if (runData.pendingLoot && runData.pendingLoot.souls) {
                            totalVal += runData.pendingLoot.souls;
                        }
                        
                        console.log(`Recovered unbanked souls from active run. New Total: ${totalVal}`);
                    } catch (e) {
                        console.error("Could not recover active run souls", e);
                    }
                }
                
                // 3. Calculate 50% Refund
                const refundAmount = Math.floor(totalVal * 0.5);
                
                // 4. Wipe Old Data
                localStorage.removeItem('magicTower_autoSave'); // Delete the run
                
                // 5. Create Fresh Soul Data with Refund
                const newData = getNewSoulData();
                newData.souls = refundAmount; 
                
                // 6. Save immediately
                saveSoulData(newData);

                // 7. Notify User
                alert(
                    `ğŸ‰ éŠæˆ²ç‰ˆæœ¬æ›´æ–°è‡³ v${GAME_VERSION}ï¼\n\n` +
                    `ç‚ºäº†å¹³è¡¡æ€§èª¿æ•´ï¼Œé€²åº¦å·²é‡ç½®ã€‚\n` +
                    `\nğŸ’° éˆé­‚è¨ˆç®—ï¼š\n` +
                    `åŒ…å«æ‚¨æ­£åœ¨é€²è¡Œçš„å†’éšªï¼Œç¸½è³‡ç”¢ç‚º ${totalVal} éˆé­‚ã€‚\n` +
                    `å·²ç‚ºæ‚¨ä¿ç•™ 50% (${refundAmount} éˆé­‚)ï¼`
                );
                
                return newData;
            }
            // ---------------------------------

            return data;
        }

        function saveSoulData(data) {
            // Ensure the version is always the current one when saving
            data.version = GAME_VERSION; 
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        }

        const SOUL_UPGRADES = [
            { id: 'vitality', name: 'ç”Ÿå‘½å¼·åŒ–', desc: 'æ°¸ä¹…å¢åŠ æœ€å¤§ç”Ÿå‘½å€¼', effect: '+10 ç”Ÿå‘½', maxLevel: 20, baseCost: 10, costMult: 1.5 },
            { id: 'strength', name: 'åŠ›é‡å¼·åŒ–', desc: 'æ°¸ä¹…å¢åŠ æ”»æ“ŠåŠ›', effect: '+2 æ”»æ“Š', maxLevel: 10, baseCost: 15, costMult: 1.5 },
            { id: 'resilience', name: 'å …éŸŒå¼·åŒ–', desc: 'æ°¸ä¹…å¢åŠ é˜²ç¦¦åŠ›', effect: '+2 é˜²ç¦¦', maxLevel: 10, baseCost: 15, costMult: 1.5 },
            { id: 'agility', name: 'æ•æ·å¼·åŒ–', desc: 'æ°¸ä¹…å¢åŠ é–ƒé¿ç‡', effect: '+1% é–ƒé¿', maxLevel: 5, baseCost: 15, costMult: 1.6 },
            { id: 'precision', name: 'ç²¾æº–å¼·åŒ–', desc: 'æ°¸ä¹…å¢åŠ çˆ†æ“Šç‡', effect: '+1% çˆ†æ“Š', maxLevel: 5, baseCost: 15, costMult: 1.6 },
            { id: 'fortune', name: 'è²¡é‹ç¥ç¦', desc: 'å¢åŠ é‡‘å¹£ç²å–é‡', effect: '+5% é‡‘å¹£', maxLevel: 10, baseCost: 20, costMult: 1.7 },
            { id: 'soulHarvest', name: 'éˆé­‚æ”¶å‰²', desc: 'å¢åŠ éˆé­‚ç¢ç‰‡ç²å–', effect: '+10% éˆé­‚', maxLevel: 10, baseCost: 25, costMult: 1.8 },
            { id: 'potionMaster', name: 'è—¥åŠ‘å¤§å¸«', desc: 'å¢åŠ è—¥æ°´æ•ˆæœ', effect: '+10% æ•ˆæœ', maxLevel: 10, baseCost: 18, costMult: 1.6 },
            { id: 'startingGold', name: 'åˆå§‹è³‡é‡‘', desc: 'æ¯æ¬¡å†’éšªé–‹å§‹æ™‚ç²å¾—é¡å¤–é‡‘å¹£', effect: '+25 é‡‘å¹£', maxLevel: 10, baseCost: 15, costMult: 1.5 },
            { id: 'secondChance', name: 'ä¸æ­»æ±ºå¿ƒ', desc: 'å—åˆ°è‡´å‘½å‚·å®³æ™‚æœ‰æ©Ÿæœƒå­˜æ´»', effect: '+5% æ©Ÿç‡', maxLevel: 10, baseCost: 30, costMult: 2.0 }
        ];

        // ==================== GAME DATA ====================
        
        const AREA_NAMES_CN = ['', 'ç¬¬ä¸€å€', 'ç¬¬äºŒå€', 'ç¬¬ä¸‰å€', 'ç¬¬å››å€', 'ç¬¬äº”å€', 'ç¬¬å…­å€', 'ç¬¬ä¸ƒå€', 'ç¬¬å…«å€', 'ç¬¬ä¹å€', 'ç¬¬åå€'];
        
        const AREAS = [
            { id: 1, name: 'åœ°ä¸‹ç›£ç‰¢', icon: 'â›“ï¸', desc: 'é™°æš—æ½®æ¿•çš„ç›£ç‰¢ï¼Œé—œæŠ¼è‘—è¢«éºå¿˜çš„éˆé­‚...', startFloor: 1 },
            { id: 2, name: 'é™°æš—æ´çªŸ', icon: 'ğŸ•³ï¸', desc: 'èœ¿èœ’æ›²æŠ˜çš„æ´ç©´ï¼Œè¿´ç›ªè‘—ä¸ç¥¥çš„è²éŸ¿...', startFloor: 51 },
            { id: 3, name: 'éª·é«å¢“åœ°', icon: 'ğŸ’€', desc: 'äº¡éˆéŠè•©çš„ç¦åœ°ï¼Œç©ºæ°£ä¸­ç€°æ¼«è‘—æ­»äº¡çš„æ°£æ¯...', startFloor: 101 },
            { id: 4, name: 'å¹½æš—æ£®æ—', icon: 'ğŸŒ²', desc: 'æ°¸å¤œç± ç½©çš„æ£®æ—ï¼Œæ¨¹æœ¨ä¹‹é–“æ½›ä¼è‘—å±éšª...', startFloor: 151 },
            { id: 5, name: 'é­”æ³•å¯¦é©—å®¤', icon: 'ğŸ§ª', desc: 'ç˜‹ç‹‚æ³•å¸«çš„å¯¦é©—å ´ï¼Œåˆ°è™•éƒ½æ˜¯å¤±æ•—çš„é€ ç‰©...', startFloor: 201 },
            { id: 6, name: 'æƒ¡é­”æ®¿å ‚', icon: 'ğŸ‘¿', desc: 'æƒ¡é­”èšé›†çš„å¤§å»³ï¼Œé‚ªæƒ¡çš„åŠ›é‡åœ¨æ­¤åŒ¯èš...', startFloor: 251 },
            { id: 7, name: 'å†°éœœèµ°å»Š', icon: 'â„ï¸', desc: 'å¯’å†·åˆºéª¨çš„é€šé“ï¼Œå‡çµçš„å±é«”éš¨è™•å¯è¦‹...', startFloor: 301 },
            { id: 8, name: 'çƒˆç„°é€šé“', icon: 'ğŸ”¥', desc: 'ç†”å²©æµæ·Œçš„åœ°ç„ï¼Œé«˜æº«è¶³ä»¥èåŒ–ä¸€åˆ‡...', startFloor: 351 },
            { id: 9, name: 'è™›ç©ºè£‚éš™', icon: 'ğŸŒ€', desc: 'ç©ºé–“æ‰­æ›²çš„ç•°ç•Œï¼Œç¾å¯¦çš„æ³•å‰‡åœ¨æ­¤å¤±æ•ˆ...', startFloor: 401 },
            { id: 10, name: 'é­”ç‹å¯¶åº§', icon: 'ğŸ‘‘', desc: 'é­”ç‹çš„ç‹åº§ä¹‹é–“ï¼Œå…¬ä¸»å°±åœ¨é€™è£¡ç­‰å¾…æ•‘æ´ï¼', startFloor: 451 }
        ];

        const STORY_DIALOGUES = {
            start: {
                speaker: 'è€åœ‹ç‹',
                text: 'å‹‡æ•¢çš„é¨å£«å•Šï¼Œæˆ‘çš„å¥³å…’è¢«é­”ç‹æŠ“èµ°äº†ã€‚è«‹ä½ ä¸€å®šè¦æ•‘å›å¥¹ï¼é€™æŠŠåŠæ˜¯å…ˆç‹ç•™ä¸‹çš„å¯¶ç‰©ï¼Œå¸Œæœ›èƒ½åŠ©ä½ ä¸€è‡‚ä¹‹åŠ›ã€‚'
            },
            area2: {
                speaker: 'ç¥ç§˜å¹½éˆ',
                text: 'æ´»äººï¼Ÿåœ¨é€™é­”å¡”ä¸­é‚„èƒ½è¦‹åˆ°æ´»äºº...ä½ æ˜¯ä¾†æ•‘é‚£ä½å…¬ä¸»çš„å§ï¼Ÿå°å¿ƒï¼Œè¶Šå¾€ä¸Šèµ°ï¼Œé­”ç‰©è¶Šå¼·å¤§...'
            },
            area3: {
                speaker: 'è¢«å›šç¦çš„å£«å…µ',
                text: 'å’³å’³...é¨å£«å¤§äººï¼Ÿæˆ‘æ˜¯å…ˆé£éšŠçš„å€–å­˜è€…...å…¶ä»–äººéƒ½...å…¬ä¸»æ‡‰è©²è¢«é—œåœ¨æœ€é ‚å±¤ï¼Œé­”ç‹å¾ˆå¼·ï¼Œè«‹å‹™å¿…å°å¿ƒï¼'
            },
            area5: {
                speaker: 'æ„›è‰çµ²å…¬ä¸»ï¼ˆé è™•çš„è²éŸ³ï¼‰',
                text: 'æœ‰äººåœ¨å—ï¼Ÿè«‹æ•‘æ•‘æˆ‘...æˆ‘èƒ½æ„Ÿè¦ºåˆ°æœ‰äººåœ¨æ¥è¿‘...æ˜¯é¨å£«å¤§äººå—ï¼Ÿè«‹å¿«ä¾†æ•‘æˆ‘ï¼'
            },
            area7: {
                speaker: 'é­”ç‹çš„å½±å­',
                text: 'å“¼å“¼å“¼...åˆä¸€å€‹ä¸è‡ªé‡åŠ›çš„äººé¡ã€‚ä½ ä»¥ç‚ºèƒ½æ•‘èµ°å…¬ä¸»ï¼Ÿæˆ‘åœ¨é ‚å±¤ç­‰è‘—ä½ ï¼Œä¾†é€æ­»å§ï¼'
            },
            area9: {
                speaker: 'æ„›è‰çµ²å…¬ä¸»',
                text: 'é¨å£«å¤§äººï¼ä½ çœŸçš„ä¾†äº†ï¼é­”ç‹å°±åœ¨ä¸Šé¢...ä»–å¾ˆå¼·å¤§ï¼Œä½†æˆ‘ç›¸ä¿¡ä½ ä¸€å®šèƒ½æ‰“æ•—ä»–ï¼'
            },
            bossDefeat: {
                speaker: 'æ„›è‰çµ²å…¬ä¸»',
                text: 'å¤ªå¥½äº†ï¼ä½ æ‰“æ•—ä»–äº†ï¼è¬è¬ä½ ï¼Œå‹‡æ•¢çš„é¨å£«...è®“æˆ‘å€‘ä¸€èµ·å›å®¶å§ï¼'
            }
        };

        const MATERIALS = {
    // Area 1
    slime_gel: { name: 'å²èŠå§†å‡è† ', emoji: 'ğŸŸ¢', basePrice: 5, rarity: 'common' },
    rat_tail: { name: 'è€é¼ å°¾å·´', emoji: 'ğŸ', basePrice: 6, rarity: 'common' },
    bat_fang: { name: 'è™è å°–ç‰™', emoji: 'ğŸ¦·', basePrice: 7, rarity: 'common' },
    
    // Area 2
    spider_leg: { name: 'èœ˜è››æ–·è…¿', emoji: 'ğŸ¦µ', basePrice: 12, rarity: 'common' },
    goblin_ear: { name: 'å“¥å¸ƒæ—è€³æœµ', emoji: 'ğŸ‘‚', basePrice: 15, rarity: 'common' },
    cave_bat_wing: { name: 'æ´ç©´è™è ç¿¼', emoji: 'ğŸ¦‡', basePrice: 14, rarity: 'common' },
    
    // Area 3
    rib_bone: { name: 'è…æœ½è‚‹éª¨', emoji: 'ğŸ¦´', basePrice: 25, rarity: 'uncommon' },
    zombie_flesh: { name: 'æ„ŸæŸ“è…è‚‰', emoji: 'ğŸ§Ÿ', basePrice: 28, rarity: 'uncommon' },
    ectoplasm: { name: 'å¹½éˆéˆè³ª', emoji: 'ğŸ‘»', basePrice: 35, rarity: 'uncommon' },
    
    // Area 4
    wolf_pelt: { name: 'ç‹¼äººæ¯›çš®', emoji: 'ğŸº', basePrice: 45, rarity: 'uncommon' },
    dryad_branch: { name: 'æ¨¹å¦–æ¯æ', emoji: 'ğŸ‚', basePrice: 50, rarity: 'uncommon' },
    poison_gland: { name: 'åŠ‡æ¯’å›Šè…º', emoji: 'ğŸ§ª', basePrice: 48, rarity: 'uncommon' },
    
    // Area 5
    stone_heart: { name: 'çŸ³åƒé¬¼ä¹‹å¿ƒ', emoji: 'ğŸ—¿', basePrice: 70, rarity: 'rare' },
    puppet_gear: { name: 'é­”å¶é½’è¼ª', emoji: 'âš™ï¸', basePrice: 75, rarity: 'rare' },
    mutant_fluid: { name: 'çªè®Šé«”æ¶²', emoji: 'ğŸ¦ ', basePrice: 80, rarity: 'rare' },
    
    // Area 6
    imp_horn: { name: 'å°æƒ¡é­”è§’', emoji: 'ğŸ˜ˆ', basePrice: 100, rarity: 'rare' },
    hellhound_ash: { name: 'åœ°ç„çŠ¬ç°ç‡¼', emoji: 'ğŸ•', basePrice: 110, rarity: 'rare' },
    black_feather: { name: 'å¢®è½é»‘ç¾½', emoji: 'ğŸª¶', basePrice: 120, rarity: 'rare' },
    
    // Area 7
    frost_core: { name: 'æ°¸å‡æ ¸å¿ƒ', emoji: 'â„ï¸', basePrice: 150, rarity: 'rare' },
    wraith_dust: { name: 'å†¤é­‚å¡µåŸƒ', emoji: 'ğŸŒªï¸', basePrice: 160, rarity: 'rare' },
    ice_wolf_claw: { name: 'å†°ç‹¼åˆ©çˆª', emoji: 'ğŸ¾', basePrice: 155, rarity: 'rare' },
    
    // Area 8
    ember_spark: { name: 'ä¸æ»…ç«ç¨®', emoji: 'ğŸ”¥', basePrice: 200, rarity: 'epic' },
    magma_rock: { name: 'ç†”å²©å‡å¡Š', emoji: 'ğŸŒ‹', basePrice: 220, rarity: 'epic' },
    salamander_scale: { name: 'ç«èœ¥èœ´é±—', emoji: 'ğŸ¦', basePrice: 210, rarity: 'epic' },
    
    // Area 9
    void_dust: { name: 'è™›ç©ºæ˜Ÿå¡µ', emoji: 'âœ¨', basePrice: 280, rarity: 'epic' },
    alien_eye: { name: 'ç•°ç•Œçœ¼çƒ', emoji: 'ğŸ‘ï¸', basePrice: 300, rarity: 'epic' },
    chaos_shard: { name: 'æ··æ²Œç¢ç‰‡', emoji: 'ğŸŒ€', basePrice: 320, rarity: 'epic' },
    
    // Area 10
    guard_badge: { name: 'è¿‘è¡›å‹³ç« ', emoji: 'ğŸ–ï¸', basePrice: 400, rarity: 'epic' },
    dragon_scale: { name: 'é»‘é¾é€†é±—', emoji: 'ğŸ‰', basePrice: 500, rarity: 'legendary' },
    dark_metal: { name: 'æ­»äº¡é‡‘å±¬', emoji: 'â›“ï¸', basePrice: 450, rarity: 'epic' },

    // Bosses - âœ… All boss materials are legendary!
    boss_1: { name: 'çœ‹å®ˆé‘°åŒ™', emoji: 'ğŸ—ï¸', basePrice: 100, rarity: 'rare' },
    boss_2: { name: 'è››åæ¯’ç‰™', emoji: 'ğŸ•·ï¸', basePrice: 150, rarity: 'rare' },
    boss_3: { name: 'é ˜ä¸»é ­éª¨', emoji: 'ğŸ’€', basePrice: 250, rarity: 'rare' },
    boss_4: { name: 'æ£®æ—ä¹‹å¿ƒ', emoji: 'ğŸ’š', basePrice: 350, rarity: 'epic' },
    boss_5: { name: 'è³¢è€…ä¹‹çŸ³', emoji: 'ğŸ’', basePrice: 500, rarity: 'epic' },
    boss_6: { name: 'æƒ¡é­”ä¹‹è¡€', emoji: 'ğŸ·', basePrice: 650, rarity: 'epic' },
    boss_7: { name: 'å†°éœœçš‡å† ', emoji: 'ğŸ‘‘', basePrice: 850, rarity: 'legendary' },
    boss_8: { name: 'ç‚é­”æ ¸å¿ƒ', emoji: 'ğŸŒ', basePrice: 1100, rarity: 'legendary' },
    boss_9: { name: 'è™›ç©ºæ°´æ™¶', emoji: 'ğŸ”®', basePrice: 1500, rarity: 'legendary' },
    boss_10: { name: 'é­”ç‹éˆé­‚', emoji: 'ğŸ‘¹', basePrice: 5000, rarity: 'legendary' }
};

        const MONSTERS_BY_AREA = {
            1: [
                { name: 'å²èŠå§†', emoji: 'ğŸŸ¢', baseHp: 30, baseAtk: 8, baseDef: 2, goldMin: 5, goldMax: 12, material: 'slime_gel', matChance: 0.4 },
                { name: 'è€é¼ ', emoji: 'ğŸ€', baseHp: 25, baseAtk: 10, baseDef: 1, goldMin: 4, goldMax: 10, material: 'rat_tail', matChance: 0.35 },
                { name: 'è™è ', emoji: 'ğŸ¦‡', baseHp: 22, baseAtk: 12, baseDef: 1, goldMin: 5, goldMax: 11, material: 'bat_fang', matChance: 0.35 },
            ],
            2: [
                { name: 'èœ˜è››', emoji: 'ğŸ•·ï¸', baseHp: 40, baseAtk: 15, baseDef: 4, goldMin: 8, goldMax: 18, material: 'spider_leg', matChance: 0.4 },
                { name: 'å“¥å¸ƒæ—', emoji: 'ğŸ‘º', baseHp: 50, baseAtk: 18, baseDef: 5, goldMin: 10, goldMax: 22, material: 'goblin_ear', matChance: 0.45 },
                { name: 'æ´ç©´è™è ', emoji: 'ğŸ¦‡', baseHp: 35, baseAtk: 20, baseDef: 3, goldMin: 9, goldMax: 20, material: 'cave_bat_wing', matChance: 0.35 },
            ],
            3: [
                { name: 'éª·é«', emoji: 'ğŸ’€', baseHp: 60, baseAtk: 22, baseDef: 8, goldMin: 15, goldMax: 30, material: 'rib_bone', matChance: 0.4 },
                { name: 'æ®­å±', emoji: 'ğŸ§Ÿ', baseHp: 80, baseAtk: 20, baseDef: 10, goldMin: 18, goldMax: 35, material: 'zombie_flesh', matChance: 0.35 },
                { name: 'å¹½éˆ', emoji: 'ğŸ‘»', baseHp: 50, baseAtk: 28, baseDef: 5, goldMin: 20, goldMax: 40, material: 'ectoplasm', matChance: 0.3 },
            ],
            4: [
                { name: 'ç‹¼äºº', emoji: 'ğŸº', baseHp: 90, baseAtk: 30, baseDef: 12, goldMin: 25, goldMax: 45, material: 'wolf_pelt', matChance: 0.4 },
                { name: 'æ¨¹å¦–', emoji: 'ğŸŒ³', baseHp: 120, baseAtk: 25, baseDef: 18, goldMin: 28, goldMax: 50, material: 'dryad_branch', matChance: 0.35 },
                { name: 'æ¯’èœ˜è››', emoji: 'ğŸ•·ï¸', baseHp: 70, baseAtk: 35, baseDef: 8, goldMin: 22, goldMax: 42, material: 'poison_gland', matChance: 0.4 },
            ],
            5: [
                { name: 'çŸ³åƒé¬¼', emoji: 'ğŸ—¿', baseHp: 200, baseAtk: 45, baseDef: 25, goldMin: 40, goldMax: 65, material: 'stone_heart', matChance: 0.35 },
                { name: 'é­”å¶', emoji: 'ğŸ­', baseHp: 180, baseAtk: 50, baseDef: 20, goldMin: 45, goldMax: 70, material: 'puppet_gear', matChance: 0.3 },
                { name: 'å¤±æ•—å¯¦é©—é«”', emoji: 'ğŸ§ª', baseHp: 220, baseAtk: 48, baseDef: 22, goldMin: 45, goldMax: 75, material: 'mutant_fluid', matChance: 0.35 },
            ],
            6: [
                { name: 'å°æƒ¡é­”', emoji: 'ğŸ˜ˆ', baseHp: 300, baseAtk: 65, baseDef: 30, goldMin: 60, goldMax: 90, material: 'imp_horn', matChance: 0.35 },
                { name: 'åœ°ç„çŠ¬', emoji: 'ğŸ•', baseHp: 320, baseAtk: 70, baseDef: 28, goldMin: 65, goldMax: 100, material: 'hellhound_ash', matChance: 0.3 },
                { name: 'å¢®è½å¤©ä½¿', emoji: 'ğŸ‘¼', baseHp: 280, baseAtk: 75, baseDef: 25, goldMin: 70, goldMax: 110, material: 'black_feather', matChance: 0.3 },
            ],
            7: [
                { name: 'å†°éœœå·¨äºº', emoji: 'ğŸ§Š', baseHp: 450, baseAtk: 85, baseDef: 40, goldMin: 80, goldMax: 130, material: 'frost_core', matChance: 0.35 },
                { name: 'å¯’å†°å¹½é­‚', emoji: 'ğŸ‘»', baseHp: 300, baseAtk: 95, baseDef: 25, goldMin: 85, goldMax: 140, material: 'wraith_dust', matChance: 0.3 },
                { name: 'å†°ç‹¼', emoji: 'ğŸº', baseHp: 380, baseAtk: 90, baseDef: 35, goldMin: 80, goldMax: 135, material: 'ice_wolf_claw', matChance: 0.35 },
            ],
            8: [
                { name: 'ç«ç„°ç²¾éˆ', emoji: 'ğŸ”¥', baseHp: 400, baseAtk: 110, baseDef: 35, goldMin: 100, goldMax: 160, material: 'ember_spark', matChance: 0.35 },
                { name: 'ç†”å²©å·¨äºº', emoji: 'ğŸŒ‹', baseHp: 650, baseAtk: 100, baseDef: 55, goldMin: 110, goldMax: 180, material: 'magma_rock', matChance: 0.3 },
                { name: 'ç«èœ¥èœ´', emoji: 'ğŸ¦', baseHp: 480, baseAtk: 105, baseDef: 45, goldMin: 105, goldMax: 170, material: 'salamander_scale', matChance: 0.35 },
            ],
            9: [
                { name: 'è™›ç©ºè¡Œè€…', emoji: 'ğŸŒ€', baseHp: 700, baseAtk: 130, baseDef: 50, goldMin: 140, goldMax: 220, material: 'void_dust', matChance: 0.3 },
                { name: 'ç•°ç•Œçµæ‰‹', emoji: 'ğŸ‘ï¸', baseHp: 600, baseAtk: 145, baseDef: 40, goldMin: 150, goldMax: 240, material: 'alien_eye', matChance: 0.3 },
                { name: 'æ··æ²Œä½¿è€…', emoji: 'ğŸ’«', baseHp: 650, baseAtk: 150, baseDef: 45, goldMin: 160, goldMax: 250, material: 'chaos_shard', matChance: 0.25 },
            ],
            10: [
                { name: 'é­”ç‹è¿‘è¡›', emoji: 'âš”ï¸', baseHp: 900, baseAtk: 170, baseDef: 60, goldMin: 200, goldMax: 300, material: 'guard_badge', matChance: 0.3 },
                { name: 'æš—é»‘é¾', emoji: 'ğŸ‰', baseHp: 1200, baseAtk: 180, baseDef: 70, goldMin: 250, goldMax: 400, material: 'dragon_scale', matChance: 0.35 },
                { name: 'æ­»äº¡é¨å£«', emoji: 'ğŸ—¡ï¸', baseHp: 1000, baseAtk: 190, baseDef: 65, goldMin: 220, goldMax: 350, material: 'dark_metal', matChance: 0.3 },
            ]
        };

        // Chest Mimics by Area
        const CHEST_MIMICS = {
            1: { name: 'å¯¶ç®±æ€ª', emoji: 'ğŸ“¦', hpMult: 1.2, atkMult: 1.2, defMult: 1.0 },
            2: { name: 'è²ªå©ªé­”ç®±', emoji: 'ğŸ', hpMult: 1.2, atkMult: 1.3, defMult: 1.0 },
            3: { name: 'è©›å’’å¯¶ç®±', emoji: 'ğŸ’€', hpMult: 1.3, atkMult: 1.3, defMult: 1.1 },
            4: { name: 'æ£®æ—å¯„ç”Ÿç®±', emoji: 'ğŸŒ¿', hpMult: 1.3, atkMult: 1.4, defMult: 1.1 },
            5: { name: 'é­”æ³•ç®±é­”', emoji: 'âœ¨', hpMult: 1.4, atkMult: 1.4, defMult: 1.2 },
            6: { name: 'æƒ¡é­”å¯¶ç®±', emoji: 'ğŸ˜ˆ', hpMult: 1.4, atkMult: 1.5, defMult: 1.2 },
            7: { name: 'å†°å‡é­”ç®±', emoji: 'ğŸ§Š', hpMult: 1.5, atkMult: 1.5, defMult: 1.3 },
            8: { name: 'çƒˆç„°é­”ç®±', emoji: 'ğŸ”¥', hpMult: 1.5, atkMult: 1.6, defMult: 1.3 },
            9: { name: 'è™›ç©ºåå™¬è€…', emoji: 'ğŸŒ‘', hpMult: 1.6, atkMult: 1.6, defMult: 1.4 },
            10: { name: 'é­”ç‹çš„å¯¶ç‰©', emoji: 'ğŸ‘‘', hpMult: 1.8, atkMult: 1.5, defMult: 1.5 } // Reduced Atk Mult from 2.0 to 1.5
        };

        const AREA_BOSSES = {
            1: { name: 'ç›£ç„çœ‹å®ˆé•·', emoji: 'ğŸ‘¹', baseHp: 400, baseAtk: 35, baseDef: 15, goldMin: 100, goldMax: 200, soulReward: 15, material: 'boss_1' },
            2: { name: 'æ´çªŸèœ˜è››å', emoji: 'ğŸ•·ï¸', baseHp: 700, baseAtk: 50, baseDef: 25, goldMin: 150, goldMax: 250, soulReward: 25, material: 'boss_2' },
            3: { name: 'éª·é«é ˜ä¸»', emoji: 'â˜ ï¸', baseHp: 1000, baseAtk: 70, baseDef: 35, goldMin: 250, goldMax: 400, soulReward: 40, material: 'boss_3' },
            4: { name: 'æ£®æ—å®ˆè­·è€…', emoji: 'ğŸŒ²', baseHp: 1500, baseAtk: 85, baseDef: 45, goldMin: 400, goldMax: 600, soulReward: 60, material: 'boss_4' },
            5: { name: 'ç˜‹ç‹‚éŠé‡‘è¡“å¸«', emoji: 'ğŸ§™', baseHp: 2000, baseAtk: 100, baseDef: 55, goldMin: 600, goldMax: 900, soulReward: 80, material: 'boss_5' },
            6: { name: 'æƒ¡é­”å°‡è»', emoji: 'ğŸ‘¿', baseHp: 2800, baseAtk: 130, baseDef: 70, goldMin: 800, goldMax: 1200, soulReward: 120, material: 'boss_6' },
            7: { name: 'å†°éœœå¥³ç‹', emoji: 'ğŸ‘¸', baseHp: 3500, baseAtk: 160, baseDef: 85, goldMin: 1000, goldMax: 1500, soulReward: 160, material: 'boss_7' },
            8: { name: 'çƒˆç„°é­”å›', emoji: 'ğŸ”¥', baseHp: 4200, baseAtk: 200, baseDef: 100, goldMin: 1500, goldMax: 2200, soulReward: 220, material: 'boss_8' },
            9: { name: 'è™›ç©ºé ˜ä¸»', emoji: 'ğŸŒ‘', baseHp: 5000, baseAtk: 240, baseDef: 115, goldMin: 2000, goldMax: 3000, soulReward: 300, material: 'boss_9' },
            10: { name: 'é­”ç‹', emoji: 'ğŸ‘‘', baseHp: 8000, baseAtk: 300, baseDef: 140, goldMin: 5000, goldMax: 10000, soulReward: 500, material: 'boss_10' }
        };

        const EQUIPMENT = {
            weapons: [
                { name: 'ç”Ÿé½çš„åŠ', rarity: 'common', attack: 5, defense: 0, dodge: 0, crit: 1, hp: 0 },
                { name: 'éµåŠ', rarity: 'common', attack: 10, defense: 0, dodge: 0, crit: 2, hp: 0 }, // Buffed
                { name: 'çµäººçŸ­åˆ€', rarity: 'common', attack: 6, defense: 0, dodge: 2, crit: 3, hp: 0 },

                { name: 'é‹¼åˆƒ', rarity: 'uncommon', attack: 20, defense: 2, dodge: 1, crit: 3, hp: 0 }, // Buffed
                { name: 'é™„é­”ä¹‹åŠ', rarity: 'uncommon', attack: 25, defense: 5, dodge: 0, crit: 5, hp: 0 }, // Buffed
                { name: 'åˆºå®¢åŒ•é¦–', rarity: 'uncommon', attack: 18, defense: 0, dodge: 5, crit: 10, hp: 0 }, // Buffed

                { name: 'çƒˆç„°ä¹‹åˆƒ', rarity: 'rare', attack: 45, defense: 0, dodge: 3, crit: 8, hp: 0 }, // Buffed from 28
                { name: 'éœœå¯’ä¹‹åˆƒ', rarity: 'rare', attack: 40, defense: 10, dodge: 0, crit: 6, hp: 20 }, // Buffed
                { name: 'æš—å½±åŒ•é¦–', rarity: 'rare', attack: 35, defense: 0, dodge: 8, crit: 15, hp: 0 }, // Buffed
                
                // End Game (Areas 9-10)
                { name: 'å± é¾è€…', rarity: 'epic', attack: 75, defense: 15, dodge: 4, crit: 12, hp: 50 }, // Buffed from 45
                { name: 'è‡´å‘½ç´°åŠ', rarity: 'epic', attack: 65, defense: 5, dodge: 12, crit: 25, hp: 0 }, // Buffed
                { name: 'è–åŠ', rarity: 'legendary', attack: 120, defense: 30, dodge: 8, crit: 20, hp: 100 }, // Buffed from 70
            ],
            armor: [
                { name: 'å¸ƒç”²', rarity: 'common', attack: 0, defense: 4, dodge: 1, crit: 0, hp: 10 },
                { name: 'çš®ç”²', rarity: 'common', attack: 0, defense: 6, dodge: 2, crit: 0, hp: 15 },
                { name: 'çµäººçš®ç”²', rarity: 'common', attack: 2, defense: 5, dodge: 3, crit: 1, hp: 12 },
                { name: 'é–å­ç”²', rarity: 'uncommon', attack: 0, defense: 14, dodge: 0, crit: 0, hp: 30 },
                { name: 'å¼·åŒ–çš®ç”²', rarity: 'uncommon', attack: 3, defense: 12, dodge: 3, crit: 2, hp: 25 },
                { name: 'åˆºå®¢å¥—è£', rarity: 'uncommon', attack: 5, defense: 8, dodge: 6, crit: 5, hp: 15 },
                { name: 'æ¿ç”²', rarity: 'rare', attack: 0, defense: 40, dodge: -5, crit: 0, hp: 100 }, // Buffed
                { name: 'ç§˜éŠ€ç”²', rarity: 'rare', attack: 8, defense: 35, dodge: 4, crit: 4, hp: 80 }, // Buffed
                { name: 'é¾é±—ç”²', rarity: 'epic', attack: 15, defense: 65, dodge: 3, crit: 6, hp: 200 }, // Buffed
                { name: 'å¹»å½±æŠ«é¢¨', rarity: 'epic', attack: 25, defense: 45, dodge: 20, crit: 15, hp: 80 }, // Buffed
                { name: 'ç¥è–æ¿ç”²', rarity: 'legendary', attack: 40, defense: 100, dodge: 5, crit: 10, hp: 300 }, // Massive Buff
            ],
            accessories: [
                { name: 'éŠ…æˆ’æŒ‡', rarity: 'common', attack: 2, defense: 2, dodge: 1, crit: 1, hp: 5 },
                { name: 'éŠ€è­·ç¬¦', rarity: 'common', attack: 3, defense: 3, dodge: 0, crit: 1, hp: 8 },
                { name: 'ç”Ÿå‘½å¢œé£¾', rarity: 'common', attack: 0, defense: 2, dodge: 0, crit: 0, hp: 20 },
                { name: 'ç´…å¯¶çŸ³æˆ’æŒ‡', rarity: 'uncommon', attack: 8, defense: 0, dodge: 2, crit: 3, hp: 10 },
                { name: 'è—å¯¶çŸ³åŠå¢œ', rarity: 'uncommon', attack: 0, defense: 8, dodge: 3, crit: 2, hp: 25 },
                { name: 'ç”Ÿå‘½è­·ç¬¦', rarity: 'uncommon', attack: 2, defense: 4, dodge: 0, crit: 0, hp: 40 },
                { name: 'ç¿¡ç¿ è­·ç¬¦', rarity: 'rare', attack: 10, defense: 10, dodge: 5, crit: 5, hp: 30 },
                { name: 'é‘½çŸ³æˆ’æŒ‡', rarity: 'rare', attack: 25, defense: 10, dodge: 5, crit: 12, hp: 40 }, // Buffed
                { name: 'ä¸æ­»è­·ç¬¦', rarity: 'rare', attack: 5, defense: 8, dodge: 2, crit: 2, hp: 70 },
                { name: 'é³³å‡°ç¾½é£¾', rarity: 'epic', attack: 35, defense: 25, dodge: 10, crit: 15, hp: 100 }, // Buffed
                { name: 'é¾ä¹‹å¿ƒ', rarity: 'epic', attack: 25, defense: 20, dodge: 5, crit: 8, hp: 100 },
                { name: 'æ™‚ä»£ä¹‹å† ', rarity: 'legendary', attack: 60, defense: 50, dodge: 15, crit: 20, hp: 200 }, // Massive Buff
            ]
        };

        const POTION_TYPES = {
            small: { name: 'å°å‹è—¥æ°´', healPercent: 0.15, basePrice: 20, emoji: 'ğŸ§ª' },
            medium: { name: 'ä¸­å‹è—¥æ°´', healPercent: 0.25, basePrice: 45, emoji: 'ğŸ§´' },
            large: { name: 'å¤§å‹è—¥æ°´', healPercent: 0.40, basePrice: 80, emoji: 'âš—ï¸' },
            full: { name: 'å®Œå…¨æ¢å¾©', healPercent: 1.0, basePrice: 130, emoji: 'ğŸ’Š' }
        };

        const RARITY_NAMES = {
            common: 'æ™®é€š',
            uncommon: 'å„ªè‰¯',
            rare: 'ç¨€æœ‰',
            epic: 'å²è©©',
            legendary: 'å‚³èªª'
        };

        const SLOT_NAMES = {
            weapon: 'æ­¦å™¨',
            armor: 'è­·ç”²',
            accessory: 'é£¾å“'
        };

        const EVENTS = {
            fight: { weight: 60, icon: 'âš”ï¸', title: 'é­é‡æ€ªç‰©ï¼' },
            treasure: { weight: 10, icon: 'ğŸ’', title: 'ç™¼ç¾å¯¶ç®±ï¼' },
            merchant: { weight: 10, icon: 'ğŸª', title: 'æµæµªå•†äºº' },
            event: { weight: 15, icon: 'â“', title: 'ç¥ç§˜äº‹ä»¶' },
            rest: { weight: 5, icon: 'ğŸ•ï¸', title: 'å®‰å…¨å€åŸŸ' }
        };

        const AREA_EVENTS = {
            // Area 1: Underground Prison (åœ°ä¸‹ç›£ç‰¢)
            1: [
                {
                    name: 'ç”Ÿé½çš„ç‰¢é–€', icon: 'ğŸšª', description: 'ä¸€æ‰‡åŠæ©çš„ç‰¢é–€ï¼Œè£¡é¢é»‘æ¼†æ¼†çš„ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 30 + game.level; game.player.gold += g; return `ä½ åœ¨ç¨»è‰å †ä¸‹æ‰¾åˆ°äº† ${g} é‡‘å¹£ï¼`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `é–€è»¸æ–·äº†ï¼ç ¸åˆ°ä½ çš„è…³ï¼Œå—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'ç™¼éœ‰çš„éºµåŒ…', icon: 'ğŸ', description: 'æ¡Œä¸Šæ”¾è‘—ä¸€å¡Šç™¼éœ‰çš„éºµåŒ…ï¼Œä½ è‚šå­æ­£å¥½é¤“äº†...',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.2); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // âœ… FIX
                            return `é›–ç„¶å‘³é“æ€ªæ€ªçš„ï¼Œä½†æ„å¤–åœ°æ¢å¾©äº† ${h} é«”åŠ›ã€‚`; 
                        },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `å˜”...é€™éºµåŒ…å£äº†ï¼Œä½ é£Ÿç‰©ä¸­æ¯’å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'ç˜‹ç‹‚å›šçŠ¯', icon: 'ğŸ¤ª', description: 'ä¸€å€‹è¢«é—œå¤ªä¹…çš„å›šçŠ¯åœ¨è‡ªè¨€è‡ªèªã€‚è¦æ­è©±å—ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ç˜‹ç‹‚ä¹‹åŠ›', 10, 'attack', 5, 'positive'); return `ä»–æ•™äº†ä½ ä¸€ç¨®ç˜‹ç‹‚çš„æˆ°é¬¥æ³•ï¼æ”»æ“Š +5 (10å±¤)`; },
                        () => { game.addBuff('ç²¾ç¥æ±¡æŸ“', 10, 'defense', -3, 'negative'); return `ä»–çš„ç˜‹è¨€ç˜‹èªè®“ä½ é ­ç—›æ¬²è£‚ã€‚é˜²ç¦¦ -3 (10å±¤)`; }
                    )
                },
                {
                    name: 'è€é¼ æ´', icon: 'ğŸ•³ï¸', description: 'ç‰†è§’æœ‰å€‹è€é¼ æ´ï¼Œè£¡é¢ä¼¼ä¹æœ‰æ±è¥¿åœ¨é–ƒå…‰ã€‚',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['rat_tail'] = (game.player.materials['rat_tail']||0)+1; return `ä½ æŠ“åˆ°äº†ä¸€éš»è€é¼ ï¼ç²å¾— [è€é¼ å°¾å·´]`; },
                        () => { const d = 10; game.player.hp = Math.max(0, game.player.hp - d); return `å“å”·ï¼æ‰‹æŒ‡è¢«è€é¼ å’¬äº†ä¸€å£ï¼Œå—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {   // Positive
                    name: 'å‰äººçš„éºç‰©', icon: 'ğŸ’', description: 'ä¸€ä½è¶Šç„æˆåŠŸçš„çŠ¯äººç•™ä¸‹çš„è£œçµ¦åŒ…ã€‚',
                    resolve: (game) => { const g = 50; game.player.gold += g; return { text: `é‹æ°£çœŸå¥½ï¼è£¡é¢æœ‰ ${g} é‡‘å¹£å’Œä¸€äº›ä¹¾ç³§ã€‚`, type: 'positive' }; }
                }
            ],

            // Area 2: Dark Cave (é™°æš—æ´çªŸ)
            2: [
                {
                    name: 'ç™¼å…‰è‹”è˜š', icon: 'ğŸŒ¿', description: 'ç‰†ä¸Šé•·æ»¿äº†ç™¼å‡ºå¹½å…‰çš„è‹”è˜šã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å¤œè¦–', 20, 'dodge', 10, 'positive'); return `åƒäº†ä¹‹å¾Œè¦–åŠ›è®Šå¥½äº†ï¼é–ƒé¿ +10% (20å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `æœ‰æ¯’ï¼èˆŒé ­éº»ç—ºäº†ï¼Œå—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'å»¢æ£„ç¤¦è»Š', icon: 'ğŸ›’', description: 'ä¸€è¼›ç¿»å€’çš„ç¤¦è»Šï¼Œæˆ–è¨±é‚„èƒ½ç”¨ã€‚',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['goblin_ear'] = (game.player.materials['goblin_ear']||0)+1; return `åœ¨è»Šåº•ç™¼ç¾äº†å“¥å¸ƒæ—çš„è—å¯¶ï¼ç²å¾— [å“¥å¸ƒæ—è€³æœµ]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `ç¤¦è»Šæ»‘å‹•æ’åˆ°äº†ä½ ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'è™è ç¾¤', icon: 'ğŸ¦‡', description: 'å¤©èŠ±æ¿ä¸Šæ›æ»¿äº†è™è ã€‚è¦ä¸ŸçŸ³é ­é©šåš‡ç‰ å€‘å—ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const g = 60; game.player.gold += g; return `è™è åš‡é£›äº†ï¼Œæ‰è½äº† ${g} é‡‘å¹£ï¼`; },
                        () => { game.addBuff('æ··äº‚', 10, 'attack', -5, 'negative'); return `è™è ç¾¤èµ·æ”»æ“Šï¼ä½ æ‰‹å¿™è…³äº‚ï¼Œæ”»æ“Š -5 (10å±¤)`; }
                    )
                },
                {
                    name: 'ç¥ç§˜ç¤¦çŸ³', icon: 'ğŸª¨', description: 'ç‰†å£ä¸ŠåµŒè‘—ä¸€å¡Šå¥‡æ€ªçš„çŸ³é ­ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('ç¡¬åŒ–çš®è†š', 15, 'defense', 5, 'positive'); return `è§¸æ‘¸å¾Œçš®è†šè®Šç¡¬äº†ï¼é˜²ç¦¦ +5 (15å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `çŸ³é ­çªç„¶çˆ†ç‚¸äº†ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {   // Positive - âœ… FIX
                    name: 'åœ°ä¸‹æ¸…æ³‰', icon: 'ğŸ’§', description: 'ä¸€è‚¡æ¸…æ¾ˆçš„æ³‰æ°´å¾å²©ç¸«ä¸­æµå‡ºã€‚',
                    resolve: (game) => { 
                        const h = Math.floor(game.getMaxHp() * 0.3); 
                        game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // âœ… FIX
                        return { text: `æ¸…æ¶¼çš„æ³‰æ°´ï¼æ¢å¾©äº† ${h} ç”Ÿå‘½ã€‚`, type: 'positive' }; 
                    }
                }
            ],

            // Area 3: Skeleton Graveyard (éª·é«å¢“åœ°)
            3: [
                {
                    name: 'ç„¡åå¢“ç¢‘', icon: 'ğŸª¦', description: 'ä¸€åº§æ­ªæ–œçš„å¢“ç¢‘ã€‚è¦æŒ–æ˜çœ‹çœ‹å—ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const s = 5; game.soulGainedThisRun += s; return `æŒ–åˆ°äº†éˆé­‚ç¢ç‰‡ï¼ç²å¾— ${s} éˆé­‚ã€‚`; },
                        () => { game.addBuff('è©›å’’', 15, 'defense', -8, 'negative'); return `å†’çŠ¯äº†äº¡è€…ï¼é˜²ç¦¦ -8 (15å±¤)`; }
                    )
                },
                {
                    name: 'ä¾›å“ç›¤', icon: 'ğŸ¥£', description: 'æ”¾åœ¨å¢“å‰çš„ä¾›å“ç›¤ï¼Œè£¡é¢æœ‰ä¸€äº›é‡‘å¹£ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 80; game.player.gold += g; return `æ‹¿èµ°äº†ä¾›å“ã€‚ç²å¾— ${g} é‡‘å¹£ã€‚`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `ä¾›å“ç›¤å’¬äº†ä½ çš„æ‰‹ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'é¬¼ç«', icon: 'ğŸ”¥', description: 'ä¸€åœ˜è—è‰²çš„ç«ç„°åœ¨ç©ºä¸­æ¼‚æµ®ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å¹½å†¥ç«', 15, 'crit', 10, 'positive'); return `ç«ç„°é™„è‘—åœ¨æ­¦å™¨ä¸Šï¼çˆ†æ“Š +10% (15å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `éˆé­‚è¢«ç¼ç‡’äº†ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'æ•£è½çš„éª¨é ­', icon: 'ğŸ¦´', description: 'ä¸€å †ç™½éª¨ã€‚çœ‹èµ·ä¾†å¯ä»¥æ‹¼æ¹Šæˆä»€éº¼ã€‚',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['rib_bone'] = (game.player.materials['rib_bone']||0)+1; return `æ‰¾åˆ°äº†ä¸€æ ¹å …å›ºçš„è‚‹éª¨ï¼ç²å¾— [è…æœ½è‚‹éª¨]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.1); game.player.hp = Math.max(0, game.player.hp - d); return `éª¨é ­çªç„¶åˆºå‘ä½ ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {   // Positive
                    name: 'å®‰æ¯çš„éˆé­‚', icon: 'ğŸ‘»', description: 'ä¸€å€‹å‹å–„çš„å¹½éˆå‘ä½ é»é ­è‡´æ„ã€‚',
                    resolve: (game) => { game.addBuff('å®ˆè­·éˆ', 20, 'defense', 10, 'positive'); return { text: `ä½ æ„Ÿåˆ°è¢«å®ˆè­·è‘—ã€‚é˜²ç¦¦ +10 (20å±¤)`, type: 'positive' }; }
                }
            ],

            // Area 4: Dark Forest (å¹½æš—æ£®æ—)
            4: [
                {
                    name: 'å¥‡ç•°æœå¯¦', icon: 'ğŸ’', description: 'æ¨¹ä¸Šé•·è‘—é®®è±”çš„æœå¯¦ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.4); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // âœ… FIX
                            return `ç¾å‘³å¤šæ±ï¼æ¢å¾©äº† ${h} ç”Ÿå‘½ã€‚`; 
                        },
                        () => { game.addBuff('è‡´å¹»', 15, 'dodge', -10, 'negative'); return `åƒäº†ä¹‹å¾Œå¤©æ—‹åœ°è½‰... é–ƒé¿ -10% (15å±¤)`; }
                    )
                },
                {
                    name: 'çµäººé™·é˜±', icon: 'ğŸ•¸ï¸', description: 'åœ°ä¸Šæœ‰å€‹èˆŠçš„æ•ç¸å¤¾ã€‚è©¦è‘—æ‹†é™¤å®ƒï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const g = 100; game.player.gold += g; return `æ‹†é™¤æˆåŠŸï¼å°‡å»¢éµè³£æ‰ç²å¾— ${g} é‡‘å¹£ã€‚`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `å¤¾åˆ°æ‰‹äº†ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'æ¨¹æ´', icon: 'ğŸŒ³', description: 'è€æ¨¹ä¸Šæœ‰å€‹æ·±é‚ƒçš„æ¨¹æ´ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.player.materials['dryad_branch'] = (game.player.materials['dryad_branch']||0)+1; return `æ‘¸åˆ°äº†æ¨¹å¦–çš„ææ¢ï¼ç²å¾— [æ¨¹å¦–æ¯æ]`; },
                        () => { game.addBuff('çºç¹', 10, 'dodge', -15, 'negative'); return `è¢«è—¤è”“çºä½äº†ï¼é–ƒé¿ -15% (10å±¤)`; }
                    )
                },
                {
                    name: 'ç²¾éˆå…‰ç’°', icon: 'âœ¨', description: 'ä¸€åœˆå¥‡æ€ªçš„è˜‘è‡å½¢æˆçš„åœ“ç’°ã€‚',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.addBuff('è‡ªç„¶ä¹‹åŠ›', 20, 'attack', 15, 'positive'); return `ç²å¾—äº†æ£®æ—çš„ç¥ç¦ï¼æ”»æ“Š +15 (20å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `è¢«ç²¾éˆæƒ¡ä½œåŠ‡äº†ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {   
                    name: 'æœˆå…‰ç©ºåœ°', icon: 'ğŸŒ™', description: 'æœˆå…‰ç‘è½åœ¨é€™ç‰‡å¯§éœçš„ç©ºåœ°ä¸Šã€‚',
                    resolve: (game) => { 
                        const h = Math.floor(game.getMaxHp() * 0.3); 
                        game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // âœ… FIX
                        return { text: `å¿ƒéˆå¾—åˆ°äº†å¹³éœã€‚æ¢å¾© ${h} ç”Ÿå‘½ã€‚`, type: 'positive' }; 
                    }
                }
            ],

            // Area 5: Magic Lab (é­”æ³•å¯¦é©—å®¤)
            5: [
                {
                    name: 'å†’æ³¡çš„å©å ', icon: 'ğŸ²', description: 'ä¸€é‹é¡è‰²è©­ç•°çš„æ¶²é«”æ­£åœ¨æ²¸é¨°ã€‚å–ä¸€å£ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å·¨äººä¹‹åŠ›', 20, 'attack', 25, 'positive'); return `æ„Ÿè¦ºåŠ›é‡æ¹§ä¸Šä¾†äº†ï¼æ”»æ“Š +25 (20å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.25); game.player.hp = Math.max(0, game.player.hp - d); return `çˆ†ç‚¸äº†ï¼ä½ è¢«ç‚¸é£›ï¼Œå—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'å¤è€é­”å°æ›¸', icon: 'ğŸ“–', description: 'ä¸€æœ¬ç©æ»¿ç°å¡µçš„é­”æ³•æ›¸ã€‚é–±è®€å®ƒï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const s = 10; game.soulGainedThisRun += s; return `å­¸åˆ°äº†ç¦å¿Œçš„çŸ¥è­˜ï¼ç²å¾— ${s} éˆé­‚ã€‚`; },
                        () => { game.addBuff('è©›å’’ç¬¦æ–‡', 15, 'defense', -15, 'negative'); return `çœ¼ç›å¥½ç—›ï¼é˜²ç¦¦ -15 (15å±¤)`; }
                    )
                },
                {
                    name: 'ä¸ç©©å®šçš„é­”å¶', icon: 'ğŸ¤–', description: 'ä¸€å€‹åŠæˆå“çš„é­”å¶åœ¨æŠ½æã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.player.materials['puppet_gear'] = (game.player.materials['puppet_gear']||0)+1; return `æ‹†ä¸‹äº†ä¸€å€‹é›¶ä»¶ï¼ç²å¾— [é­”å¶é½’è¼ª]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `é­”å¶æ”¾å‡ºäº†é›»æµï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'å¯¦é©—æ¨™æœ¬', icon: 'ğŸ§ª', description: 'ç¦é¦¬æ—è£¡æ³¡è‘—å¥‡æ€ªçš„ç”Ÿç‰©ã€‚',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.addBuff('ç”Ÿç‰©æ´å¯Ÿ', 20, 'crit', 15, 'positive'); return `ç™¼ç¾äº†å¼±é»ï¼çˆ†æ“Š +15% (20å±¤)`; },
                        () => { game.addBuff('æ¯’æ°£', 10, 'attack', -10, 'negative'); return `ç½å­ç ´äº†ï¼Œæ¯’æ°£å¤–æ´©ï¼æ”»æ“Š -10 (10å±¤)`; }
                    )
                },
                {   // Positive
                    name: 'éŠé‡‘è—¥æ¶', icon: 'ğŸ§´', description: 'æ¶å­ä¸Šé‚„ç•™æœ‰ä¸€äº›å®Œå¥½çš„è—¥æ°´ã€‚',
                    resolve: (game) => { game.player.potions['medium']++; return { text: `æ‰¾åˆ°äº†ä¸€ç“¶ä¸­å‹è—¥æ°´ï¼`, type: 'positive' }; }
                }
            ],

            // Area 6: Demon Hall (æƒ¡é­”æ®¿å ‚)
            6: [
                {
                    name: 'é®®è¡€å™´æ³‰', icon: 'ğŸ©¸', description: 'å™´æ³‰è£¡æµæ·Œè‘—é®®ç´…çš„æ¶²é«”ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å—œè¡€', 20, 'attack', 30, 'positive'); return `å–ä¸‹æƒ¡é­”ä¹‹è¡€ï¼æ”»æ“Š +30 (20å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.3); game.player.hp = Math.max(0, game.player.hp - d); return `è¡€æ¶²åœ¨ç‡ƒç‡’ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'æƒ¡é­”é›•åƒ', icon: 'ğŸ‘¿', description: 'ä¸€åº§çŒ™ç°çš„é›•åƒã€‚è¦ç¥ˆç¦±å—ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { const g = 200; game.player.gold += g; return `é›•åƒåå‡ºäº†é‡‘å¹£ï¼ç²å¾— ${g} Gã€‚`; },
                        () => { game.addBuff('æƒ¡é­”å‡è¦–', 15, 'defense', -20, 'negative'); return `é›•åƒå‹•äº†ï¼ä½ è¢«è©›å’’äº†ï¼Œé˜²ç¦¦ -20 (15å±¤)`; }
                    )
                },
                {
                    name: 'åˆ‘å…·', icon: 'â›“ï¸', description: 'ä¸€å¥—æ²¾æ»¿è¡€è·¡çš„åˆ‘å…·ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.player.materials['imp_horn'] = (game.player.materials['imp_horn']||0)+1; return `åœ¨æ—é‚Šæ’¿åˆ°äº†æˆ°åˆ©å“ï¼ç²å¾— [å°æƒ¡é­”è§’]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `ä¸å°å¿ƒè§¸ç™¼äº†æ©Ÿé—œï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'éˆé­‚å¥‘ç´„', icon: 'ğŸ“œ', description: 'ä¸€å¼µç¾Šçš®ç´™ï¼Œä¸Šé¢å¯«è‘—çœ‹ä¸æ‡‚çš„æ–‡å­—ã€‚',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const s = 15; game.soulGainedThisRun += s; return `ä½ æ¬ºé¨™äº†æƒ¡é­”ï¼ç²å¾— ${s} éˆé­‚ã€‚`; },
                        () => { game.soulGainedThisRun = Math.max(0, game.soulGainedThisRun - 5); return `éˆé­‚è¢«å¸èµ°äº†ä¸€éƒ¨åˆ†... å¤±å» 5 éˆé­‚ã€‚`; }
                    )
                },
                {   // Positive
                    name: 'è¢«å›šç¦çš„å¤©ä½¿', icon: 'ğŸ‘¼', description: 'ä¸€å€‹å¾®å¼±çš„å…‰èŠ’è¢«é–åœ¨ç± å­è£¡ã€‚',
                    resolve: (game) => { game.addBuff('è–å…‰åº‡è­·', 30, 'defense', 25, 'positive'); return { text: `ä½ é‡‹æ”¾äº†å…‰èŠ’ï¼é˜²ç¦¦ +25 (30å±¤)`, type: 'positive' }; }
                }
            ],

            // Area 7: Ice Corridor (å†°éœœèµ°å»Š)
            7: [
                {
                    name: 'å†°å‡å†’éšªè€…', icon: 'ğŸ§Š', description: 'ä¸€å€‹è¢«å‡åœ¨å†°å¡Šè£¡çš„å†’éšªè€…ã€‚æ•²é–‹å†°å¡Šï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 250; game.player.gold += g; return `ä»–èº«ä¸Šå¸¶è‘—éŒ¢åŒ…ï¼ç²å¾— ${g} é‡‘å¹£ã€‚`; },
                        () => { game.addBuff('å‡å‚·', 15, 'dodge', -20, 'negative'); return `å¯’æ°£å…¥éª¨ï¼å‹•ä½œè®Šæ…¢äº†ï¼Œé–ƒé¿ -20% (15å±¤)`; }
                    )
                },
                {
                    name: 'å†°æ™¶ç°‡', icon: 'ğŸ’', description: 'ç¾éº—ä½†é‹’åˆ©çš„å†°æ™¶ã€‚è©¦è‘—æ¡é›†ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['frost_core'] = (game.player.materials['frost_core']||0)+1; return `æ¡é›†æˆåŠŸï¼ç²å¾— [æ°¸å‡æ ¸å¿ƒ]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `æ‰‹è¢«å‰²å‚·äº†ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'æš´é¢¨é›ª', icon: 'ğŸŒ¨ï¸', description: 'å‰æ–¹åˆ®èµ·äº†æš´é¢¨é›ªã€‚è¦å¼·è¡Œé€šéå—ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å¯’å†°è­·ç”²', 20, 'defense', 30, 'positive'); return `å†°é›ªè¦†è“‹äº†ç›”ç”²ï¼é˜²ç¦¦ +30 (20å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.25); game.player.hp = Math.max(0, game.player.hp - d); return `å¥½å†·ï¼é«”æº«æµå¤±ï¼Œå—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'æ»‘æºœåœ°é¢', icon: 'â›¸ï¸', description: 'åœ°é¢çµå†°äº†ï¼Œéå¸¸æ»‘ã€‚',
                    resolve: (game) => game.gambleEvent(0.6, 
                        () => { game.addBuff('æ»‘è¡Œ', 20, 'dodge', 20, 'positive'); return `ä½ æŒæ¡äº†æ»‘è¡Œçš„æŠ€å·§ï¼é–ƒé¿ +20% (20å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.15); game.player.hp = Math.max(0, game.player.hp - d); return `æ»‘å€’äº†ï¼æ‘”å¾—ä¸è¼•ï¼Œå—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {   // Positive - âœ… FIX
                    name: 'åœ°ç†±æº«æ³‰', icon: 'â™¨ï¸', description: 'åœ¨é€™å†°å¤©é›ªåœ°ä¸­ç«Ÿç„¶æœ‰ä¸€è™•æº«æ³‰ã€‚',
                    resolve: (game) => { 
                        const h = Math.floor(game.getMaxHp() * 0.4); 
                        game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // âœ… FIX
                        return { text: `æº«æš–äº†èº«å¿ƒã€‚æ¢å¾© ${h} ç”Ÿå‘½ã€‚`, type: 'positive' }; 
                    }
                }
            ],

            // Area 8: Flame Passage (çƒˆç„°é€šé“)
            8: [
                {
                    name: 'å²©æ¼¿æ± ', icon: 'ğŸŒ‹', description: 'æ»¾ç‡™çš„å²©æ¼¿ã€‚è£¡é¢å¥½åƒæœ‰æ±è¥¿ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['ember_spark'] = (game.player.materials['ember_spark']||0)+1; return `ç”¨æ­¦å™¨æ’ˆå‡ºäº†å¯¶ç‰©ï¼ç²å¾— [ä¸æ»…ç«ç¨®]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.3); game.player.hp = Math.max(0, game.player.hp - d); return `å¤ªç‡™äº†ï¼è¢«åš´é‡ç‡’å‚·ï¼Œå—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'ç‡ƒç‡’éµç §', icon: 'ğŸ”¨', description: 'çŸ®äººç•™ä¸‹çš„é›é€ å°ï¼Œé‚„åœ¨ç‡ƒç‡’ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('é‹’åˆ©', 20, 'attack', 40, 'positive'); return `é‡æ–°æ·¬éŠäº†æ­¦å™¨ï¼æ”»æ“Š +40 (20å±¤)`; },
                        () => { game.addBuff('ç†”æ¯€', 15, 'defense', -25, 'negative'); return `ç›”ç”²è¢«é«˜æº«æå£äº†ï¼é˜²ç¦¦ -25 (15å±¤)`; }
                    )
                },
                {
                    name: 'ç°ç‡¼å †', icon: 'ğŸŒ«ï¸', description: 'ä¸€å †åšåšçš„ç«å±±ç°ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { const g = 300; game.player.gold += g; return `ç°ç‡¼ä¸‹åŸ‹è‘—é»ƒé‡‘ï¼ç²å¾— ${g} é‡‘å¹£ã€‚`; },
                        () => { game.addBuff('çª’æ¯', 10, 'attack', -15, 'negative'); return `å¸å…¥äº†ç«å±±ç°ï¼æ”»æ“Š -15 (10å±¤)`; }
                    )
                },
                {
                    name: 'çƒˆç„°èŠ±', icon: 'ğŸŒº', description: 'åœ¨ç«ä¸­ç››é–‹çš„èŠ±æœµã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.2); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // âœ… FIX
                            return `å……æ»¿æ´»åŠ›çš„èƒ½é‡ï¼æ¢å¾© ${h} ç”Ÿå‘½ã€‚`; 
                        },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `èŠ±æœµå™´å‡ºäº†ç«ç„°ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {   
                    name: 'ç«ç¥ç¥­å£‡', icon: 'ğŸ”±', description: 'ä¸€åº§ä¾›å¥‰ç«ç¥çš„ç¥­å£‡ï¼Œå‘¨åœå¾ˆæ¶¼çˆ½ã€‚',
                    resolve: (game) => { game.addBuff('ç«ç„°æŠ—æ€§', 30, 'defense', 35, 'positive'); return { text: `ç²å¾—äº†ç«ç¥çš„åº‡ä½‘ï¼é˜²ç¦¦ +35 (30å±¤)`, type: 'positive' }; }
                }
            ],

            // Area 9: Void Rift (è™›ç©ºè£‚éš™)
            9: [
                {
                    name: 'æ¼‚æµ®çœ¼çƒ', icon: 'ğŸ‘ï¸', description: 'ä¸€å€‹å·¨å¤§çš„çœ¼çƒåœ¨ç›¯è‘—ä½ ã€‚èˆ‡å®ƒå°è¦–ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å¼±é»è­˜ç ´', 25, 'crit', 25, 'positive'); return `ä½ çœ‹ç©¿äº†çœŸç†ï¼çˆ†æ“Š +25% (25å±¤)`; },
                        () => { game.addBuff('ææ‡¼', 15, 'attack', -30, 'negative'); return `ä½ çœ‹åˆ°äº†ä¸å¯åç‹€çš„ææ€–... æ”»æ“Š -30 (15å±¤)`; }
                    )
                },
                {
                    name: 'ç©ºé–“è£‚ç¸«', icon: 'ğŸŒ€', description: 'ç©ºé–“å‡ºç¾äº†è£‚ç—•ã€‚ä¼¸æ‰‹é€²å»ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { game.player.materials['void_dust'] = (game.player.materials['void_dust']||0)+1; return `æŠ“ä½äº†è™›ç©ºçš„ç‰©è³ªï¼ç²å¾— [è™›ç©ºæ˜Ÿå¡µ]`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.35); game.player.hp = Math.max(0, game.player.hp - d); return `æ‰‹è‡‚å·®é»è¢«åˆ‡æ–·ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'ä½èªçƒé«”', icon: 'ğŸ”®', description: 'ä¸€å€‹ç™¼å‡ºç«Šç«Šç§èªçš„é»‘è‰²çƒé«”ã€‚',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const s = 25; game.soulGainedThisRun += s; return `è½æ‡‚äº†è™›ç©ºçš„èªè¨€ï¼ç²å¾— ${s} éˆé­‚ã€‚`; },
                        () => { game.addBuff('ç²¾ç¥éŒ¯äº‚', 20, 'dodge', -30, 'negative'); return `è…¦è¢‹è¦ç‚¸é–‹äº†ï¼é–ƒé¿ -30% (20å±¤)`; }
                    )
                },
                {
                    name: 'é‡åŠ›äº•', icon: 'ğŸŒŒ', description: 'é€™è£¡çš„é‡åŠ›ç•°å¸¸å¼·å¤§ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('è¼•ç›ˆ', 20, 'dodge', 30, 'positive'); return `é©æ‡‰äº†é‡åŠ›è®ŠåŒ–ï¼é–ƒé¿ +30% (20å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.2); game.player.hp = Math.max(0, game.player.hp - d); return `è¢«é‡åŠ›å£“å®äº†ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {   
                    name: 'è™›ç©ºè¡Œå•†', icon: 'ğŸ‘½', description: 'ä¸€å€‹å‹å¥½çš„è™›ç©ºç”Ÿç‰©è·¯éã€‚',
                    resolve: (game) => { game.player.potions['full']++; return { text: `ä»–é€äº†ä½ ä¸€ç“¶å¼·åŠ›è—¥æ°´ï¼ç²å¾— [å®Œå…¨æ¢å¾©è—¥æ°´]`, type: 'positive' }; }
                }
            ],

            // Area 10: Demon King's Throne (é­”ç‹å¯¶åº§)
            10: [
                {
                    name: 'çš‡å®¶æ——å¹Ÿ', icon: 'ğŸš©', description: 'é­”ç‹çš„æ——å¹Ÿã€‚æ’•æ¯€å®ƒï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å£«æ°£å¤§æŒ¯', 30, 'attack', 50, 'positive'); return `å‹‡æ°£å€å¢ï¼æ”»æ“Š +50 (30å±¤)`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.3); game.player.hp = Math.max(0, game.player.hp - d); return `æ——æ¡¿å€’ä¸‹ç ¸ä¸­äº†ä½ ï¼å—åˆ° ${d} å‚·å®³ã€‚`; }
                    )
                },
                {
                    name: 'è©›å’’é­”é¡', icon: 'ğŸª', description: 'æ˜ ç…§å‡ºå…§å¿ƒææ‡¼çš„é¡å­ã€‚',
                    resolve: (game) => game.gambleEvent(0.5, 
                        () => { game.addBuff('å¿ƒå¦‚æ­¢æ°´', 30, 'defense', 50, 'positive'); return `æˆ°å‹äº†å¿ƒé­”ï¼é˜²ç¦¦ +50 (30å±¤)`; },
                        () => { game.addBuff('è‡ªæˆ‘æ‡·ç–‘', 20, 'crit', -50, 'negative'); return `è¢«å€’å½±åš‡å£äº†ï¼çˆ†æ“Š -50% (20å±¤)`; }
                    )
                },
                {
                    name: 'é»ƒé‡‘é…’æ¯', icon: 'ğŸ·', description: 'æ¡Œä¸Šæœ‰ä¸€æ¯æœªå–å®Œçš„é…’ã€‚',
                    resolve: (game) => game.gambleEvent(0.4, 
                        () => { 
                            const h = Math.floor(game.getMaxHp() * 0.5); 
                            game.player.hp = Math.min(game.player.hp + h, game.getMaxHp()); // âœ… FIX
                            return `æ˜¯é­”åŠ›çš„ç“Šæ¼¿ï¼æ¢å¾© ${h} ç”Ÿå‘½ã€‚`; 
                        },
                        () => { game.addBuff('åŠ‡æ¯’', 20, 'attack', -40, 'negative'); return `æ˜¯æ¯’é…’ï¼æ”»æ“Š -40 (20å±¤)`; }
                    )
                },
                {
                    name: 'é»‘æš—ç‹åº§', icon: 'ğŸ‘‘', description: 'ç©ºè•©è•©çš„ç‹åº§ã€‚åä¸Šå»è©¦è©¦ï¼Ÿ',
                    resolve: (game) => game.gambleEvent(0.3, 
                        () => { const s = 50; game.soulGainedThisRun += s; return `æ„Ÿå—åˆ°ç‹è€…çš„æ°£æ¯ï¼ç²å¾— ${s} éˆé­‚ã€‚`; },
                        () => { const d = Math.floor(game.getMaxHp() * 0.4); game.player.hp = Math.max(0, game.player.hp - d); return `è¢«ç‹åº§æ‹’çµ•äº†ï¼å—åˆ° ${d} é›·æ“Šå‚·å®³ã€‚`; }
                    )
                },
                {   
                    name: 'å…¬ä¸»çš„æ‰‹å¸•', icon: 'ğŸ§£', description: 'åœ°ä¸Šæ‰è½è‘—ä¸€æ¢ç¹¡è‘—çš‡å®¤å¾½ç« çš„æ‰‹å¸•ã€‚',
                    resolve: (game) => { game.addBuff('æ„›çš„ä¿¡å¿µ', 50, 'attack', 30, 'positive'); game.addBuff('å®ˆè­·èª“è¨€', 50, 'defense', 30, 'positive'); return { text: `å…¬ä¸»å°±åœ¨å‰é¢äº†ï¼å…¨å±¬æ€§å¤§å¹…æå‡ï¼`, type: 'positive' }; }
                }
            ]
        };

        // ==================== GAME CLASS ====================
        class Game {
            constructor() {
                this.soulData = loadSoulData();
                this.resetRunState();
                this.updateMenuSoulDisplay();
                this.selectedUnequipSlot = null;
                this.selectedSellIndex = -1;

                this.combatHeightSet = false;
                this.referenceHeight = 320;

                if (this.loadGame()) {
                    this.restoreScreen();
                }
            }

            gambleEvent(chance, successFn, failFn) {
                if (Math.random() < chance) {
                    const text = successFn();
                    return { text: text, type: 'positive' };
                } else {
                    const text = failFn();
                    return { text: text, type: 'negative' };
                }
            }

            saveGame() {
                if (!this.gameStarted || this.player.hp <= 0) return;

                const saveData = {
                    version: GAME_VERSION,
                    level: this.level,
                    player: this.player,
                    buffs: this.buffs,
                    currentArea: this.currentArea,
                    lastArea: this.lastArea,
                    storyShown: this.storyShown,
                    soulGainedThisRun: this.soulGainedThisRun,
                    inCombat: this.inCombat,
                    isMimicFight: this.isMimicFight,
                    mimicLootBonus: this.mimicLootBonus,
                    currentEvent: this.currentEvent,
                    currentMonster: this.currentMonster,
                    merchantItems: this.merchantItems,
                    pendingLoot: this.pendingLoot,
                    lastBattleLog: this.lastBattleLog,
                    randomEventName: this.currentRandomEvent ? this.currentRandomEvent.name : null,
                    isActionLocked: false  
                };

                localStorage.setItem('magicTower_autoSave', JSON.stringify(saveData));
            }

            loadGame() {
                const dataStr = localStorage.getItem('magicTower_autoSave');
                if (!dataStr) return false;

                try {
                    const data = JSON.parse(dataStr);
                    // --- VERSION CHECK ---
                    if (data.version !== GAME_VERSION) {
                        console.log("Save file is from an old version. Resetting run.");
                        localStorage.removeItem('magicTower_autoSave');
                        alert("éŠæˆ²å·²æ›´æ–°ï¼ç”±æ–¼å¹³è¡¡èª¿æ•´ï¼Œæ‚¨çš„èˆŠå­˜æª”å·²é‡ç½®ã€‚è«‹é–‹å§‹æ–°çš„å†’éšªï¼");
                        return false;
                    }
                    // ---------------------

                    // Restore data
                    Object.assign(this, data);
                    
                    // âœ… FIX: Explicitly set gameStarted to true when loading a valid save
                    this.gameStarted = true;
                    
                    // Restore Random Event reference (since functions don't save in JSON)
                    if (data.randomEventName) {
                        const areaNum = this.getAreaNumber();
                        const pool = AREA_EVENTS[areaNum] || AREA_EVENTS[1];
                        this.currentRandomEvent = pool.find(e => e.name === data.randomEventName);
                    }

                    return true;
                } catch (e) {
                    console.error("Save file corrupted", e);
                    localStorage.removeItem('magicTower_autoSave'); 
                    return false;
                }
            }

            restoreScreen() {
                this.gameStarted = true;
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                this.updateUI();

                const panel = document.getElementById('event-panel');
                
                // Decide what to render based on the saved state
                if (this.currentEvent === 'fight' || (this.inCombat && this.currentMonster)) {
                    this.renderCombat();
                } else if (this.currentEvent === 'merchant') {
                    this.renderMerchant();
                } else if (this.currentEvent === 'treasure') {
                    if (this.pendingLoot) this.renderTreasure();
                    else this.generateTreasureChoice();
                } else if (this.currentEvent === 'rest') {
                    this.generateRestArea();
                } else if (this.currentEvent === 'event' && this.currentRandomEvent) {
                    this.renderRandomEventChoice();
                } else if (this.pendingLoot) {
                    if (this.level > 500) this.renderFinalVictory();
                    else this.renderVictory();
                } else {
                    this.generateEvent();
                }
            }

            updateCombatReferenceHeight() {
                const panel = document.getElementById('event-panel');
                if (!panel || this.combatHeightSet) return;
                
                if (this.inCombat && this.currentMonster) {
                    // Wait for render to complete
                    requestAnimationFrame(() => {
                        const height = panel.offsetHeight;
                        if (height > 250) { // Sanity check
                            this.combatHeightSet = true;
                            this.referenceHeight = height;
                            document.documentElement.style.setProperty('--combat-height', `${height}px`);
                        }
                    });
                }
            }

            
            renderRandomEventChoice() {
                const event = this.currentRandomEvent;
                const panel = document.getElementById('event-panel');
                
                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${event.icon}</div>
                        <div><div class="event-title">${event.name}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="event-description" style="font-size: 1rem; color: #ddd; padding: 10px;">
                            ${event.description}
                        </div>
                        <div style="text-align: center; color: #888; font-size: 0.8rem; margin-top: 10px;">
                            (çµæœæœªçŸ¥ï¼Œå¯èƒ½ç²å¾—çå‹µæˆ–æ‡²ç½°)
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="game.resolveRandomEvent()">ğŸ¤” æ¢ç´¢ (è³­é‹æ°£)</button>
                        <button class="btn btn-secondary" onclick="game.skipRandomEvent()">ğŸƒ ç›´æ¥é›¢é–‹</button>
                    </div>
                `;
            }

            resetRunState() {
                this.level = 1;
                const soulBonuses = this.getSoulBonuses();
                
                this.player = {
                    hp: 100 + soulBonuses.vitality,
                    maxHp: 100 + soulBonuses.vitality,
                    baseAttack: 12 + soulBonuses.strength,
                    baseDefense: 5 + soulBonuses.resilience,
                    baseDodge: 5 + soulBonuses.agility,
                    baseCrit: 5 + soulBonuses.precision,
                    gold: 50 + soulBonuses.startingGold,
                    equipment: {
                        weapon: null,
                        armor: null,
                        accessory: null
                    },
                    bag: [],
                    materials: {},
                    potions: {
                        small: 2,
                        medium: 0,
                        large: 0,
                        full: 0
                    }
                };
                this.buffs = [];
                this.currentEvent = null;
                this.currentMonster = null;
                this.lastBattleLog = null;
                this.pendingLoot = null;
                this.gameStarted = false;
                this.inCombat = false;
                this.merchantItems = [];
                this.soulGainedThisRun = 0;
                this.storyShown = {};
                this.currentArea = 1;
                this.lastArea = 0;
                this.selectedBagIndex = -1;
                this.selectedSellIndex = -1;
                this.isMimicFight = false;
                this.mimicLootBonus = false;  
                this.isActionLocked = false; 
            }

            getSoulBonuses() {
                const u = this.soulData.upgrades;
                return {
                    vitality: u.vitality * 10,
                    strength: u.strength * 2,
                    resilience: u.resilience * 2,
                    agility: u.agility * 1,
                    precision: u.precision * 1,
                    fortune: u.fortune * 5,
                    soulHarvest: u.soulHarvest * 10,
                    potionMaster: u.potionMaster * 10,
                    startingGold: u.startingGold * 25,
                    secondChance: u.secondChance * 5
                };
            }

            updateMenuSoulDisplay() {
                const menuCount = document.getElementById('menu-soul-count');
                const shopCount = document.getElementById('shop-soul-count');
                if (menuCount) menuCount.textContent = this.soulData.souls;
                if (shopCount) shopCount.textContent = this.soulData.souls;
            }

            // ==================== AREA FUNCTIONS ====================

            getCurrentArea() {
                for (let i = AREAS.length - 1; i >= 0; i--) {
                    if (this.level >= AREAS[i].startFloor) {
                        return AREAS[i];
                    }
                }
                return AREAS[0];
            }

            getAreaNumber() {
                return this.getCurrentArea().id;
            }

            getFloorInArea() {
                const area = this.getCurrentArea();
                return this.level - area.startFloor + 1;
            }

            isAreaBossFloor() {
                const areaNum = this.getAreaNumber();
                const bossFloor = areaNum * 50;
                return this.level === bossFloor;
            }

            isNewArea() {
                const currentAreaNum = this.getAreaNumber();
                if (currentAreaNum !== this.lastArea) {
                    this.lastArea = currentAreaNum;
                    return true;
                }
                return false;
            }

            showAreaTransition() {
                const area = this.getCurrentArea();
                const areaNum = this.getAreaNumber();
                document.getElementById('area-icon').textContent = area.icon;
                document.getElementById('area-name').textContent = area.name;
                document.getElementById('area-desc').textContent = area.desc;
                document.getElementById('area-transition-title').textContent = `é€²å…¥ç¬¬${areaNum}å€åŸŸ`;
                document.getElementById('area-transition').classList.remove('hidden');
            }

            closeAreaTransition() {
                document.getElementById('area-transition').classList.add('hidden');
                this.checkStoryDialogue();
                this.generateEvent();
                this.updateUI();
            }

            // ==================== STORY TRANSITION ====================

            showStoryTransition() {
                const dialogue = STORY_DIALOGUES.start;
                document.getElementById('story-icon').textContent = 'ğŸ‘‘';
                document.getElementById('story-title').textContent = 'ç‹åŸå¤§æ®¿';
                document.getElementById('story-speaker').textContent = dialogue.speaker;
                document.getElementById('story-text').textContent = dialogue.text;
                document.getElementById('story-transition').classList.remove('hidden');
            }

            closeStoryTransition() {
                document.getElementById('story-transition').classList.add('hidden');
                this.lastArea = 1;
                this.showAreaTransition();
            }

            // ==================== MENU FUNCTIONS ====================

            openSoulShop() {
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('soul-shop').style.display = 'flex';
                this.renderSoulShop();
            }

            closeSoulShop() {
                document.getElementById('soul-shop').style.display = 'none';
                document.getElementById('main-menu').classList.remove('hidden');
                this.updateMenuSoulDisplay();
            }

            renderSoulShop() {
                const container = document.getElementById('soul-shop-items');
                this.updateMenuSoulDisplay();
                
                container.innerHTML = SOUL_UPGRADES.map(upgrade => {
                    const currentLevel = this.soulData.upgrades[upgrade.id];
                    const isMaxed = currentLevel >= upgrade.maxLevel;
                    const cost = isMaxed ? 0 : Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, currentLevel));
                    const canAfford = this.soulData.souls >= cost;
                    
                    return `
                        <div class="soul-upgrade ${isMaxed ? 'maxed' : ''}">
                            <div class="upgrade-info">
                                <div class="upgrade-name">${upgrade.name}</div>
                                <div class="upgrade-desc">${upgrade.desc}</div>
                                <div class="upgrade-level">ç­‰ç´š ${currentLevel} / ${upgrade.maxLevel} (${upgrade.effect})</div>
                            </div>
                            <div class="upgrade-cost ${isMaxed ? 'maxed' : (!canAfford ? 'disabled' : '')}" 
                                 onclick="${isMaxed ? '' : `game.purchaseUpgrade('${upgrade.id}')`}">
                                ${isMaxed ? 'âœ“ å·²æ»¿ç´š' : `ğŸ’ ${cost}`}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            purchaseUpgrade(upgradeId) {
                const upgrade = SOUL_UPGRADES.find(u => u.id === upgradeId);
                if (!upgrade) return;
                
                const currentLevel = this.soulData.upgrades[upgradeId];
                if (currentLevel >= upgrade.maxLevel) return;
                
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, currentLevel));
                if (this.soulData.souls < cost) return;
                
                this.soulData.souls -= cost;
                this.soulData.upgrades[upgradeId]++;
                saveSoulData(this.soulData);
                this.renderSoulShop();
            }

            startNewRun() {
                this.resetRunState();
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('soul-shop').style.display = 'none';
                document.getElementById('game-screen').classList.remove('hidden');
                this.gameStarted = true;
                this.soulData.totalRuns++;
                saveSoulData(this.soulData);
                
                document.getElementById('event-panel').innerHTML = '';
                
                this.updateUI();
                this.showStoryTransition();
            }

            returnToMenu() {
                document.getElementById('game-over-modal').classList.remove('active');
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('main-menu').classList.remove('hidden');
                this.updateMenuSoulDisplay();
            }

            // ==================== STAT GETTERS ====================

            getAttack() {
                let total = this.player.baseAttack;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.attack;
                if (this.player.equipment.armor) total += this.player.equipment.armor.attack;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.attack;
                this.buffs.forEach(b => { if (b.stat === 'attack') total += b.value; });
                return Math.max(1, total);
            }

            getDefense() {
                let total = this.player.baseDefense;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.defense;
                if (this.player.equipment.armor) total += this.player.equipment.armor.defense;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.defense;
                this.buffs.forEach(b => { if (b.stat === 'defense') total += b.value; });
                return Math.max(0, total);
            }

            getDodge() {
                let total = this.player.baseDodge;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.dodge;
                if (this.player.equipment.armor) total += this.player.equipment.armor.dodge;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.dodge;
                this.buffs.forEach(b => { if (b.stat === 'dodge') total += b.value; });
                return Math.min(50, Math.max(0, total));
            }

            getCrit() {
                let total = this.player.baseCrit;
                if (this.player.equipment.weapon) total += this.player.equipment.weapon.crit;
                if (this.player.equipment.armor) total += this.player.equipment.armor.crit;
                if (this.player.equipment.accessory) total += this.player.equipment.accessory.crit;
                this.buffs.forEach(b => { if (b.stat === 'crit') total += b.value; });
                return Math.min(60, Math.max(0, total));
            }

            getMaxHp() {
                let total = this.player.maxHp;
                if (this.player.equipment.weapon && this.player.equipment.weapon.hp) total += this.player.equipment.weapon.hp;
                if (this.player.equipment.armor && this.player.equipment.armor.hp) total += this.player.equipment.armor.hp;
                if (this.player.equipment.accessory && this.player.equipment.accessory.hp) total += this.player.equipment.accessory.hp;
                return total;
            }

            getFleeChance() {
                return Math.min(60, 25 + Math.floor(this.getDodge() * 0.6));
            }

            getGoldMultiplier() {
                return 1 + (this.getSoulBonuses().fortune / 100);
            }

            getSoulMultiplier() {
                return 1 + (this.getSoulBonuses().soulHarvest / 100);
            }

            getPotionMultiplier() {
                return 1 + (this.getSoulBonuses().potionMaster / 100);
            }

            // ==================== GAME FLOW ====================

            nextLevel() {
                if (this.level > 500) {
                    this.victory();
                    return;
                }

                this.buffs = this.buffs.filter(b => {
                    b.duration--;
                    return b.duration > 0;
                });

                this.lastBattleLog = null;
                this.isMimicFight = false;

                if (this.isNewArea() && this.level > 1) {
                    this.showAreaTransition();
                    return;
                }

                this.checkStoryDialogue();
                this.generateEvent();
                this.updateUI();
            }

            checkStoryDialogue() {
                const area = this.getAreaNumber();
                const dialogueKey = `area${area}`;
                
                if (STORY_DIALOGUES[dialogueKey] && !this.storyShown[dialogueKey] && 
                    this.level === AREAS[area - 1].startFloor) {
                    this.storyShown[dialogueKey] = true;
                }
            }

            generateEvent() {
                const panel = document.getElementById('event-panel');
                
                // Safety check
                if (!panel) {
                    console.error('Event panel not found!');
                    return;
                }
                
                if (this.level === 1 && !this.combatHeightSet) {
                    this.currentEvent = 'fight';
                    this.generateMonster();
                    return;
                }

                if (this.isAreaBossFloor()) {
                    this.currentEvent = 'fight';
                    this.generateBoss();
                    return;
                }

                const areaNum = this.getAreaNumber();
                const bossFloor = areaNum * 50;
                if (this.level === bossFloor - 3) {
                    this.currentEvent = 'merchant';
                    this.generateMerchant();
                    return;
                }

                if (this.level % 10 === 0 && !this.isAreaBossFloor()) {
                    this.currentEvent = 'rest';
                    this.generateRestArea();
                    return;
                }

                const roll = Math.random() * 100;
                let cumulative = 0;
                for (const [event, data] of Object.entries(EVENTS)) {
                    cumulative += data.weight;
                    if (roll < cumulative) {
                        this.currentEvent = event;
                        break;
                    }
                }

                switch (this.currentEvent) {
                    case 'fight': this.generateMonster(); break;
                    case 'treasure': this.generateTreasureChoice(); break;
                    case 'merchant': this.generateMerchant(); break;
                    case 'event': this.generateRandomEvent(); break;
                    case 'rest': this.generateRestArea(); break;
                }
                
                this.saveGame();
            }

            // ==================== REST AREA ====================

            generateRestArea() {
                const panel = document.getElementById('event-panel');
                const healAmount = Math.floor(this.getMaxHp() * 0.25);
                
                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">ğŸ•ï¸</div>
                        <div><div class="event-title">å®‰å…¨å€åŸŸ</div></div>
                    </div>
                    <div class="event-content">
                        <div class="event-description">
                            ä½ æ‰¾åˆ°äº†ä¸€å€‹æš«æ™‚å®‰å…¨çš„åœ°æ–¹ï¼Œå¯ä»¥ç¨ä½œä¼‘æ¯ã€‚é€™è£¡æœ‰ä¸€å€‹å°ç‡Ÿç«å’Œä¸€äº›è£œçµ¦å“ã€‚
                        </div>
                        <div class="treasure-display">
                            <div class="treasure-icon">ğŸ”¥</div>
                            <p style="color: #4ecdc4">åœ¨æ­¤ä¼‘æ¯å¯æ¢å¾© ${healAmount} é»ç”Ÿå‘½</p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="game.restHeal()">ä¼‘æ¯æ¢å¾©</button>
                        <button class="btn btn-primary" onclick="game.level++; game.nextLevel()">ç›´æ¥é›¢é–‹</button>
                    </div>
                `;
            }

            restHeal() {
                const healAmount = Math.floor(this.getMaxHp() * 0.25);
                this.player.hp = Math.min(this.player.hp + healAmount, this.getMaxHp());
                this.updateUI();
                this.level++;
                this.nextLevel();
            }

            // ==================== MONSTER SYSTEM ====================

            generateMonster() {
                this.inCombat = true;
                const areaNum = this.getAreaNumber();
                const monsterPool = MONSTERS_BY_AREA[areaNum] || MONSTERS_BY_AREA[1];
                const base = monsterPool[Math.floor(Math.random() * monsterPool.length)];

                const floorInArea = ((this.level - 1) % 50) + 1;
                const difficultyTier = Math.floor((floorInArea - 1) / 10);
                const buffPerTier = 0.125; 
                const scaling = 1 + (difficultyTier * buffPerTier);
                const HPscaling = 1 + (difficultyTier * (buffPerTier/2));

                const eliteChance = Math.min(0.18, 0.08 + (difficultyTier * 0.025));
                const isElite = Math.random() < eliteChance;
                const eliteMultiplier = isElite ? 1.5 : 1;

                this.currentMonster = {
                    ...base,
                    type: isElite ? 'elite' : 'normal',
                    hp: Math.floor(base.baseHp * HPscaling * eliteMultiplier),
                    maxHp: Math.floor(base.baseHp * HPscaling * eliteMultiplier),
                    attack: Math.floor(base.baseAtk * scaling * eliteMultiplier),
                    defense: Math.floor(base.baseDef * scaling * eliteMultiplier),
                    gold: Math.floor((base.goldMin + Math.random() * (base.goldMax - base.goldMin)) * scaling * this.getGoldMultiplier() * (isElite ? 1.5 : 1)),
                    dropChance: isElite ? 0.25 : 0.06,
                    matChance: base.matChance * (isElite ? 1.3 : 1),
                    soulReward: isElite ? 3 : 0
                };

                this.renderCombat();
            }

            generateMimic() {
                this.inCombat = true;
                this.isMimicFight = true;
                const areaNum = this.getAreaNumber();
                const mimicData = CHEST_MIMICS[areaNum];
                const monsterPool = MONSTERS_BY_AREA[areaNum] || MONSTERS_BY_AREA[1];
                
                // Base stats on area's strongest monster
                const baseMonster = monsterPool[monsterPool.length - 1];
                const floorInArea = ((this.level - 1) % 50) + 1;
                const scaling = 1 + (floorInArea - 1) * 0.02;

                this.currentMonster = {
                    name: mimicData.name,
                    emoji: mimicData.emoji,
                    type: 'elite',
                    hp: Math.floor(baseMonster.baseHp * scaling * mimicData.hpMult),
                    maxHp: Math.floor(baseMonster.baseHp * scaling * mimicData.hpMult),
                    attack: Math.floor(baseMonster.baseAtk * scaling * mimicData.atkMult),
                    defense: Math.floor(baseMonster.baseDef * scaling * mimicData.defMult),
                    gold: Math.floor((baseMonster.goldMax * 2) * scaling * this.getGoldMultiplier()),
                    dropChance: 0.6, // Higher drop chance for mimic
                    matChance: 0.7,
                    material: monsterPool[0].material,
                    soulReward: Math.floor(5 + areaNum)
                };

                // Store better loot for mimic
                this.mimicLootBonus = true;

                this.renderCombat();
            }

            generateBoss() {
                this.inCombat = true;
                const areaNum = this.getAreaNumber();
                const boss = AREA_BOSSES[areaNum];

                if (!boss) {
                    this.generateMonster();
                    return;
                }

                this.currentMonster = {
                    ...boss,
                    type: 'boss',
                    hp: boss.baseHp,
                    maxHp: boss.baseHp,
                    attack: boss.baseAtk,
                    defense: boss.baseDef,
                    gold: Math.floor((boss.goldMin + Math.random() * (boss.goldMax - boss.goldMin)) * this.getGoldMultiplier()),
                    dropChance: 0.85,
                    matChance: 1.0,
                    material: boss.material, 
                    soulReward: Math.floor(boss.soulReward * this.getSoulMultiplier())
                };

                this.renderCombat();
            }

            // ==================== COMBAT SYSTEM ====================

            performAttack() {
                if (!this.inCombat || !this.currentMonster || this.isActionLocked) return;
                
                // Lock actions
                this.isActionLocked = true;

                this.lastBattleLog = {
                    playerDamage: 0,
                    playerCrit: false,
                    monsterDamage: 0,
                    playerDodged: false,
                    potionUsed: null
                };

                const playerAttack = this.getAttack();
                const monsterDefense = this.currentMonster.defense;
                
                const isCrit = Math.random() * 100 < this.getCrit();
                const critMultiplier = isCrit ? 1.75 : 1;
                const baseDamage = Math.max(1, playerAttack - monsterDefense);
                const playerDamage = Math.floor(baseDamage * critMultiplier);
                
                this.currentMonster.hp -= playerDamage;
                this.lastBattleLog.playerDamage = playerDamage;
                this.lastBattleLog.playerCrit = isCrit;

                setTimeout(() => {
                    const monsterSprite = document.querySelector('.combatant.monster .combatant-sprite');
                    if (monsterSprite) monsterSprite.classList.add('attack-animation');
                    setTimeout(() => {
                        if (monsterSprite) monsterSprite.classList.remove('attack-animation');
                    }, 300);
                }, 100);

                if (this.currentMonster.hp <= 0) {
                    this.currentMonster.hp = 0;
                    this.renderCombat();
                    setTimeout(() => {
                        this.isActionLocked = false; 
                        this.monsterDefeated();
                    }, 500);
                    return;
                }

                this.monsterAttack();
            }

            monsterAttack() {
                const playerDodge = this.getDodge();
                
                if (Math.random() * 100 < playerDodge) {
                    this.lastBattleLog.playerDodged = true;
                    this.lastBattleLog.monsterDamage = 0;
                } else {
                    const playerDefense = this.getDefense();
                    const monsterAttack = this.currentMonster.attack;
                    
                    const monsterDamage = Math.max(1, monsterAttack - playerDefense);
                    this.player.hp -= monsterDamage;
                    this.lastBattleLog.monsterDamage = monsterDamage;

                    document.querySelector('.hp-section').classList.add('shake');
                    setTimeout(() => document.querySelector('.hp-section').classList.remove('shake'), 500);
                }

                if (this.player.hp <= 0) {
                    const secondChance = this.getSoulBonuses().secondChance;
                    if (secondChance > 0 && Math.random() * 100 < secondChance) {
                        this.player.hp = 1;
                        this.lastBattleLog.secondChance = true;
                    } else {
                        this.player.hp = 0;
                        this.renderCombat();
                        setTimeout(() => {
                            this.isActionLocked = false; 
                            this.gameOver();
                        }, 500);
                        return;
                    }
                }

                this.updateUI();
                this.renderCombat();
                
                setTimeout(() => {
                    this.isActionLocked = false;
                }, 400);
            }

            monsterDefeated() {
                this.inCombat = false;
                const monster = this.currentMonster;
                
                // Better loot for mimic
                const rarityBoost = this.mimicLootBonus ? 0.35 : (monster.type === 'boss' ? 0.4 : (monster.type === 'elite' ? 0.2 : 0));
                
                this.pendingLoot = {
                    gold: monster.gold,
                    material: null,
                    equipment: null,
                    souls: monster.soulReward || 0,
                    potion: null
                };

                if (Math.random() < monster.matChance && monster.material && MATERIALS[monster.material]) {
                    this.pendingLoot.material = {
                        key: monster.material,
                        ...MATERIALS[monster.material]
                    };
                }

                if (Math.random() < monster.dropChance) {
                    this.pendingLoot.equipment = this.generateEquipmentDrop(rarityBoost);
                }

                const potionChance = monster.type === 'boss' ? 0.9 : (monster.type === 'elite' ? 0.35 : 0.15);
                if (Math.random() < potionChance) {
                    const areaNum = this.getAreaNumber();
                    const potionRoll = Math.random();
                    if (areaNum >= 8 && potionRoll < 0.1) this.pendingLoot.potion = 'full';
                    else if (areaNum >= 5 && potionRoll < 0.3) this.pendingLoot.potion = 'large';
                    else if (areaNum >= 3 && potionRoll < 0.5) this.pendingLoot.potion = 'medium';
                    else this.pendingLoot.potion = 'small';
                }

                if (this.pendingLoot.souls > 0) {
                    this.soulGainedThisRun += this.pendingLoot.souls;
                }

                if (this.level > this.soulData.bestFloor) {
                    this.soulData.bestFloor = this.level;
                }
                if (monster.type === 'boss') {
                    this.soulData.bossesKilled++;
                }
                saveSoulData(this.soulData);

                this.mimicLootBonus = false;

                if (this.level === 500 && monster.type === 'boss') {
                    this.renderFinalVictory();
                } else {
                    this.renderVictory();
                }
            }

            collectLoot() {
                if (!this.pendingLoot) return;

                this.player.gold += this.pendingLoot.gold;
                
                if (this.pendingLoot.material) {
                    const matKey = this.pendingLoot.material.key;
                    this.player.materials[matKey] = (this.player.materials[matKey] || 0) + 1;
                }

                if (this.pendingLoot.equipment && this.player.bag.length < 20) {
                    this.player.bag.push(this.pendingLoot.equipment);
                }

                if (this.pendingLoot.potion) {
                    this.player.potions[this.pendingLoot.potion]++;
                }

                this.pendingLoot = null;
                this.level++;
                this.updateUI();
                this.nextLevel();
            }

            tryFlee() {
                if (this.isActionLocked) return;
                this.isActionLocked = true;
                
                const fleeChance = this.getFleeChance();
                if (Math.random() * 100 < fleeChance) {
                    this.inCombat = false;
                    this.isMimicFight = false;
                    this.isActionLocked = false; 
                    this.renderFleeSuccess();
                } else {
                    this.lastBattleLog = {
                        playerDamage: 0,
                        playerCrit: false,
                        monsterDamage: 0,
                        playerDodged: false,
                        fleeFailed: true
                    };
                    this.monsterAttack();
                }
            }

            // ==================== POTION SYSTEM ====================

            usePotion(type) {
                if (!this.player.potions[type] || this.player.potions[type] <= 0) return;
                
                const maxHp = this.getMaxHp();
                if (this.player.hp >= maxHp) return;

                const potion = POTION_TYPES[type];
                const healAmount = Math.floor(maxHp * potion.healPercent * this.getPotionMultiplier());
                
                this.player.potions[type]--;
                this.player.hp = Math.min(this.player.hp + healAmount, maxHp);
                

                this.updateUI();
                
                if (this.inCombat) {
                    this.renderCombat();
                }
            }

            // ==================== EQUIPMENT SYSTEM ====================

            generateEquipmentDrop(rarityBoost = 0) {
                const types = ['weapons', 'armor', 'accessories'];
                const type = types[Math.floor(Math.random() * types.length)];
                const pool = EQUIPMENT[type];

                let rarityRoll = (Math.random() * 100) - (rarityBoost * 100);
                let targetRarity;
                
                const areaNum = this.getAreaNumber();
                
                if (areaNum >= 9) {
                    // Areas 9-10 (Endgame): High chance of good gear
                    if (rarityRoll < 1) targetRarity = 'legendary';
                    else if (rarityRoll < 15) targetRarity = 'epic';
                    else if (rarityRoll < 50) targetRarity = 'rare';
                    else targetRarity = 'uncommon';
                } else if (areaNum >= 7) {
                    // Areas 7-8: Legendaries become possible (very rare)
                    if (rarityRoll < 0.5) targetRarity = 'legendary';
                    else if (rarityRoll < 10) targetRarity = 'epic';
                    else if (rarityRoll < 50) targetRarity = 'rare';
                    else targetRarity = 'uncommon';
                } else if (areaNum >= 5) {
                    // Areas 5-6: Epics become possible
                    if (rarityRoll < 5) targetRarity = 'epic';
                    else if (rarityRoll < 30) targetRarity = 'rare';
                    else if (rarityRoll < 40) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                } else if (areaNum >= 3) {
                    // Areas 3-4: Rares become accessible
                    if (rarityRoll < 10) targetRarity = 'rare';
                    else if (rarityRoll < 40) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                } else if (areaNum >= 2) {
                    // Area 2: Mostly Common/Uncommon
                    if (rarityRoll < 20) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                } else {
                    // Area 1: Strictly Common/Uncommon
                    if (rarityRoll < 5) targetRarity = 'uncommon';
                    else targetRarity = 'common';
                }

                // Fallback: If we selected a rarity that doesn't exist in the list (safety check)
                // Filter items by the chosen rarity
                let candidates = pool.filter(item => item.rarity === targetRarity);
                
                // If no items of that rarity exist (shouldn't happen with correct config), fallback to common
                if (candidates.length === 0) {
                    candidates = pool.filter(item => item.rarity === 'common');
                }

                const item = candidates[Math.floor(Math.random() * candidates.length)];

                return { 
                    ...item, 
                    type: type === 'weapons' ? 'weapon' : type === 'armor' ? 'armor' : 'accessory',
                    id: Date.now() + Math.random()
                };
            }

            showEquipCompare(index) {
                this.selectedBagIndex = index;
                const newItem = this.player.bag[index];
                const currentItem = this.player.equipment[newItem.type];

                const container = document.getElementById('equip-compare-container');
                
                const getStatChange = (stat, newVal, oldVal) => {
                    const diff = newVal - oldVal;
                    if (diff > 0) return `<span class="stat-change positive">+${diff}</span>`;
                    if (diff < 0) return `<span class="stat-change negative">${diff}</span>`;
                    return '';
                };

                const currentStats = currentItem ? {
                    attack: currentItem.attack,
                    defense: currentItem.defense,
                    dodge: currentItem.dodge,
                    crit: currentItem.crit,
                    hp: currentItem.hp || 0
                } : { attack: 0, defense: 0, dodge: 0, crit: 0, hp: 0 };

                container.innerHTML = `
                    <div class="equip-card current">
                        <div class="equip-card-label">ç›®å‰è£å‚™</div>
                        <div class="equip-card-name ${currentItem ? currentItem.rarity : ''}" style="color: ${currentItem ? this.getRarityColor(currentItem.rarity) : '#555'}">
                            ${currentItem ? currentItem.name : 'ç„¡'}
                        </div>
                        ${currentItem ? `
                            <div class="equip-card-stats">
                                ${currentStats.attack > 0 ? `<div class="stat-line"><span>âš”ï¸ æ”»æ“Š</span><span>${currentStats.attack}</span></div>` : ''}
                                ${currentStats.defense > 0 ? `<div class="stat-line"><span>ğŸ›¡ï¸ é˜²ç¦¦</span><span>${currentStats.defense}</span></div>` : ''}
                                ${currentStats.dodge > 0 ? `<div class="stat-line"><span>ğŸ’¨ é–ƒé¿</span><span>${currentStats.dodge}%</span></div>` : ''}
                                ${currentStats.crit > 0 ? `<div class="stat-line"><span>ğŸ’¥ çˆ†æ“Š</span><span>${currentStats.crit}%</span></div>` : ''}
                                ${currentStats.hp > 0 ? `<div class="stat-line"><span>â¤ï¸ ç”Ÿå‘½</span><span>${currentStats.hp}</span></div>` : ''}
                            </div>
                        ` : '<div class="equip-card-stats" style="color:#555">ç©º</div>'}
                    </div>
                    <div class="compare-arrow">â¡ï¸</div>
                    <div class="equip-card new ${newItem.rarity}">
                        <div class="equip-card-label">æ–°è£å‚™</div>
                        <div class="equip-card-name" style="color: ${this.getRarityColor(newItem.rarity)}">
                            ${newItem.name}
                        </div>
                        <div class="equip-card-stats">
                            ${newItem.attack > 0 || currentStats.attack > 0 ? `
                                <div class="stat-line">
                                    <span>âš”ï¸ æ”»æ“Š</span>
                                    <span>${newItem.attack} ${getStatChange('attack', newItem.attack, currentStats.attack)}</span>
                                </div>
                            ` : ''}
                            ${newItem.defense > 0 || currentStats.defense > 0 ? `
                                <div class="stat-line">
                                    <span>ğŸ›¡ï¸ é˜²ç¦¦</span>
                                    <span>${newItem.defense} ${getStatChange('defense', newItem.defense, currentStats.defense)}</span>
                                </div>
                            ` : ''}
                            ${newItem.dodge > 0 || currentStats.dodge > 0 ? `
                                <div class="stat-line">
                                    <span>ğŸ’¨ é–ƒé¿</span>
                                    <span>${newItem.dodge}% ${getStatChange('dodge', newItem.dodge, currentStats.dodge)}</span>
                                </div>
                            ` : ''}
                            ${newItem.crit > 0 || currentStats.crit > 0 ? `
                                <div class="stat-line">
                                    <span>ğŸ’¥ çˆ†æ“Š</span>
                                    <span>${newItem.crit}% ${getStatChange('crit', newItem.crit, currentStats.crit)}</span>
                                </div>
                            ` : ''}
                            ${(newItem.hp && newItem.hp > 0) || currentStats.hp > 0 ? `
                                <div class="stat-line">
                                    <span>â¤ï¸ ç”Ÿå‘½</span>
                                    <span>${newItem.hp || 0} ${getStatChange('hp', newItem.hp || 0, currentStats.hp)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                document.getElementById('equip-confirm-btn').onclick = () => {
                    this.equipFromBag(this.selectedBagIndex);
                    this.closeEquipCompare();
                };

                document.getElementById('equip-compare-modal').classList.remove('hidden');
            }

            closeEquipCompare() {
                document.getElementById('equip-compare-modal').classList.add('hidden');
                this.selectedBagIndex = -1;
            }

            equipFromBag(index) {
                if (index < 0 || index >= this.player.bag.length) return;
                
                const newItem = this.player.bag[index];
                const oldItem = this.player.equipment[newItem.type];
                
                const oldMaxHp = this.getMaxHp();
                const oldHp = this.player.hp;
                
                // Calculate HP difference
                const newItemHp = newItem.hp || 0;
                const oldItemHp = oldItem ? (oldItem.hp || 0) : 0;
                const hpDiff = newItemHp - oldItemHp;
                
                // Swap equipment
                this.player.equipment[newItem.type] = newItem;
                this.player.bag.splice(index, 1);
                
                if (oldItem && this.player.bag.length < 20) {
                    this.player.bag.push(oldItem);
                }
                
                // Adjust HP based on difference
                if (hpDiff > 0) {
                    // New item has more HP - add the difference
                    this.player.hp = oldHp + hpDiff;
                } else if (hpDiff < 0) {
                    // New item has less HP - subtract the difference
                    this.player.hp = Math.max(1, oldHp + hpDiff); // hpDiff is negative
                }
                
                // Safety cap: never exceed new max
                const newMaxHp = this.getMaxHp();
                this.player.hp = Math.min(this.player.hp, newMaxHp);
                
                this.updateUI();
                if (this.currentEvent === 'merchant') {
                    this.renderMerchant();
                }
            }

            showUnequipModal(slot) {
                const item = this.player.equipment[slot];
                if (!item) return;
                
                this.selectedUnequipSlot = slot;
                
                const container = document.getElementById('unequip-modal-content');
                
                // Build stats - only show non-zero
                let statsHtml = '';
                if (item.attack > 0) statsHtml += `<div class="stat-line"><span>âš”ï¸ æ”»æ“Š</span><span style="color:#ff6b35">-${item.attack}</span></div>`;
                if (item.defense > 0) statsHtml += `<div class="stat-line"><span>ğŸ›¡ï¸ é˜²ç¦¦</span><span style="color:#4ecdc4">-${item.defense}</span></div>`;
                if (item.dodge > 0) statsHtml += `<div class="stat-line"><span>ğŸ’¨ é–ƒé¿</span><span style="color:#a8e6cf">-${item.dodge}%</span></div>`;
                if (item.crit > 0) statsHtml += `<div class="stat-line"><span>ğŸ’¥ çˆ†æ“Š</span><span style="color:#f39c12">-${item.crit}%</span></div>`;
                if (item.hp && item.hp > 0) statsHtml += `<div class="stat-line"><span>â¤ï¸ ç”Ÿå‘½</span><span style="color:#e94560">-${item.hp}</span></div>`;
                
                const bagFull = this.player.bag.length >= 20;
                
                container.innerHTML = `
                    <div class="equip-card new ${item.rarity}" style="margin: 15px auto; max-width: 200px;">
                        <div class="equip-card-label">${SLOT_NAMES[slot]}</div>
                        <div class="equip-card-name" style="color: ${this.getRarityColor(item.rarity)}">
                            ${item.name}
                        </div>
                        <div class="equip-card-stats">
                            ${statsHtml}
                        </div>
                    </div>
                    ${bagFull ? `
                        <div style="color: #e94560; text-align: center; font-size: 0.85rem; margin-top: 10px;">
                            âš ï¸ èƒŒåŒ…å·²æ»¿ï¼Œç„¡æ³•å¸ä¸‹è£å‚™ï¼
                        </div>
                    ` : `
                        <div style="color: #aaa; text-align: center; font-size: 0.8rem; margin-top: 10px;">
                            å¸ä¸‹å¾Œå°‡ç§»è‡³èƒŒåŒ…
                        </div>
                    `}
                `;
                
                const confirmBtn = document.getElementById('unequip-confirm-btn');
                if (bagFull) {
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                } else {
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.onclick = () => {
                        this.unequipItem(this.selectedUnequipSlot);
                        this.closeUnequipModal();
                    };
                }
                
                document.getElementById('unequip-modal').classList.remove('hidden');
            }

            closeUnequipModal() {
                document.getElementById('unequip-modal').classList.add('hidden');
                this.selectedUnequipSlot = null;
            }

            unequipItem(slot) {
                const item = this.player.equipment[slot];
                if (!item) return;
                
                if (this.player.bag.length >= 20) {
                    return;
                }
                
                // Calculate HP from this item BEFORE removing
                const itemHp = item.hp || 0;
                const oldMaxHp = this.getMaxHp();
                const oldHp = this.player.hp;
                
                // Move to bag
                this.player.bag.push(item);
                this.player.equipment[slot] = null;
                
                // Calculate new max HP AFTER removing
                const newMaxHp = this.getMaxHp();
                
                // Adjust current HP
                if (newMaxHp < oldMaxHp && itemHp > 0) {
                    this.player.hp = Math.max(1, oldHp - itemHp);
                }
                
                // Safety cap: never exceed new max
                this.player.hp = Math.min(this.player.hp, newMaxHp);
                
                this.updateUI();
                if (this.currentEvent === 'merchant') {
                    this.renderMerchant();
                }
            }

            // ==================== TREASURE SYSTEM ====================

            generateTreasureChoice() {
                const panel = document.getElementById('event-panel');
                const areaNum = this.getAreaNumber();
                const mimicData = CHEST_MIMICS[areaNum];

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">ğŸ’</div>
                        <div><div class="event-title">ç™¼ç¾å¯¶ç®±ï¼</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                            <div class="treasure-icon">ğŸ“¦</div>
                            <p>ä½ ç™¼ç¾äº†ä¸€å€‹ç¥ç§˜çš„å¯¶ç®±ï¼</p>
                            <p style="color: #aaa; font-size: 0.8rem; margin-top: 8px;">ä½ å¯ä»¥é¸æ“‡å®‰å…¨åœ°æ‰“é–‹ï¼Œæˆ–è€…å˜—è©¦å¼·è¡Œæ’¬é–‹ç²å–æ›´å¤šå¯¶ç‰©...</p>
                        </div>
                        <div class="chest-choice">
                            <div class="chest-option safe" onclick="game.openChestSafe()">
                                <div class="option-icon">ğŸ”“</div>
                                <div class="option-title">å®‰å…¨é–‹å•Ÿ</div>
                                <div class="option-desc">ç²å¾—æ™®é€šå¯¶ç‰©</div>
                            </div>
                            <div class="chest-option risky" onclick="game.openChestRisky()">
                                <div class="option-icon">âš ï¸</div>
                                <div class="option-title">å¼·è¡Œæ’¬é–‹</div>
                                <div class="option-desc">å¯èƒ½æ˜¯ ${mimicData.name}ï¼<br>ä½†æˆ°å‹å¾Œçå‹µæ›´è±åš</div>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="game.skipTreasure()">é›¢é–‹å¯¶ç®±</button>
                    </div>
                `;
            }

            openChestSafe() {
                const goldAmount = Math.floor((20 + this.level * 0.4 + Math.random() * 30) * this.getGoldMultiplier());
                const hasEquipment = Math.random() < 0.30;
                const equipment = hasEquipment ? this.generateEquipmentDrop(0.05) : null;
                
                let potion = null;
                if (Math.random() < 0.40) {
                    const areaNum = this.getAreaNumber();
                    const potionRoll = Math.random();
                    if (areaNum >= 7 && potionRoll < 0.15) potion = 'large';
                    else if (areaNum >= 4 && potionRoll < 0.35) potion = 'medium';
                    else potion = 'small';
                }

                this.pendingLoot = {
                    gold: goldAmount,
                    equipment: equipment,
                    material: null,
                    potion: potion,
                    souls: 0
                };

                this.renderTreasure();
            }

            openChestRisky() {
                if (Math.random() < 0.55) {
                    this.generateMimic();
                } else {
                    const goldAmount = Math.floor((40 + this.level * 0.6 + Math.random() * 50) * this.getGoldMultiplier());
                    const hasEquipment = Math.random() < 0.30;
                    const equipment = hasEquipment ? this.generateEquipmentDrop(0.15) : null;
                    
                    let potion = null;
                    if (Math.random() < 0.60) {
                        const areaNum = this.getAreaNumber();
                        const potionRoll = Math.random();
                        if (areaNum >= 6 && potionRoll < 0.25) potion = 'large';
                        else if (areaNum >= 3 && potionRoll < 0.50) potion = 'medium';
                        else potion = 'small';
                    }

                    const souls = Math.random() < 0.3 ? Math.floor(2 + this.getAreaNumber() * 0.5) : 0;

                    this.pendingLoot = {
                        gold: goldAmount,
                        equipment: equipment,
                        material: null,
                        potion: potion,
                        souls: souls
                    };

                    if (souls > 0) {
                        this.soulGainedThisRun += souls;
                    }

                    this.renderTreasure();
                }
            }

            skipTreasure() {
                this.level++;
                this.nextLevel();
            }

            renderTreasure() {
                const panel = document.getElementById('event-panel');
                const loot = this.pendingLoot;

                let rewardsHtml = `<p style="color: #ffd700; font-size: 1.1rem; margin: 10px 0">ğŸ’° +${loot.gold} é‡‘å¹£</p>`;
                
                if (loot.potion) {
                    const potion = POTION_TYPES[loot.potion];
                    rewardsHtml += `<p style="color: #4ecdc4; font-size: 0.9rem">${potion.emoji} ${potion.name}</p>`;
                }

                if (loot.souls > 0) {
                    rewardsHtml += `<p style="color: #c084fc; font-size: 0.9rem">ğŸ’ ${loot.souls} éˆé­‚ç¢ç‰‡</p>`;
                }

                if (loot.equipment) {
                    rewardsHtml += `
                        <div class="shop-item ${loot.equipment.rarity}" style="margin-top: 10px; cursor: default; max-width: 250px; margin-left: auto; margin-right: auto;">
                            <div class="shop-item-header">
                                <span class="shop-item-name slot-name ${loot.equipment.rarity}">${loot.equipment.name}</span>
                                <span class="shop-item-rarity ${loot.equipment.rarity}">${RARITY_NAMES[loot.equipment.rarity]}</span>
                            </div>
                            <div class="shop-item-description">
                                ${SLOT_NAMES[loot.equipment.type]} | âš”ï¸${loot.equipment.attack} ğŸ›¡ï¸${loot.equipment.defense} ğŸ’¨${loot.equipment.dodge}% ğŸ’¥${loot.equipment.crit}% ${loot.equipment.hp ? `â¤ï¸${loot.equipment.hp}` : ''}
                            </div>
                        </div>
                    `;
                }

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${EVENTS.treasure.icon}</div>
                        <div><div class="event-title">${EVENTS.treasure.title}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                            <div class="treasure-icon">ğŸ“¦</div>
                            <div class="treasure-rewards">
                                <p>å¯¶ç®±æ‰“é–‹äº†ï¼</p>
                                ${rewardsHtml}
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.collectLoot()">æ”¶é›†</button>
                    </div>
                `;
            }

            // ==================== MERCHANT SYSTEM ====================

            generateMerchant() {
                this.merchantItems = [];
                const areaNum = this.getAreaNumber();
                const priceMultiplier = 1 + (areaNum * 0.15); // Increased price scaling

                const potionTypes = ['small', 'medium'];
                if (areaNum >= 4) potionTypes.push('large');
                if (areaNum >= 7) potionTypes.push('full');

                potionTypes.forEach(type => {
                    const potion = POTION_TYPES[type];
                    const healAmount = Math.floor(this.getMaxHp() * potion.healPercent * this.getPotionMultiplier());
                    this.merchantItems.push({
                        shopType: 'potion',
                        potionType: type,
                        name: potion.name,
                        emoji: potion.emoji,
                        description: `æ¢å¾© ${healAmount} é»ç”Ÿå‘½ (${Math.floor(potion.healPercent * 100)}%)`,
                        price: Math.floor(potion.basePrice * priceMultiplier)
                    });
                });

                const equipCount = 2 + Math.floor(Math.random() * 3);
                for (let i = 0; i < equipCount; i++) {
                    const rarityBoost = areaNum > 6 ? 0.25 : (areaNum > 3 ? 0.15 : 0.05);
                    const equip = this.generateEquipmentDrop(rarityBoost);
                    equip.price = this.calculateEquipmentPrice(equip);
                    this.merchantItems.push({
                        shopType: 'equipment',
                        ...equip
                    });
                }

                this.renderMerchant();
            }

            calculateEquipmentPrice(equip) {
                const rarityMultiplier = {
                    common: 1,
                    uncommon: 3,
                    rare: 8,
                    epic: 20,
                    legendary: 50
                };
                const statValue = equip.attack + equip.defense + equip.dodge + equip.crit + (equip.hp || 0) * 0.2;
                const areaNum = this.getAreaNumber();
                return Math.floor((50 + statValue * 4) * rarityMultiplier[equip.rarity]);
            }

            buyItem(index) {
                const item = this.merchantItems[index];
                if (!item || this.player.gold < item.price) return;

                if (item.shopType === 'potion') {
                    this.player.gold -= item.price;
                    this.player.potions[item.potionType]++;
                } else if (item.shopType === 'equipment') {
                    if (this.player.bag.length < 20) {
                        this.player.gold -= item.price;
                        
                        const equipCopy = { 
                            name: item.name,
                            rarity: item.rarity,
                            attack: item.attack,
                            defense: item.defense,
                            dodge: item.dodge,
                            crit: item.crit,
                            hp: item.hp || 0,
                            type: item.type,
                            id: Date.now() + Math.random()
                        };
                        
                        this.player.bag.push(equipCopy);
                    } else {
                        return;
                    }
                }

                this.merchantItems.splice(index, 1);
                this.updateUI();
                this.renderMerchant();
            }

            sellMaterial(matKey) {
                if (!this.player.materials[matKey] || this.player.materials[matKey] <= 0) return;
                
                const mat = MATERIALS[matKey];
                const areaNum = this.getAreaNumber();
                const price = Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier());
                
                this.player.materials[matKey]--;
                if (this.player.materials[matKey] <= 0) {
                    delete this.player.materials[matKey];
                }
                
                this.player.gold += price;
                this.updateUI();
                this.renderMerchant();
            }

            sellAllMaterials() {
                const matKeys = Object.keys(this.player.materials);
                if (matKeys.length === 0) return;

                let totalGold = 0;
                const areaNum = this.getAreaNumber();

                matKeys.forEach(key => {
                    const mat = MATERIALS[key];
                    const count = this.player.materials[key];
                    const price = Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier());
                    totalGold += price * count;
                });

                this.player.materials = {};
                this.player.gold += totalGold;
                this.updateUI();
                this.renderMerchant();
            }

            showSellEquipModal(index) {
                if (index < 0 || index >= this.player.bag.length) return;
                
                const item = this.player.bag[index];
                const price = Math.floor(this.calculateEquipmentPrice(item) * 0.35);
                
                this.selectedSellIndex = index;
                
                const container = document.getElementById('sell-equip-modal-content');
                
                // Build stats - only show non-zero
                let statsHtml = '';
                if (item.attack > 0) statsHtml += `<div class="stat-line"><span>âš”ï¸ æ”»æ“Š</span><span style="color:#ff6b35">${item.attack}</span></div>`;
                if (item.defense > 0) statsHtml += `<div class="stat-line"><span>ğŸ›¡ï¸ é˜²ç¦¦</span><span style="color:#4ecdc4">${item.defense}</span></div>`;
                if (item.dodge > 0) statsHtml += `<div class="stat-line"><span>ğŸ’¨ é–ƒé¿</span><span style="color:#a8e6cf">${item.dodge}%</span></div>`;
                if (item.crit > 0) statsHtml += `<div class="stat-line"><span>ğŸ’¥ çˆ†æ“Š</span><span style="color:#f39c12">${item.crit}%</span></div>`;
                if (item.hp && item.hp > 0) statsHtml += `<div class="stat-line"><span>â¤ï¸ ç”Ÿå‘½</span><span style="color:#e94560">${item.hp}</span></div>`;
                
                // Warning for rare+ items
                const isValuable = item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary';
                
                container.innerHTML = `
                    <div class="equip-card new ${item.rarity}" style="margin: 15px auto; max-width: 200px;">
                        <div class="equip-card-label">${SLOT_NAMES[item.type]}</div>
                        <div class="equip-card-name" style="color: ${this.getRarityColor(item.rarity)}">
                            ${item.name}
                        </div>
                        <div class="equip-card-stats">
                            ${statsHtml}
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <div style="font-size: 1.1rem; color: #ffd700; font-weight: bold;">
                            ğŸ’° å”®åƒ¹: ${price} é‡‘å¹£
                        </div>
                        ${isValuable ? `
                            <div style="color: #e94560; font-size: 0.8rem; margin-top: 8px;">
                                âš ï¸ é€™æ˜¯${RARITY_NAMES[item.rarity]}è£å‚™ï¼Œç¢ºå®šè¦è³£æ‰å—ï¼Ÿ
                            </div>
                        ` : `
                            <div style="color: #aaa; font-size: 0.8rem; margin-top: 8px;">
                                æ­¤æ“ä½œç„¡æ³•å¾©åŸ
                            </div>
                        `}
                    </div>
                `;
                
                document.getElementById('sell-equip-confirm-btn').onclick = () => {
                    this.confirmSellEquip();
                };
                
                document.getElementById('sell-equip-modal').classList.remove('hidden');
            }

            closeSellEquipModal() {
                document.getElementById('sell-equip-modal').classList.add('hidden');
                this.selectedSellIndex = -1;
            }

            confirmSellEquip() {
                const index = this.selectedSellIndex;
                if (index < 0 || index >= this.player.bag.length) {
                    this.closeSellEquipModal();
                    return;
                }
                
                const item = this.player.bag[index];
                const price = Math.floor(this.calculateEquipmentPrice(item) * 0.35);
                
                this.player.bag.splice(index, 1);
                this.player.gold += price;
                
                this.closeSellEquipModal();
                this.updateUI();
                
                // Re-render merchant if currently at merchant
                if (this.currentEvent === 'merchant') {
                    this.renderMerchant();
                }
            }

            sellEquipFromBag(index) {
                if (index < 0 || index >= this.player.bag.length) return;
                
                // Show confirmation modal instead of direct sell
                this.showSellEquipModal(index);
            }

            // ==================== RANDOM EVENT SYSTEM ====================

            generateRandomEvent() {
                const areaNum = this.getAreaNumber();
                // Fallback to Area 1 events if something goes wrong
                const pool = AREA_EVENTS[areaNum] || AREA_EVENTS[1];
                
                const event = pool[Math.floor(Math.random() * pool.length)];
                this.currentRandomEvent = event;

                const panel = document.getElementById('event-panel');
                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${event.icon}</div>
                        <div><div class="event-title">${event.name}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="event-description" style="font-size: 1rem; color: #ddd; padding: 10px;">
                            ${event.description}
                        </div>
                        <div style="text-align: center; color: #888; font-size: 0.8rem; margin-top: 10px;">
                            (çµæœæœªçŸ¥ï¼Œå¯èƒ½ç²å¾—çå‹µæˆ–æ‡²ç½°)
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="game.resolveRandomEvent()">ğŸ¤” æ¢ç´¢ (è³­é‹æ°£)</button>
                        <button class="btn btn-secondary" onclick="game.skipRandomEvent()">ğŸƒ ç›´æ¥é›¢é–‹</button>
                    </div>
                `;
            }

            resolveRandomEvent() {
                // Call the resolve function defined in the event object
                const result = this.currentRandomEvent.resolve(this);
                
                const panel = document.getElementById('event-panel');
                
                // Determine color based on result type
                let color = '#ffd700'; // Default
                if (result.type === 'positive') color = '#4ecdc4'; // Green/Teal
                if (result.type === 'negative') color = '#e94560'; // Red

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${this.currentRandomEvent.icon}</div>
                        <div><div class="event-title">${this.currentRandomEvent.name}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                             <!-- Result Animation Icon -->
                            <div class="treasure-icon" style="font-size: 3rem; margin-bottom: 15px">
                                ${result.type === 'positive' ? 'âœ¨' : 'ğŸ’¢'}
                            </div>
                            <p style="font-size: 1.1rem; color: ${color}; font-weight: bold; line-height: 1.6;">
                                ${result.text}
                            </p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.level++; game.nextLevel()">ç¹¼çºŒå†’éšª</button>
                    </div>
                `;

                if (this.player.hp <= 0) {
                    // Slight delay to read text before game over
                    setTimeout(() => this.gameOver(), 1500);
                } else {
                    this.updateUI();
                }
            }

            skipRandomEvent() {
                this.level++;
                this.nextLevel();
            }

            // ==================== BUFF SYSTEM ====================

            addBuff(name, duration, stat, value, type) {
                this.buffs = this.buffs.filter(b => b.name !== name);
                this.buffs.push({ name, duration, stat, value, type });
                this.updateUI();
            }

            // ==================== RENDER METHODS ====================

            renderCombat() {
                const panel = document.getElementById('event-panel');
                const monster = this.currentMonster;
                const typeText = monster.type === 'elite' ? 'â­ ç²¾è‹±' : monster.type === 'boss' ? 'ğŸ‘‘ é¦–é ˜' : '';
                const fleeChance = this.getFleeChance();

                if (!this.lastBattleLog) {
                    this.lastBattleLog = { initialEncounter: true };
                }

                let battleLogEntries = [];

                if (this.lastBattleLog.initialEncounter) {
                    battleLogEntries.push(`
                        <div class="battle-log-entry" style="font-size:1rem; color:#ffd700; font-weight:bold;">
                            é­é‡ ${monster.emoji} ${monster.name}${typeText ? 'ï¼ˆ' + typeText + 'ï¼‰' : ''}
                        </div>
                    `);
                } else {
                    if (this.lastBattleLog.playerDamage > 0) {
                        if (this.lastBattleLog.playerCrit) {
                            battleLogEntries.push(`<div class="battle-log-entry player-crit">çˆ†æ“Šï¼é€ æˆ <span class="damage-number">${this.lastBattleLog.playerDamage}</span> å‚·å®³</div>`);
                        } else {
                            battleLogEntries.push(`<div class="battle-log-entry player-attack">é€ æˆ <span class="damage-number">${this.lastBattleLog.playerDamage}</span> å‚·å®³</div>`);
                        }
                    }

                    if (this.lastBattleLog.playerDodged) {
                        battleLogEntries.push(`<div class="battle-log-entry dodge">é–ƒé¿äº†æ”»æ“Šï¼</div>`);
                    } else if (this.lastBattleLog.monsterDamage > 0) {
                        battleLogEntries.push(`<div class="battle-log-entry monster-attack">${monster.name} é€ æˆ <span class="damage-number">${this.lastBattleLog.monsterDamage}</span> å‚·å®³</div>`);
                    }

                    if (this.lastBattleLog.fleeFailed) {
                        battleLogEntries.push(`<div class="battle-log-entry" style="color:#888;">é€ƒè·‘å¤±æ•—ï¼</div>`);
                    }

                    if (this.lastBattleLog.secondChance) {
                        battleLogEntries.push(`<div class="battle-log-entry heal">ä¸æ­»æ±ºå¿ƒï¼å‹‰å¼·å­˜æ´»</div>`);
                    }

                    // åªä¿ç•™æœ€å¾Œå…©ç­†
                    battleLogEntries = battleLogEntries.slice(-2);
                }

                // å»ºç«‹å›ºå®šé«˜åº¦çš„ log å®¹å™¨
                const battleLogHtml = `
                    <div class="battle-log">
                        <div class="battle-log-content ${battleLogEntries.length === 1 ? 'single-line' : ''}">
                            ${battleLogEntries.join('')}
                        </div>
                    </div>
                `;

                let bossDialogue = '';
                if (monster.type === 'boss' && this.lastBattleLog.initialEncounter) {
                    const bossDialogues = {
                        1: 'ã€Œå“¼ï¼Œä½ ç«Ÿæ•¢é—–å…¥æˆ‘çš„é ˜åœ°ï¼ã€',
                        2: 'ã€Œé€™è£¡å°‡æ˜¯ä½ çš„è‘¬èº«ä¹‹åœ°ï¼ã€',
                        3: 'ã€Œæ´»äººï¼Ÿåœ¨æˆ‘çš„å¢“åœ°ï¼Ÿå—æ­»å§ï¼ã€',
                        4: 'ã€Œæ£®æ—çš„æ€’ç«å°‡åå™¬ä½ ï¼ã€',
                        5: 'ã€Œæˆç‚ºæˆ‘æ–°å¯¦é©—çš„ææ–™å§ï¼ã€',
                        6: 'ã€Œæ¸ºå°çš„äººé¡ï¼Œè·ªä¸‹ï¼ã€',
                        7: 'ã€Œè®“å¯’å†°å‡çµä½ çš„éˆé­‚ï¼ã€',
                        8: 'ã€Œåœ¨çƒˆç„°ä¸­åŒ–ç‚ºç°ç‡¼å§ï¼ã€',
                        9: 'ã€Œè™›ç©ºå°‡åå™¬ä¸€åˆ‡ï¼ã€',
                        10: 'ã€Œå…¬ä¸»æ˜¯æˆ‘çš„ï¼ä½ å»æ­»å§ï¼ã€'
                    };
                    const areaNum = this.getAreaNumber();
                    if (bossDialogues[areaNum]) {
                        bossDialogue = `
                            <div class="dialog-box" style="margin-bottom: 10px;">
                                <div class="dialog-speaker">${monster.name}</div>
                                <div class="dialog-text">${bossDialogues[areaNum]}</div>
                            </div>`;
                    }
                }

                let mimicDialogue = '';
                if (this.isMimicFight && this.lastBattleLog.initialEncounter) {
                    mimicDialogue = `
                        <div class="dialog-box" style="margin-bottom: 10px; border-left-color: #e94560;">
                            <div class="dialog-speaker" style="color: #e94560;">${monster.name}</div>
                            <div class="dialog-text">ã€Œå˜¿å˜¿å˜¿...åˆæœ‰äººä¸Šç•¶äº†ï¼ã€</div>
                        </div>`;
                }

                const eventTitle = this.isMimicFight ? 'âš ï¸ å¯¶ç®±æ€ªï¼' : (monster.type === 'boss' ? 'âš ï¸ é¦–é ˜æˆ°ï¼' : 'é­é‡æ€ªç‰©ï¼');

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">${monster.type === 'boss' ? 'ğŸ‘‘' : (this.isMimicFight ? 'ğŸ“¦' : 'âš”ï¸')}</div>
                        <div><div class="event-title">${eventTitle}</div></div>
                    </div>
                    <div class="event-content">
                        ${bossDialogue}
                        ${mimicDialogue}
                        <div class="battle-arena" style="justify-content: center;">
                            <div class="combatant monster" style="max-width: 80%;">
                                <div class="combatant-sprite" style="font-size: 4rem;">${monster.emoji}</div>
                                <div class="combatant-name ${monster.type}" style="font-size: 1.1rem;">
                                    ${typeText} ${monster.name}
                                </div>
                                <div class="combatant-hp-bar" style="height: 16px; margin-top: 5px;">
                                    <div class="combatant-hp-fill" style="width: ${Math.max(0, (monster.hp / monster.maxHp) * 100)}%"></div>
                                </div>
                                <div class="combatant-hp-text" style="font-size: 0.9rem;">${Math.max(0, monster.hp)} / ${monster.maxHp}</div>
                                <div class="combatant-stats" style="font-size: 0.8rem;">âš”ï¸${monster.attack} ğŸ›¡ï¸${monster.defense}</div>
                            </div>
                        </div>
                        ${battleLogHtml}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.performAttack()" ${monster.hp <= 0 ? 'disabled' : ''}>âš”ï¸ æ”»æ“Š</button>
                        ${monster.type !== 'boss' ? `
                            <button class="btn btn-danger" onclick="game.tryFlee()" ${monster.hp <= 0 ? 'disabled' : ''}>
                                ğŸƒ é€ƒè·‘
                                <span class="flee-info">(${fleeChance}%)</span>
                            </button>
                        ` : ''}
                    </div>
                `;
                requestAnimationFrame(() => {
                    this.updateCombatReferenceHeight();
                });
            }

            renderVictory() {
                const panel = document.getElementById('event-panel');
                const loot = this.pendingLoot;
                const monster = this.currentMonster;
                
                let lootHtml = '';
                if (loot) {
                    lootHtml = `<div class="loot-display">
                        <div class="loot-title">ğŸ æˆ°åˆ©å“</div>
                        <div class="loot-items">
                            <div class="loot-item"><span style="color:#ffd700">ğŸ’° ${loot.gold}</span></div>
                            ${loot.material && loot.material.name ? `
                                <div class="loot-item" style="border-left: 2px solid ${this.getRarityColor(loot.material.rarity || 'common')}">
                                    <span style="color: ${this.getRarityColor(loot.material.rarity || 'common')}">${loot.material.emoji} ${loot.material.name}</span>
                                    ${loot.material.rarity && loot.material.rarity !== 'common' ? `<span class="shop-item-rarity ${loot.material.rarity}">${RARITY_NAMES[loot.material.rarity]}</span>` : ''}
                                </div>
                            ` : ''}
                            ${loot.equipment ? `<div class="loot-item" style="border-left: 2px solid ${this.getRarityColor(loot.equipment.rarity)}"><span class="slot-name ${loot.equipment.rarity}">${loot.equipment.name}</span><span class="shop-item-rarity ${loot.equipment.rarity}">${RARITY_NAMES[loot.equipment.rarity]}</span></div>` : ''}
                            ${loot.potion ? `<div class="loot-item"><span>${POTION_TYPES[loot.potion].emoji} ${POTION_TYPES[loot.potion].name}</span></div>` : ''}
                            ${loot.souls > 0 ? `<div class="loot-item"><span style="color:#c084fc">ğŸ’ ${loot.souls} éˆé­‚ç¢ç‰‡</span></div>` : ''}
                        </div>
                    </div>`;
                }

                const victoryTitle = this.isMimicFight ? 'å¯¶ç®±æ€ªè¢«æ“Šæ•—ï¼' : 'å‹åˆ©ï¼';

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">ğŸ†</div>
                        <div><div class="event-title">${victoryTitle}</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display" style="padding: 10px">
                            <div class="treasure-icon" style="font-size: 2.5rem">${monster.emoji}</div>
                            <p>æ“Šæ•—äº† ${monster.name}ï¼</p>
                        </div>
                        ${lootHtml}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.collectLoot()">æ”¶é›†æˆ°åˆ©å“</button>
                    </div>
                `;
            }

            renderFinalVictory() {
                const panel = document.getElementById('event-panel');
                const loot = this.pendingLoot;
                const dialogue = STORY_DIALOGUES.bossDefeat;

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">ğŸ‰</div>
                        <div><div class="event-title">é­”ç‹è¢«æ‰“æ•—äº†ï¼</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display" style="padding: 10px">
                            <div class="princess-sprite">ğŸ‘¸</div>
                            <p style="color: #ffd700; font-size: 1.1rem; margin-top: 10px;">å…¬ä¸»å¾—æ•‘äº†ï¼</p>
                        </div>
                        <div class="dialog-box">
                            <div class="dialog-speaker">${dialogue.speaker}</div>
                            <div class="dialog-text">${dialogue.text}</div>
                        </div>
                        <div class="loot-display">
                            <div class="loot-title">ğŸ æˆ°åˆ©å“</div>
                            <div class="loot-items">
                                <div class="loot-item"><span style="color:#ffd700">ğŸ’° ${loot.gold}</span></div>
                                ${loot.souls > 0 ? `<div class="loot-item"><span style="color:#c084fc">ğŸ’ ${loot.souls} éˆé­‚ç¢ç‰‡</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.collectLoot()">å¸¶å…¬ä¸»å›å®¶</button>
                    </div>
                `;
            }

            renderFleeSuccess() {
                const panel = document.getElementById('event-panel');
                const fleeMessage = this.isMimicFight ? 
                    'ä½ æˆåŠŸé€ƒé›¢äº†å¯¶ç®±æ€ªçš„è¿½æ“Šï¼' : 
                    'ä½ æˆåŠŸæ“ºè„«äº†æ€ªç‰©çš„è¿½æ“Šï¼';

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">ğŸƒ</div>
                        <div><div class="event-title">é€ƒè„«æˆåŠŸ</div></div>
                    </div>
                    <div class="event-content">
                        <div class="treasure-display">
                            <div class="treasure-icon">ğŸ’¨</div>
                            <p style="color: #a8e6cf; font-size: 1.1rem; margin-top: 10px;">${fleeMessage}</p>
                            <p style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">é›–ç„¶æœ‰äº›ç‹¼ç‹½ï¼Œä½†è‡³å°‘ä¿ä½äº†æ€§å‘½ã€‚</p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="game.level++; game.nextLevel()">ç¹¼çºŒå‰é€²</button>
                    </div>
                `;
            }

            renderMerchant() {
                const panel = document.getElementById('event-panel');
                const areaNum = this.getAreaNumber();
                
                // Separate potions and equipment
                const potionItems = this.merchantItems.filter(item => item.shopType === 'potion');
                const equipItems = this.merchantItems.filter(item => item.shopType === 'equipment');
                
                // Potions - 2 column grid
                let potionsHtml = '';
                if (potionItems.length > 0) {
                    potionsHtml = `
                        <div style="margin-bottom: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
                                ${potionItems.map((item, index) => {
                                    const actualIndex = this.merchantItems.indexOf(item);
                                    return `
                                        <div class="shop-item potion-item ${this.player.gold >= item.price ? '' : 'disabled'}" 
                                            onclick="game.buyItem(${actualIndex})" style="padding: 8px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: #4ecdc4; font-weight: bold;">${item.emoji} ${item.name}</span>
                                                <span style="color: #ffd700; font-size: 0.8rem;">ğŸ’°${item.price}</span>
                                            </div>
                                            <div style="font-size: 0.65rem; color: #aaa; margin-top: 2px;">${item.description}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Equipment for sale - 2x2 grid, compact cards
                let equipHtml = '';
                if (equipItems.length > 0) {
                    equipHtml = `
                        <div style="margin-bottom: 8px;">
                            <div class="merchant-equip-grid">
                                ${equipItems.map((item, index) => {
                                    const actualIndex = this.merchantItems.indexOf(item);
                                    const canAfford = this.player.gold >= item.price;
                                    
                                    // Build stats array - only show non-zero stats
                                    let statsHtml = '';
                                    if (item.attack > 0) statsHtml += `<span class="stat-tag attack">âš”ï¸${item.attack}</span>`;
                                    if (item.defense > 0) statsHtml += `<span class="stat-tag defense">ğŸ›¡ï¸${item.defense}</span>`;
                                    if (item.dodge > 0) statsHtml += `<span class="stat-tag dodge">ğŸ’¨${item.dodge}%</span>`;
                                    if (item.crit > 0) statsHtml += `<span class="stat-tag crit">ğŸ’¥${item.crit}%</span>`;
                                    if (item.hp && item.hp > 0) statsHtml += `<span class="stat-tag hp">â¤ï¸${item.hp}</span>`;
                                    
                                    return `
                                        <div class="merchant-equip-card ${item.rarity} ${canAfford ? '' : 'disabled'}" 
                                            onclick="game.buyItem(${actualIndex})">
                                            <div class="merchant-equip-title-row">
                                                <div class="merchant-equip-name-group">
                                                    <span class="merchant-equip-name ${item.rarity}">${item.name}</span>
                                                    <span class="merchant-equip-rarity shop-item-rarity ${item.rarity}">${RARITY_NAMES[item.rarity]}</span>
                                                </div>
                                                <span class="merchant-equip-price">ğŸ’°${item.price}</span>
                                            </div>
                                            <div class="merchant-equip-stats">
                                                ${statsHtml}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Materials to sell
                let materialsHtml = '';
                const matKeys = Object.keys(this.player.materials);
                if (matKeys.length > 0) {
                    let totalValue = 0;
                    matKeys.forEach(key => {
                        const mat = MATERIALS[key];
                        if (!mat) return;
                        const count = this.player.materials[key];
                        totalValue += Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier()) * count;
                    });

                    materialsHtml = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1)">
                            <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“¦ å‡ºå”®ç´ æ</span>
                                <button class="sell-all-btn" onclick="game.sellAllMaterials()">å…¨éƒ¨è³£å‡º (ğŸ’°${totalValue})</button>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                ${matKeys.map(key => {
                                    const mat = MATERIALS[key];
                                    if (!mat) return '';
                                    const count = this.player.materials[key];
                                    const price = Math.floor(mat.basePrice * (1 + areaNum * 0.1) * this.getGoldMultiplier());
                                    const rarityColor = this.getRarityColor(mat.rarity || 'common');
                                    return `
                                        <div class="bag-item material" style="border-left: 2px solid ${rarityColor}; background: rgba(139, 69, 19, 0.2);" onclick="game.sellMaterial('${key}')" title="é»æ“Šå‡ºå”®ä¸€å€‹ - ${RARITY_NAMES[mat.rarity] || 'æ™®é€š'}">
                                            <span style="color: ${rarityColor}">${mat.emoji} x${count}</span>
                                            <span style="color: #ffd700; margin-left: 4px;">ğŸ’°${price}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Equipment to sell from bag - 2x2 grid style
                let bagSellHtml = '';
                if (this.player.bag.length > 0) {
                    bagSellHtml = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1)">
                            <div style="font-size: 0.75rem; color: #888; margin-bottom: 6px;">ğŸ’ å‡ºå”®è£å‚™</div>
                            <div class="merchant-equip-grid">
                                ${this.player.bag.map((item, index) => {
                                    const price = Math.floor(this.calculateEquipmentPrice(item) * 0.35);
                                    
                                    // Build stats array - only show non-zero stats
                                    let statsHtml = '';
                                    if (item.attack > 0) statsHtml += `<span class="stat-tag attack">âš”ï¸${item.attack}</span>`;
                                    if (item.defense > 0) statsHtml += `<span class="stat-tag defense">ğŸ›¡ï¸${item.defense}</span>`;
                                    if (item.dodge > 0) statsHtml += `<span class="stat-tag dodge">ğŸ’¨${item.dodge}%</span>`;
                                    if (item.crit > 0) statsHtml += `<span class="stat-tag crit">ğŸ’¥${item.crit}%</span>`;
                                    if (item.hp && item.hp > 0) statsHtml += `<span class="stat-tag hp">â¤ï¸${item.hp}</span>`;
                                    
                                    return `
                                        <div class="merchant-equip-card ${item.rarity}" onclick="game.sellEquipFromBag(${index})">
                                            <div class="merchant-equip-title-row">
                                                <div class="merchant-equip-name-group">
                                                    <span class="merchant-equip-name ${item.rarity}">${item.name}</span>
                                                    <span class="merchant-equip-rarity shop-item-rarity ${item.rarity}">${RARITY_NAMES[item.rarity]}</span>
                                                </div>
                                                <span class="merchant-equip-price sell">ğŸ’°${price}</span>
                                            </div>
                                            <div class="merchant-equip-stats">
                                                ${statsHtml}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                panel.innerHTML = `
                    <div class="event-header">
                        <div class="event-icon">ğŸª</div>
                        <div class="event-title">ç¥ç§˜å•†äºº - ã€Œéœ€è¦äº›ä»€éº¼å—ï¼Ÿã€</div>
                    </div>
                    <div class="event-content">
                        ${potionsHtml}
                        ${equipHtml}
                        ${materialsHtml}
                        ${bagSellHtml}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="game.level++; game.nextLevel()">é›¢é–‹å•†åº—</button>
                    </div>
                `;
            }

            getRarityColor(rarity) {
                const colors = {
                    common: '#888',
                    uncommon: '#4ecdc4',
                    rare: '#667eea',
                    epic: '#a855f7',
                    legendary: '#ffd700'
                };
                return colors[rarity] || '#888';
            }

            // ==================== UI UPDATE ====================
            updateUI() {
                const maxHp = this.getMaxHp();
                const area = this.getCurrentArea();
                const areaNum = this.getAreaNumber();
                const floorInArea = this.getFloorInArea();
                
                // Update header
                document.getElementById('floor-area-icon').textContent = area.icon;
                document.getElementById('floor-area-name').textContent = area.name;
                document.getElementById('current-floor').textContent = floorInArea;
                
                // Stats
                document.getElementById('stat-attack').textContent = this.getAttack();
                document.getElementById('stat-defense').textContent = this.getDefense();
                document.getElementById('stat-dodge').textContent = `${this.getDodge()}%`;
                document.getElementById('stat-crit').textContent = `${this.getCrit()}%`;
                document.getElementById('stat-gold').textContent = this.player.gold;

                // HP Bar
                const hpPercent = Math.max(0, (this.player.hp / maxHp) * 100);
                document.getElementById('hp-bar').style.width = `${hpPercent}%`;
                document.getElementById('hp-bar-text').textContent = `â¤ï¸ ${this.player.hp} / ${maxHp}`;

                // Potions Panel
                const potionsPanel = document.getElementById('potions-panel');
                const potionMult = this.getPotionMultiplier();
                let potionsHtml = '<span class="potions-label">ğŸ’Š è—¥æ°´:</span>';
                let hasPotions = false;
                
                Object.entries(this.player.potions).forEach(([type, count]) => {
                    if (count > 0) {
                        hasPotions = true;
                        const potion = POTION_TYPES[type];
                        const healAmount = Math.floor(maxHp * potion.healPercent * potionMult);
                        potionsHtml += `
                            <div class="potion-slot" onclick="game.usePotion('${type}')" title="ä½¿ç”¨å¾Œæ¢å¾© ${healAmount} é»ç”Ÿå‘½">
                                ${potion.emoji}
                                <span class="potion-name">${potion.name}</span>
                                <span class="potion-heal">+${healAmount}</span>
                                <span class="potion-count">x${count}</span>
                            </div>
                        `;
                    }
                });
                
                if (!hasPotions) {
                    potionsHtml += '<span class="no-potions">ç„¡è—¥æ°´</span>';
                }
                potionsPanel.innerHTML = potionsHtml;

                // Buffs Panel
                const buffsPanel = document.getElementById('buffs-panel');
                const statNames = { attack: 'æ”»', defense: 'é˜²', dodge: 'é–ƒ', crit: 'çˆ†' };
                
                let buffHtml = '';
                const soulBonuses = this.getSoulBonuses();
                const hasSoulBonus = soulBonuses.vitality > 0 || soulBonuses.strength > 0 || 
                                    soulBonuses.resilience > 0 || soulBonuses.agility > 0 || 
                                    soulBonuses.precision > 0;
                if (hasSoulBonus) {
                    buffHtml += `<div class="buff soul">ğŸ’ éˆé­‚å¼·åŒ–</div>`;
                }
                
                buffHtml += this.buffs.map(buff => `
                    <div class="buff ${buff.type}">
                        ${buff.name} ${buff.value > 0 ? '+' : ''}${buff.value}${statNames[buff.stat]} (${buff.duration})
                    </div>
                `).join('');
                
                if (buffHtml === '') {
                    buffHtml = '<div class="no-buffs">ç„¡å¢ç›Šæ•ˆæœ</div>';
                }
                buffsPanel.innerHTML = buffHtml;

                // Equipment Slots (Wearing)
                const equipSlots = document.getElementById('equipment-slots');
                equipSlots.innerHTML = ['weapon', 'armor', 'accessory'].map(slot => {
                    const item = this.player.equipment[slot];
                    if (item) {
                        // Build stats array - only show non-zero stats
                        let statsHtml = '';
                        if (item.attack > 0) statsHtml += `<span>âš”ï¸${item.attack}</span>`;
                        if (item.defense > 0) statsHtml += `<span>ğŸ›¡ï¸${item.defense}</span>`;
                        if (item.dodge > 0) statsHtml += `<span>ğŸ’¨${item.dodge}%</span>`;
                        if (item.crit > 0) statsHtml += `<span>ğŸ’¥${item.crit}%</span>`;
                        if (item.hp && item.hp > 0) statsHtml += `<span>â¤ï¸${item.hp}</span>`;
                        
                        return `
                            <div class="equipment-slot-h ${item.rarity}" onclick="game.showUnequipModal('${slot}')" style="cursor: pointer;">
                                <div class="slot-name ${item.rarity}">${item.name}</div>
                                <div class="slot-stats">
                                    ${statsHtml}
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="equipment-slot-h">
                                <div class="slot-type">${SLOT_NAMES[slot]}</div>
                                <div class="slot-name" style="color: #555">ç©º</div>
                            </div>
                        `;
                    }
                }).join('');

                // Equipment Bag - 3 columns with merchant style
                const equipBagGrid = document.getElementById('equip-bag-grid');
                const bagSection = document.getElementById('section-bag');
                document.getElementById('equip-bag-count').textContent = this.player.bag.length;

                if (this.player.bag.length === 0) {
                    equipBagGrid.innerHTML = '<div class="bag-empty">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>';
                } else {
                    let bagHtml = '';
                    this.player.bag.forEach((item, index) => {
                        // Build stats array - only show non-zero stats
                        let statsHtml = '';
                        if (item.attack > 0) statsHtml += `<span class="stat-tag attack">âš”ï¸${item.attack}</span>`;
                        if (item.defense > 0) statsHtml += `<span class="stat-tag defense">ğŸ›¡ï¸${item.defense}</span>`;
                        if (item.dodge > 0) statsHtml += `<span class="stat-tag dodge">ğŸ’¨${item.dodge}%</span>`;
                        if (item.crit > 0) statsHtml += `<span class="stat-tag crit">ğŸ’¥${item.crit}%</span>`;
                        if (item.hp && item.hp > 0) statsHtml += `<span class="stat-tag hp">â¤ï¸${item.hp}</span>`;
                        
                        bagHtml += `
                            <div class="bag-slot ${item.rarity}" onclick="game.showEquipCompare(${index})">
                                <div class="bag-title-row">
                                    <span class="item-name ${item.rarity}">${item.name}</span>
                                    <span class="item-rarity shop-item-rarity ${item.rarity}">${RARITY_NAMES[item.rarity]}</span>
                                </div>
                                <div class="item-stats">
                                    ${statsHtml}
                                </div>
                            </div>
                        `;
                    });
                    equipBagGrid.innerHTML = bagHtml;
                }

                // Material Bag Items - Dynamic
                const materialBagItems = document.getElementById('material-bag-items');
                const matKeys = Object.keys(this.player.materials);
                
                if (matKeys.length === 0) {
                    materialBagItems.innerHTML = '<span class="empty-materials">å°šç„¡ç´ æ</span>';
                } else {
                    let materialBagHtml = '';
                    matKeys.forEach(key => {
                        const mat = MATERIALS[key];
                        if (!mat) return;
                        const count = this.player.materials[key];
                        const rarityColor = this.getRarityColor(mat.rarity || 'common');
                        const rarityClass = mat.rarity || 'common';
                        
                        materialBagHtml += `
                            <div class="material-item ${rarityClass}">
                                <span style="color: ${rarityColor}">${mat.emoji} ${mat.name}</span>
                                <span class="material-count">x${count}</span>
                            </div>
                        `;
                    });
                    materialBagItems.innerHTML = materialBagHtml;
                }

                this.saveGame();
            }

            // ==================== GAME END ====================

            gameOver() {
                localStorage.removeItem('magicTower_autoSave');
                const floorBonus = Math.floor(this.level * 0.1);
                const totalSouls = Math.floor((this.soulGainedThisRun + floorBonus) * this.getSoulMultiplier());
                
                this.soulData.souls += totalSouls;
                if (this.level > this.soulData.bestFloor) {
                    this.soulData.bestFloor = this.level;
                }
                saveSoulData(this.soulData);

                document.getElementById('modal-title').textContent = 'ğŸ’€ æ—…ç¨‹çµæŸ ğŸ’€';
                document.getElementById('modal-message').textContent = 'ä½ åœ¨é­”å¡”ä¸­å€’ä¸‹äº†...ä½†ä½ çš„éˆé­‚å¾—åˆ°äº†å¼·åŒ–ã€‚';
                document.getElementById('soul-gained').textContent = totalSouls;
                document.getElementById('final-stats').innerHTML = `
                    <div>åˆ°é”å€åŸŸ: <strong style="color: #c084fc">${AREA_NAMES_CN[this.getAreaNumber()]} - ${this.getCurrentArea().name}</strong></div>
                    <div>å€åŸŸå±¤æ•¸: <strong style="color: #ffd700">${this.getFloorInArea()}</strong> / 50</div>
                    <div>ç¸½å±¤æ•¸: <strong>${this.level}</strong> / 500</div>
                    <div>æœ€é«˜ç´€éŒ„: <strong>${this.soulData.bestFloor}</strong></div>
                    <div>æ”¶é›†é‡‘å¹£: <strong>${this.player.gold}</strong></div>
                    <div>æœ€çµ‚æ”»æ“Š: <strong style="color: #ff6b35">${this.getAttack()}</strong></div>
                    <div>æœ€çµ‚é˜²ç¦¦: <strong style="color: #4ecdc4">${this.getDefense()}</strong></div>
                `;
                document.getElementById('game-over-modal').classList.add('active');
            }

            victory() {
                localStorage.removeItem('magicTower_autoSave');
                const victoryBonus = 300;
                const totalSouls = Math.floor((this.soulGainedThisRun + victoryBonus) * this.getSoulMultiplier());
                
                this.soulData.souls += totalSouls;
                this.soulData.bestFloor = 500;
                saveSoulData(this.soulData);

                document.getElementById('modal-title').textContent = 'ğŸ‰ å…¬ä¸»å¾—æ•‘äº†ï¼ ğŸ‰';
                document.getElementById('modal-message').textContent = 'ä½ æˆåŠŸæ“Šæ•—é­”ç‹ï¼Œæ‹¯æ•‘äº†å…¬ä¸»ï¼ç‹åœ‹å°‡æ°¸é è¨˜ä½ä½ çš„è‹±å‹‡äº‹è¹Ÿï¼';
                document.getElementById('soul-gained').textContent = totalSouls;
                document.getElementById('final-stats').innerHTML = `
                    <div style="color: #ffd700; font-size: 1.1rem; margin-bottom: 8px">ğŸ† é€šé—œé­”å¡”ï¼ ğŸ†</div>
                    <div>ğŸ‘¸ æ„›è‰çµ²å…¬ä¸»ç²æ•‘</div>
                    <div>ç¸½å†’éšªæ¬¡æ•¸: <strong>${this.soulData.totalRuns}</strong></div>
                    <div>æ“Šæ•—é¦–é ˜æ•¸: <strong style="color: #e94560">${this.soulData.bossesKilled}</strong></div>
                    <div>æœ€çµ‚æ”»æ“Š: <strong style="color: #ff6b35">${this.getAttack()}</strong></div>
                    <div>æœ€çµ‚é˜²ç¦¦: <strong style="color: #4ecdc4">${this.getDefense()}</strong></div>
                    <div>æœ€çµ‚é–ƒé¿: <strong style="color: #a8e6cf">${this.getDodge()}%</strong></div>
                    <div>æœ€çµ‚çˆ†æ“Š: <strong style="color: #f39c12">${this.getCrit()}%</strong></div>
                `;
                document.getElementById('game-over-modal').classList.add('active');
            }
        }

        // ==================== INITIALIZE GAME ====================
        const game = new Game();
    </script>
</body>
</html>